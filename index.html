

<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç·Šæ€¥åœ°éœ‡é€Ÿå ± EEW Overlay</title>
    <!-- Tailwind CSS (CDN) ã‚’èª­ã¿è¾¼ã¿ã¾ã™ -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* OBSã§ã®èƒŒæ™¯é€éã¨ãƒ•ãƒ«ã‚¹ã‚¯ãƒªãƒ¼ãƒ³è¡¨ç¤ºã‚’ç¢ºå®Ÿã«ã™ã‚‹ãŸã‚ã®ã‚¹ã‚¿ã‚¤ãƒ« */
        body {
            margin: 0;
            padding: 0;
            background-color: transparent !important;
            overflow: hidden;
            font-family: 'Inter', sans-serif;
            width: 100vw;
            height: 100vh;
            position: relative;
        }

        /* ã‚¢ãƒ©ãƒ¼ãƒˆã‚³ãƒ³ãƒ†ãƒŠã®ã‚¹ã‚¿ã‚¤ãƒ« */
        #eew-container {
            position: absolute; 
            top: 20px; 
            left: 50%;
            transform: translateX(-50%);
            width: 90%;
            max-width: 800px;
            pointer-events: none;
            z-index: 1000;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        /* å€‹ã€…ã®ã‚¢ãƒ©ãƒ¼ãƒˆè¦ç´ ã®åŸºæœ¬ã‚¹ã‚¿ã‚¤ãƒ« */
        .eew-alert {
            display: block;
            color: white;
            padding: 20px 30px;
            border-radius: 12px;
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.4);
            border: 4px solid white;
            transition: all 0.3s ease-in-out;
            animation: pulse-border 1s infinite alternate;
            pointer-events: none;
        }

        /* éœ‡åº¦ã«å¿œã˜ã¦èƒŒæ™¯è‰²ã‚’èª¿æ•´ */
        .eew-alert.intensity-3-up {
            background-color: #ff8c00; /* éœ‡åº¦3ä»¥ä¸Š: ã‚ªãƒ¬ãƒ³ã‚¸ */
        }
        .eew-alert.intensity-5-up {
            background-color: #ff4500; /* éœ‡åº¦5å¼±ä»¥ä¸Š: èµ¤ã‚ªãƒ¬ãƒ³ã‚¸ */
        }
        .eew-alert.intensity-6-up {
            background-color: #dc143c; /* éœ‡åº¦6å¼±ä»¥ä¸Š: æ¿ƒã„èµ¤ */
            animation: shake 0.5s infinite; 
        }

        /* ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã‚­ãƒ¼ãƒ•ãƒ¬ãƒ¼ãƒ  */
        @keyframes pulse-border {
            from { border-color: white; box-shadow: 0 0 10px #fff; }
            to { border-color: yellow; box-shadow: 0 0 20px yellow; }
        }

        @keyframes shake {
            0% { transform: translate(1px, 1px); }
            20% { transform: translate(-1px, -2px); }
            40% { transform: translate(-3px, 0px); }
            60% { transform: translate(3px, 2px); }
            80% { transform: translate(-1px, -1px); }
            100% { transform: translate(1px, -2px); }
        }

        /* éœ‡åº¦è¡¨ç¤ºã®ã‚¹ã‚¿ã‚¤ãƒ« */
        .intensity-label {
            font-size: 3rem;
            font-weight: 800;
            line-height: 1;
        }
        .intensity-unit {
            font-size: 1.5rem;
            font-weight: 600;
        }

        /* ãƒœã‚¿ãƒ³ã®ãƒ†ã‚­ã‚¹ãƒˆã‚’ä¸­å¤®æƒãˆã«ã—ã¦æ”¹è¡Œã‚’å¯èƒ½ã«ã™ã‚‹ */
        .test-button-label {
            display: flex;
            flex-direction: column;
            line-height: 1.2;
        }

        /* æŠ˜ã‚ŠãŸãŸã¿ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã®ãƒ™ãƒ¼ã‚¹ã‚¹ã‚¿ã‚¤ãƒ« */
        .collapsible-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease-out, padding 0.3s ease-out;
            padding-top: 0;
            padding-bottom: 0;
            /* Flex gapã‚’ç¶­æŒã™ã‚‹ãŸã‚ã€å­è¦ç´ ã®ãƒãƒ¼ã‚¸ãƒ³ã‚’ãƒªã‚»ãƒƒãƒˆ */
            display: flex;
            flex-direction: column;
            gap: 0.5rem; /* gap-2ã«ç›¸å½“ */
        }

        .collapsible-content.expanded {
            max-height: 1500px; /* URLå…¥åŠ›æ¬„ãŒå¢—ãˆãŸãŸã‚æœ€å¤§å€¤ã‚’å¤§ããã™ã‚‹ */
            padding-top: 0.75rem; /* p-3ã«ç›¸å½“ */
            padding-bottom: 0; /* è¦ªè¦ç´ ã®ãƒ‘ãƒ‡ã‚£ãƒ³ã‚°ã«ä¾å­˜ */
        }
        
        /* çµ±åˆã•ã‚ŒãŸãƒˆã‚°ãƒ«ãƒœã‚¿ãƒ³ã®ã‚¹ã‚¿ã‚¤ãƒ« */
        .toggle-header {
             /* è¦ªã®ãƒ‘ãƒ‡ã‚£ãƒ³ã‚°ã¨ç«¶åˆã—ãªã„ã‚ˆã†ã«ãƒãƒ¼ã‚¸ãƒ³ã¨ãƒ‘ãƒ‡ã‚£ãƒ³ã‚°ã‚’èª¿æ•´ */
             padding-top: 0.5rem;
             padding-bottom: 0.5rem;
             margin-top: -0.5rem; 
             margin-left: -0.75rem; /* padding-left: p-3 (0.75rem)ã®èª¿æ•´ */
             margin-right: -0.75rem; /* padding-right: p-3 (0.75rem)ã®èª¿æ•´ */
             padding-left: 0.75rem;
             padding-right: 0.75rem;
             /* å¢ƒç•Œç·šèª¿æ•´ */
             border-top: 1px solid transparent; /* å†…éƒ¨ã®pb-1/mb-1ã¨åˆã‚ã›ã¦å¢ƒç•Œç·šã‚’è¦‹ã›ãªã„ã‚ˆã†ã«ã™ã‚‹ */
             border-bottom: 1px solid;
             
        }
        
        /* ãƒ­ãƒ¼ãƒ‰ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ç”¨ã®ã‚¯ãƒ©ã‚¹ */
        .loading-status {
            font-size: 0.75rem; /* text-xs */
            font-weight: 600; /* font-semibold */
            padding-left: 0.25rem; /* pl-1 */
        }
        
        /* ãƒ‹ãƒ¥ãƒ¼ã‚¹ãƒ†ãƒ­ãƒƒãƒ— (Ticker) ã‚¹ã‚¿ã‚¤ãƒ« */
        #quake-ticker-area {
            position: fixed;
            bottom: 20px; 
            left: 0;
            width: 100%;
            background-color: rgba(179, 11, 11, 0.95); /* èµ¤ç³»ã®èƒŒæ™¯ */
            color: white;
            overflow: hidden; 
            z-index: 1500;
            display: none; /* Initially hidden, JS will set to flex when needed */
            align-items: center;
            white-space: nowrap;
            padding: 2px 0; 
            
            font-size: 34px; 
            font-weight: 900; 
            line-height: 1.4; /* è¡Œé–“ã‚’èª¿æ•´ */
            
            /* ç™½ã‚¨ãƒƒã‚¸ã‚’ä¸Šã¨ä¸‹ã«è¿½åŠ  */
            box-shadow: 0 0 20px rgba(255, 255, 255, 0.7); /* ç™½ãå…‰ã‚‹ã‚·ãƒ£ãƒ‰ã‚¦ */
            border-top: 4px solid rgb(255, 255, 255); /* å¢ƒç•Œç·šã‚‚å¤ªãã™ã‚‹ */
            border-bottom: 4px solid rgb(255, 255, 255); /* ä¸‹ã«ã‚‚ç™½ã„å¢ƒç•Œç·šã‚’è¿½åŠ  */
            
            /* ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«é–‹å§‹ä½ç½®ã‚’å³ç«¯ã«ã™ã‚‹ãŸã‚ã®ãƒ‘ãƒ‡ã‚£ãƒ³ã‚° */
            padding-left: 100%; 
        }
        
        /* ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã‚’åˆæœŸçŠ¶æ…‹ã§ä¸€æ™‚åœæ­¢ */
        #ticker-content {
            display: inline-block;
            animation-name: ticker-scroll;
            animation-timing-function: linear;
            animation-iteration-count: 1; /* 1å›ã®ã¿å®Ÿè¡Œ */
            animation-fill-mode: forwards; /* çµ‚äº†æ™‚ã®çŠ¶æ…‹ã‚’ç¶­æŒ (ç”»é¢å¤–ã§åœæ­¢) */
            animation-play-state: paused; /* åˆæœŸçŠ¶æ…‹ã¯åœæ­¢ */
            padding-right: 48px; /* ãƒ†ãƒ­ãƒƒãƒ—ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã®å³å´ã«ã‚‚ã‚¹ãƒšãƒ¼ã‚¹ã‚’è¿½åŠ  */
        }

        /* ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã®å®šç¾© */
        @keyframes ticker-scroll {
            /* JSã§è¨­å®šã•ã‚ŒãŸ --scroll-distance åˆ†ã ã‘å·¦ã«ç§»å‹• */
            to { transform: translateX(var(--scroll-distance, -100%)); } 
        }
        
        /* ãƒ­ãƒ¼ãƒ‰å®Œäº†ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ */
        #load-status {
            font-size: 0.9rem;
            font-weight: 600;
            padding: 4px 8px;
            background-color: rgba(17, 94, 89, 0.9); /* teal-700 */
            color: white;
            border-radius: 6px;
        }

        /* å±¥æ­´ãƒªã‚¹ãƒˆã®ã‚¹ã‚¿ã‚¤ãƒ« */
        #history-list {
            max-height: 300px; /* é«˜ã•ãŒ300pxã‚’è¶…ãˆãŸã‚‰ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ« */
            overflow-y: auto;
            padding-right: 8px; /* ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ãƒãƒ¼ã®ãŸã‚ã®ã‚¹ãƒšãƒ¼ã‚¹ */
        }
        .history-item {
            font-size: 0.75rem; /* text-xs */
            padding: 6px;
            border-radius: 4px;
            margin-bottom: 4px;
            border-left: 4px solid;
        }
        .history-item.displayed {
            background-color: rgba(67, 56, 202, 0.3); /* bg-indigo-800/30 */
            border-color: #4ade80; /* green-400 */
        }
        .history-item.skipped {
            background-color: rgba(75, 85, 99, 0.2); /* bg-gray-600/20 */
            border-color: #facc15; /* yellow-400 */
            opacity: 0.7;
        }
    </style>
</head>
<body>
    
    <!-- ç·Šæ€¥åœ°éœ‡é€Ÿå ±ã®ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤è¡¨ç¤ºã‚¨ãƒªã‚¢ -->
    <div id="eew-display-area" class="relative w-full h-full pointer-events-none">
        <!-- ãƒ­ãƒ¼ãƒ‰å®Œäº†ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ç”¨ -->
        <p id="load-status" class="text-white text-center absolute top-2 right-2 z-20 transition-all">æº–å‚™ä¸­...</p>

        <!-- ã‚¢ãƒ©ãƒ¼ãƒˆè¦ç´ ã‚’æ ¼ç´ã™ã‚‹ã‚³ãƒ³ãƒ†ãƒŠ -->
        <div id="eew-container">
        </div>
    </div>
    
    <!-- ğŸš¨ åœ°éœ‡æƒ…å ±ãƒ†ãƒ­ãƒƒãƒ—è¡¨ç¤ºã‚¨ãƒªã‚¢ (ç”»é¢ä¸‹éƒ¨å›ºå®š) ğŸš¨ -->
    <div id="quake-ticker-area">
        <div id="ticker-content"></div>
    </div>
    <!-- åœ°éœ‡æƒ…å ±ãƒ†ãƒ­ãƒƒãƒ—è¡¨ç¤ºã‚¨ãƒªã‚¢ çµ‚äº† -->

    <!-- è¨­å®šãƒˆã‚°ãƒ«ãƒœã‚¿ãƒ³ -->
    <button id="toggle-settings" class="fixed top-1/2 left-0 -translate-y-1/2 bg-gray-900 bg-opacity-70 text-white p-2 rounded-r-lg shadow-xl z-[2001] pointer-events-auto transition hover:bg-gray-700 focus:outline-none">
        è¨­å®š â–¶
    </button>

    <!-- ãƒ†ã‚¹ãƒˆç”¨ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ãƒ‘ãƒãƒ« -->
    <div id="test-controls" class="w-[400px] p-4 pb-24 bg-gray-900 bg-opacity-95 fixed top-0 left-0 bottom-[120px] transform -translate-x-full transition-transform duration-300 z-[2000] overflow-y-auto" style="pointer-events: auto;">
        
        <h2 class="text-white text-xl font-bold mb-4 border-b border-gray-700 pb-2">EEW ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤è¨­å®š<br> (Local Storage)</h2>

        <!-- 1. è¡¨ç¤ºè¨­å®šã‚°ãƒ«ãƒ¼ãƒ— -->
        <div class="flex flex-col p-3 bg-gray-800 rounded-lg mb-4">
            <!-- ãƒ˜ãƒƒãƒ€ãƒ¼ (ã‚¯ãƒªãƒƒã‚¯ã§å±•é–‹/æŠ˜ã‚ŠãŸãŸã¿) -->
            <button id="toggle-display-settings" class="toggle-header flex items-center w-full text-sm font-semibold text-gray-300 border-gray-700 hover:text-white transition">
                <span id="display-settings-icon" class="text-base mr-2 transform transition-transform duration-300">â–¶</span>
                <span>è¡¨ç¤ºãƒ»ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³è¨­å®š</span>
            </button>

            <!-- æŠ˜ã‚ŠãŸãŸã¿å¯èƒ½ãªã‚³ãƒ³ãƒ†ãƒ³ãƒ„ -->
            <div id="display-settings-content" class="collapsible-content">
                <div class="flex items-center justify-between">
                    <!-- ä¿®æ­£ç®‡æ‰€ -->
                    <label for="min-intensity" class="text-white text-sm font-medium whitespace-nowrap">EEWè¡¨ç¤ºæœ€ä½éœ‡åº¦:</label>
                    <select id="min-intensity" class="p-1 rounded text-sm w-28 bg-gray-700 text-white focus:ring-yellow-500 focus:border-yellow-500 text-right">
                        <!-- ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã¯JavaScriptã§è¨­å®š -->
                    </select>
                </div>
                <div class="flex items-center justify-between">
                    <label for="min-intensity-ticker" class="text-white text-sm font-medium whitespace-nowrap">ãƒ­ãƒ¼ãƒ«è¡¨ç¤ºæœ€ä½éœ‡åº¦:</label>
                    <select id="min-intensity-ticker" class="p-1 rounded text-sm w-28 bg-gray-700 text-white focus:ring-yellow-500 focus:border-yellow-500 text-right">
                        <!-- ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã¯JavaScriptã§è¨­å®š -->
                    </select>
                </div>
                <div class="flex items-center justify-between">
                    <label for="eew-duration" class="text-white text-sm font-medium whitespace-nowrap">EEWã‚¢ãƒ©ãƒ¼ãƒˆæ™‚é–“(ç§’):</label>
                    <input type="number" id="eew-duration" min="5" max="300" class="p-1 rounded text-sm w-20 bg-gray-700 text-white focus:ring-yellow-500 focus:border-yellow-500 text-right">
                </div>
                <div class="flex items-center justify-between">
                    <label for="quake-duration" class="text-white text-sm font-medium whitespace-nowrap">æƒ…å ±ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«(ç§’):</label>
                    <input type="number" id="quake-duration" min="10" max="300" class="p-1 rounded text-sm w-20 bg-gray-700 text-white focus:ring-yellow-500 focus:border-yellow-500 text-right">
                </div>
            </div>
        </div>
        
        <!-- 2. ğŸš¨ éœ‡åº¦åˆ¥ã‚¢ãƒ©ãƒ¼ãƒ éŸ³è¨­å®šã‚°ãƒ«ãƒ¼ãƒ— ğŸš¨ -->
        <div class="flex flex-col bg-red-800 rounded-lg mb-4 border border-yellow-500 p-3">
            <!-- ãƒ˜ãƒƒãƒ€ãƒ¼ (ã‚¯ãƒªãƒƒã‚¯ã§å±•é–‹/æŠ˜ã‚ŠãŸãŸã¿) -->
            <button id="toggle-intensity-alarm" class="toggle-header flex items-center w-full text-sm font-semibold text-yellow-300 border-yellow-700 hover:text-white transition">
                <span id="intensity-alarm-icon" class="text-base mr-2 transform transition-transform duration-300">â–¶</span>
                <span>éœ‡åº¦åˆ¥ã‚¢ãƒ©ãƒ¼ãƒ éŸ³è¨­å®š</span>
            </button>
            
            <!-- æŠ˜ã‚ŠãŸãŸã¿å¯èƒ½ãªã‚³ãƒ³ãƒ†ãƒ³ãƒ„ -->
            <div id="intensity-alarm-content" class="collapsible-content">
                <!-- å…±é€šã®ã‚ªãƒ—ã‚·ãƒ§ãƒ³ãƒªã‚¹ãƒˆ -->
                <script>
                    const soundOptions = `
                        <option value="classic_eew">EEWæ¨™æº–éŸ³</option>
                        <option value="urgent_siren">ğŸš¨ ç·Šè¿«ã‚µã‚¤ãƒ¬ãƒ³éŸ³</option>
                        <option value="custom_tone_a">ğŸµ ã‚«ã‚¹ã‚¿ãƒ  A</option>
                        <option value="custom_tone_b">ğŸ¶ ã‚«ã‚¹ã‚¿ãƒ  B</option>
                        <option value="custom_url_a">ğŸ”Š URLéŸ³æº A</option>
                        <option value="custom_url_b">ğŸ”Š URLéŸ³æº B</option>
                        <option value="simple_beep">ãƒ”ãƒ¼ãƒ³éŸ³ (660Hz)</option>
                        <option value="silent">ãƒŸãƒ¥ãƒ¼ãƒˆ</option>
                    `;
                </script>

                <div class="flex items-center justify-between">
                    <label class="text-white text-sm font-medium">éœ‡åº¦4ä»¥ä¸‹ç”¨:</label>
                    <select id="sound-for-int4" class="p-1 rounded text-sm w-36 bg-red-700 text-white focus:ring-yellow-500 focus:border-yellow-500" onload="this.innerHTML = soundOptions">
                        <script>document.write(soundOptions)</script>
                    </select>
                </div>

                <div class="flex items-center justify-between">
                    <label class="text-white text-sm font-medium">éœ‡åº¦5å¼± & 5å¼·ç”¨:</label>
                    <select id="sound-for-int5" class="p-1 rounded text-sm w-36 bg-red-700 text-white focus:ring-yellow-500 focus:border-yellow-500" onload="this.innerHTML = soundOptions">
                        <script>document.write(soundOptions)</script>
                    </select>
                </div>

                <div class="flex items-center justify-between">
                    <label class="text-white text-sm font-medium">éœ‡åº¦6å¼± ã‹ã‚‰ 7ç”¨:</label>
                    <select id="sound-for-int6" class="p-1 rounded text-sm w-36 bg-red-700 text-white focus:ring-yellow-500 focus:border-yellow-500" onload="this.innerHTML = soundOptions">
                        <script>document.write(soundOptions)</script>
                    </select>
                </div>
            </div>
        </div>

        <!-- ğŸŒŠ æ´¥æ³¢é–¢é€£ã‚¢ãƒ©ãƒ¼ãƒ éŸ³è¨­å®šã‚°ãƒ«ãƒ¼ãƒ— ğŸŒŠ -->
        <div class="flex flex-col bg-blue-900 rounded-lg mb-4 border border-blue-400 p-3">
            <!-- ãƒ˜ãƒƒãƒ€ãƒ¼ (ã‚¯ãƒªãƒƒã‚¯ã§å±•é–‹/æŠ˜ã‚ŠãŸãŸã¿) -->
            <button id="toggle-tsunami-alarm" class="toggle-header flex items-center w-full text-sm font-semibold text-blue-300 border-blue-700 hover:text-white transition">
                <span id="tsunami-alarm-icon" class="text-base mr-2 transform transition-transform duration-300">â–¶</span>
                <span>æ´¥æ³¢é–¢é€£ã‚¢ãƒ©ãƒ¼ãƒ éŸ³è¨­å®š</span>
            </button>

            <!-- æŠ˜ã‚ŠãŸãŸã¿å¯èƒ½ãªã‚³ãƒ³ãƒ†ãƒ³ãƒ„ -->
            <div id="tsunami-alarm-content" class="collapsible-content">
                <div class="flex items-center justify-between">
                    <label class="text-white text-sm font-medium">å¤§æ´¥æ³¢è­¦å ±:</label>
                    <select id="sound-for-tsunami-major" class="p-1 rounded text-sm w-36 bg-blue-800 text-white focus:ring-yellow-500 focus:border-yellow-500" onload="this.innerHTML = soundOptions">
                        <script>document.write(soundOptions)</script>
                    </select>
                </div>

                <div class="flex items-center justify-between">
                    <label class="text-white text-sm font-medium">æ´¥æ³¢è­¦å ±:</label>
                    <select id="sound-for-tsunami-warning" class="p-1 rounded text-sm w-36 bg-blue-800 text-white focus:ring-yellow-500 focus:border-yellow-500" onload="this.innerHTML = soundOptions">
                        <script>document.write(soundOptions)</script>
                    </select>
                </div>

                <div class="flex items-center justify-between">
                    <label class="text-white text-sm font-medium">æ´¥æ³¢æ³¨æ„å ±:</label>
                    <select id="sound-for-tsunami-advisory" class="p-1 rounded text-sm w-36 bg-blue-800 text-white focus:ring-yellow-500 focus:border-yellow-500" onload="this.innerHTML = soundOptions">
                        <script>document.write(soundOptions)</script>
                    </select>
                </div>
                <div class="flex items-center justify-between">
                    <label class="text-white text-sm font-medium">è­¦å ±è§£é™¤:</label>
                    <select id="sound-for-tsunami-cancelled" class="p-1 rounded text-sm w-36 bg-blue-800 text-white focus:ring-yellow-500 focus:border-yellow-500" onload="this.innerHTML = soundOptions">
                        <script>document.write(soundOptions)</script>
                    </select>
                </div>
                <!-- æ´¥æ³¢å°‚ç”¨URLéŸ³æºè¨­å®š -->
                <div class="flex flex-col gap-1 p-2 mt-2 bg-blue-800 rounded-lg border border-blue-500">
                    <p class="text-xs font-bold text-blue-300">â†“ å„è­¦å ±å°‚ç”¨ã®éŸ³æºURL (å„ªå…ˆå†ç”Ÿ)</p>
                    <div class="flex flex-col gap-1 text-xs">
                        <input type="text" id="tsunami-url-major" placeholder="å¤§æ´¥æ³¢è­¦å ± URL (mp3/wav)" class="p-1 rounded w-full bg-blue-700 text-white placeholder-gray-400">
                        <p id="tsunami-url-major-status" class="loading-status text-yellow-500">æœªè¨­å®š</p>
                    </div>
                     <div class="flex flex-col gap-1 text-xs mt-1">
                        <input type="text" id="tsunami-url-warning" placeholder="æ´¥æ³¢è­¦å ± URL (mp3/wav)" class="p-1 rounded w-full bg-blue-700 text-white placeholder-gray-400">
                        <p id="tsunami-url-warning-status" class="loading-status text-yellow-500">æœªè¨­å®š</p>
                    </div>
                     <div class="flex flex-col gap-1 text-xs mt-1">
                        <input type="text" id="tsunami-url-advisory" placeholder="æ´¥æ³¢æ³¨æ„å ± URL (mp3/wav)" class="p-1 rounded w-full bg-blue-700 text-white placeholder-gray-400">
                        <p id="tsunami-url-advisory-status" class="loading-status text-yellow-500">æœªè¨­å®š</p>
                    </div>
                     <div class="flex flex-col gap-1 text-xs mt-1">
                        <input type="text" id="tsunami-url-cancelled" placeholder="è­¦å ±è§£é™¤ URL (mp3/wav)" class="p-1 rounded w-full bg-blue-700 text-white placeholder-gray-400">
                        <p id="tsunami-url-cancelled-status" class="loading-status text-yellow-500">æœªè¨­å®š</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- 3. ğŸµ ã‚«ã‚¹ã‚¿ãƒ ã‚¢ãƒ©ãƒ¼ãƒ éŸ³ã®è¨­å®šã‚°ãƒ«ãƒ¼ãƒ— ğŸ¶ -->
        <div class="flex flex-col p-3 bg-gray-800 rounded-lg mb-4 border border-gray-600">
            <!-- ãƒ˜ãƒƒãƒ€ãƒ¼ (ã‚¯ãƒªãƒƒã‚¯ã§å±•é–‹/æŠ˜ã‚ŠãŸãŸã¿) - ã‚¢ã‚¤ã‚³ãƒ³ã‚’çµ±åˆ -->
            <button id="toggle-custom-alarm" class="toggle-header flex items-center w-full text-sm font-semibold text-gray-300 border-gray-700 hover:text-white transition">
                <span id="custom-alarm-icon" class="text-base mr-2 transform transition-transform duration-300">â–¶</span>
                <span class="text-left">ã‚«ã‚¹ã‚¿ãƒ ã‚¢ãƒ©ãƒ¼ãƒ éŸ³ã®<br>ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿è¨­å®š</span>
            </button>
            
            <!-- æŠ˜ã‚ŠãŸãŸã¿å¯èƒ½ãªã‚³ãƒ³ãƒ†ãƒ³ãƒ„ -->
            <div id="custom-alarm-content" class="collapsible-content">
                
                <!-- ã‚«ã‚¹ã‚¿ãƒ ãƒˆãƒ¼ãƒ³ (ã‚·ãƒ³ã‚»ã‚µã‚¤ã‚¶ãƒ¼éŸ³) -->
                <div class="flex flex-col gap-1 p-2 bg-gray-700 rounded-lg">
                    <p class="text-sm font-bold text-yellow-400">ğŸµ ã‚«ã‚¹ã‚¿ãƒ  A (å¤‰èª¿éŸ³)</p>
                    <div class="flex justify-between items-center text-xs text-white">
                        <label>ãƒ™ãƒ¼ã‚¹å‘¨æ³¢æ•° (Hz):</label>
                        <input type="number" id="custom-a-baseFreq" min="100" max="2000" class="p-1 rounded w-16 bg-gray-600 text-white text-right">
                    </div>
                    <div class="flex justify-between items-center text-xs text-white">
                        <label>å¤‰èª¿å¹… (Hz):</label>
                        <input type="number" id="custom-a-modFreq" min="0" max="1000" class="p-1 rounded w-16 bg-gray-600 text-white text-right">
                    </div>
                    <p class="text-sm font-bold text-yellow-400 mt-2">ğŸ¶ ã‚«ã‚¹ã‚¿ãƒ  B (ãƒ†ãƒ³ãƒ/ãƒªãƒ”ãƒ¼ãƒˆ)</p>
                    <div class="flex justify-between items-center text-xs text-white">
                        <label>ãƒ†ãƒ³ãƒ (ms/éŸ³):</label>
                        <input type="number" id="custom-b-tempoMs" min="50" max="1000" class="p-1 rounded w-16 bg-gray-600 text-white text-right">
                    </div>
                </div>

                <!-- URLéŸ³æº A -->
                <div class="flex flex-col gap-1 p-2 bg-gray-700 rounded-lg">
                    <p class="text-sm font-bold text-green-400">ğŸ”Š URLéŸ³æº A (.mp3/.wavãªã©)</p>
                    <input type="text" id="custom-url-a-input" placeholder="CORSå¯¾å¿œã®éŸ³å£°URL (mp3/wav)" class="p-1 rounded w-full bg-gray-600 text-white text-xs">
                    <p id="custom-url-a-status" class="loading-status text-yellow-500">æœªè¨­å®š</p>
                </div>
                
                <!-- URLéŸ³æº B -->
                <div class="flex flex-col gap-1 p-2 bg-gray-700 rounded-lg">
                    <p class="text-sm font-bold text-green-400">ğŸ”Š URLéŸ³æº B (.mp3/.wavãªã©)</p>
                    <input type="text" id="custom-url-b-input" placeholder="CORSå¯¾å¿œã®éŸ³å£°URL (mp3/wav)" class="p-1 rounded w-full bg-gray-600 text-white text-xs">
                    <p id="custom-url-b-status" class="loading-status text-yellow-500">æœªè¨­å®š</p>
                </div>
            </div>
        </div>

        <!-- 5. å—ä¿¡å±¥æ­´ã‚°ãƒ«ãƒ¼ãƒ— -->
        <div class="flex flex-col gap-2 p-3 bg-gray-800 rounded-lg mb-4">
            <!-- ãƒ˜ãƒƒãƒ€ãƒ¼ (ã‚¯ãƒªãƒƒã‚¯ã§å±•é–‹/æŠ˜ã‚ŠãŸãŸã¿) -->
            <button id="toggle-history" class="toggle-header flex justify-between items-center w-full text-sm font-semibold text-gray-300 border-gray-700 hover:text-white transition">
                <div class="flex items-center">
                    <span id="history-icon" class="text-base mr-2 transform transition-transform duration-300">â–¶</span>
                    <span class="leading-tight text-left">å—ä¿¡å±¥æ­´<br>(æœ€æ–°50ä»¶)</span>
                </div>
                <span id="clear-history" class="text-xs text-gray-400 hover:text-white transition z-10 p-1 -mr-1">å…¨æ¶ˆå»</span>
            </button>
            
            <!-- æŠ˜ã‚ŠãŸãŸã¿å¯èƒ½ãªã‚³ãƒ³ãƒ†ãƒ³ãƒ„ -->
            <div id="history-content" class="collapsible-content">
                <!-- å‡¡ä¾‹ã‚’è¿½åŠ  -->
                <div class="text-xs text-gray-400 flex items-center gap-3 px-1">
                    <span>å‡¡ä¾‹:</span>
                    <div class="flex items-center gap-1">
                        <span class="w-2.5 h-2.5" style="background-color: #4ade80;"></span>
                        <span>è¡¨ç¤º</span>
                    </div>
                    <div class="flex items-center gap-1">
                        <span class="w-2.5 h-2.5" style="background-color: #facc15;"></span>
                        <span>ã‚¹ã‚­ãƒƒãƒ—</span>
                    </div>
                </div>
                <ul id="history-list"></ul>
            </div>
        </div>

        <!-- 4. ãƒ†ã‚¹ãƒˆã‚°ãƒ«ãƒ¼ãƒ— -->
        <div class="flex flex-col p-3 bg-gray-800 rounded-lg">
            <!-- ãƒ˜ãƒƒãƒ€ãƒ¼ (ã‚¯ãƒªãƒƒã‚¯ã§å±•é–‹/æŠ˜ã‚ŠãŸãŸã¿) -->
            <button id="toggle-test-utility" class="toggle-header flex items-center w-full text-sm font-semibold text-gray-300 border-gray-700 hover:text-white transition">
                <span id="test-utility-icon" class="text-base mr-2 transform transition-transform duration-300">â–¶</span>
                <span>ãƒ†ã‚¹ãƒˆ/ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£</span>
            </button>
            
            <!-- æŠ˜ã‚ŠãŸãŸã¿å¯èƒ½ãªã‚³ãƒ³ãƒ†ãƒ³ãƒ„ -->
            <div id="test-utility-content" class="collapsible-content">
                <div class="grid grid-cols-2 gap-2">
                    <!-- ç¶šå ±ãƒ†ã‚¹ãƒˆç”¨ã‚°ãƒ«ãƒ¼ãƒ—A -->
                    <button id="test-eew-5weak-a" class="px-2 py-1 bg-yellow-600 text-white font-semibold rounded-lg hover:bg-yellow-700 transition duration-150 text-sm shadow-md">
                        <span class="test-button-label">éœ‡åº¦5å¼±<br>ï¼ˆæ–°è¦EEWï¼‰</span>
                    </button>
                    <button id="test-eew-6strong-a" class="px-2 py-1 bg-red-700 text-white font-semibold rounded-lg hover:bg-red-800 transition duration-150 text-sm shadow-md">
                        <span class="test-button-label">éœ‡åº¦6å¼·<br>ï¼ˆEEWç¶šå ±ï¼‰</span>
                    </button>
                    <button id="test-quake-3" class="px-2 py-1 bg-orange-600 text-white font-semibold rounded-lg hover:bg-orange-700 transition duration-150 text-sm shadow-md">åœ°éœ‡æƒ…å ±<br>ãƒ†ãƒ­ãƒƒãƒ—</button>
                    <button id="test-sound" class="px-2 py-1 bg-purple-600 text-white font-semibold rounded-lg hover:bg-purple-700 transition duration-150 text-sm shadow-md">ã‚¢ãƒ©ãƒ¼ãƒ éŸ³<br>ãƒ†ã‚¹ãƒˆ</button>
                    <button id="test-tsunami-advisory" class="px-2 py-1 bg-blue-600 text-white font-semibold rounded-lg hover:bg-blue-700 transition duration-150 text-sm shadow-md">
                        <span class="test-button-label">æ´¥æ³¢æ³¨æ„å ±<br>ãƒ†ã‚¹ãƒˆ</span>
                    </button>
                    <button id="test-tsunami-major-warning" class="px-2 py-1 bg-purple-800 text-white font-semibold rounded-lg hover:bg-purple-900 transition duration-150 text-sm shadow-md">
                        <span class="test-button-label">å¤§æ´¥æ³¢è­¦å ±<br>ãƒ†ã‚¹ãƒˆ</span>
                    </button>
                </div>
                <button id="clear-alert" class="w-full px-2 py-1 bg-gray-500 text-white font-semibold rounded-lg hover:bg-gray-600 transition duration-150 text-sm shadow-md mt-2">ã™ã¹ã¦ã®ã‚¢ãƒ©ãƒ¼ãƒˆã‚’éè¡¨ç¤º</button>
            </div>
        </div>
    </div>
    <!-- ãƒ†ã‚¹ãƒˆç”¨ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ãƒ‘ãƒãƒ« çµ‚äº† -->


    <script>
        // DOMè¦ç´ ã®å–å¾—
        const eewContainer = document.getElementById('eew-container');
        const loadStatusEl = document.getElementById('load-status');
        const minIntensityTickerSelect = document.getElementById('min-intensity-ticker');
        const minIntensitySelect = document.getElementById('min-intensity'); 
        const eewDurationInput = document.getElementById('eew-duration');
        const quakeDurationInput = document.getElementById('quake-duration'); 

        // ğŸš¨ ãƒ†ãƒ­ãƒƒãƒ—é–¢é€£ ğŸš¨
        const quakeTickerArea = document.getElementById('quake-ticker-area');
        const tickerContent = document.getElementById('ticker-content');

        const toggleSettingsButton = document.getElementById('toggle-settings');
        const testControls = document.getElementById('test-controls');
        
        // 1. è¡¨ç¤ºè¨­å®šã®è¦ç´ 
        const toggleDisplaySettings = document.getElementById('toggle-display-settings');
        const displaySettingsContent = document.getElementById('display-settings-content');
        const displaySettingsIcon = document.getElementById('display-settings-icon');


        // ğŸš¨ éœ‡åº¦åˆ¥ã‚¢ãƒ©ãƒ¼ãƒ è¨­å®šè¦ç´  ğŸš¨
        const toggleIntensityAlarm = document.getElementById('toggle-intensity-alarm');
        const intensityAlarmContent = document.getElementById('intensity-alarm-content');
        const intensityAlarmIcon = document.getElementById('intensity-alarm-icon');
        const soundForInt4El = document.getElementById('sound-for-int4');
        const soundForInt5El = document.getElementById('sound-for-int5');
        const soundForInt6El = document.getElementById('sound-for-int6');

        // ğŸŒŠ æ´¥æ³¢ã‚¢ãƒ©ãƒ¼ãƒ è¨­å®šè¦ç´  ğŸŒŠ
        const toggleTsunamiAlarm = document.getElementById('toggle-tsunami-alarm');
        const tsunamiAlarmContent = document.getElementById('tsunami-alarm-content');
        const tsunamiAlarmIcon = document.getElementById('tsunami-alarm-icon');
        const soundForTsunamiMajorEl = document.getElementById('sound-for-tsunami-major');
        const soundForTsunamiWarningEl = document.getElementById('sound-for-tsunami-warning');
        const soundForTsunamiAdvisoryEl = document.getElementById('sound-for-tsunami-advisory');
        const soundForTsunamiCancelledEl = document.getElementById('sound-for-tsunami-cancelled');
        // æ´¥æ³¢å°‚ç”¨URLéŸ³æºè¦ç´ 
        const tsunamiUrlMajorInput = document.getElementById('tsunami-url-major');
        const tsunamiUrlMajorStatus = document.getElementById('tsunami-url-major-status');
        const tsunamiUrlWarningInput = document.getElementById('tsunami-url-warning');
        const tsunamiUrlWarningStatus = document.getElementById('tsunami-url-warning-status');
        const tsunamiUrlAdvisoryInput = document.getElementById('tsunami-url-advisory');
        const tsunamiUrlAdvisoryStatus = document.getElementById('tsunami-url-advisory-status');
        const tsunamiUrlCancelledInput = document.getElementById('tsunami-url-cancelled');
        const tsunamiUrlCancelledStatus = document.getElementById('tsunami-url-cancelled-status');


        // ğŸµ ã‚«ã‚¹ã‚¿ãƒ ã‚¢ãƒ©ãƒ¼ãƒ è¨­å®šè¦ç´  ğŸ¶
        const customAlarmToggle = document.getElementById('toggle-custom-alarm');
        const customAlarmContent = document.getElementById('custom-alarm-content');
        const customAlarmIcon = document.getElementById('custom-alarm-icon'); 
        
        // ã‚«ã‚¹ã‚¿ãƒ ãƒˆãƒ¼ãƒ³ (ã‚·ãƒ³ã‚»éŸ³)
        const customA_BaseFreq = document.getElementById('custom-a-baseFreq');
        const customA_ModFreq = document.getElementById('custom-a-modFreq');
        const customB_TempoMs = document.getElementById('custom-b-tempoMs');
        
        // ã‚«ã‚¹ã‚¿ãƒ URLéŸ³æº
        const customUrlAInput = document.getElementById('custom-url-a-input');
        const customUrlAStatus = document.getElementById('custom-url-a-status');
        const customUrlBInput = document.getElementById('custom-url-b-input');
        const customUrlBStatus = document.getElementById('custom-url-b-status');

        // å±¥æ­´é–¢é€£ã®è¦ç´ 
        const historyListEl = document.getElementById('history-list');
        const toggleHistoryButton = document.getElementById('toggle-history');
        const historyContentEl = document.getElementById('history-content');
        const historyIconEl = document.getElementById('history-icon');
        const clearHistoryButton = document.getElementById('clear-history');


        // ãƒ†ã‚¹ãƒˆç”¨ãƒœã‚¿ãƒ³ã®å–å¾—
        const testEew5WeakA = document.getElementById('test-eew-5weak-a');
        const testEew6StrongA = document.getElementById('test-eew-6strong-a');
        const testQuake3Button = document.getElementById('test-quake-3');
        const testTsunamiAdvisory = document.getElementById('test-tsunami-advisory');
        const testTsunamiMajorWarning = document.getElementById('test-tsunami-major-warning');
        const testSoundButton = document.getElementById('test-sound'); 
        const clearAlertButton = document.getElementById('clear-alert');
        
        // 4. ãƒ†ã‚¹ãƒˆ/ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ã®è¦ç´ 
        const toggleTestUtility = document.getElementById('toggle-test-utility');
        const testUtilityContent = document.getElementById('test-utility-content');
        const testUtilityIcon = document.getElementById('test-utility-icon');

        // æ´¥æ³¢è­¦å ±ã®çŠ¶æ…‹ã‚’ç®¡ç†ã™ã‚‹å¤‰æ•°
        let activeTsunamiInfo = null;


        // å±¥æ­´ãƒ‡ãƒ¼ã‚¿ã‚’ä¿æŒã™ã‚‹é…åˆ—
        let receivedHistory = [];
        const MAX_HISTORY_COUNT = 50;

        // ----------------------------------------------------
        // ğŸŒŸ æ°¸ç¶šåŒ–ã®ãŸã‚ã®è¨­å®š ğŸŒŸ
        // ----------------------------------------------------
        const HISTORY_STORAGE_KEY = 'eewOverlayHistory';
        const LOCAL_STORAGE_KEY = 'eewOverlaySettings';

        const DEFAULT_SETTINGS = {
            minIntensityScale: 50, // éœ‡åº¦5å¼±
            minIntensityScaleTicker: 30, // ãƒ†ãƒ­ãƒƒãƒ—ã¯éœ‡åº¦3
            eewDuration: 15,       // EEWè¡¨ç¤ºæ™‚é–“ (ç§’)
            quakeDuration: 20,     // åœ°éœ‡æƒ…å ±ãƒ†ãƒ­ãƒƒãƒ—ã®ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«é€Ÿåº¦ (ç§’/ç”»é¢å¹…)
            
            // ğŸš¨ éœ‡åº¦åˆ¥ã‚¢ãƒ©ãƒ¼ãƒ éŸ³è¨­å®šã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ
            eewSoundMap: {
                int4_down: 'classic_eew', // éœ‡åº¦4ä»¥ä¸‹
                int5_mid: 'custom_url_a', // éœ‡åº¦5å¼±ãƒ»5å¼·
                int6_up: 'custom_url_a'     // éœ‡åº¦6å¼±ä»¥ä¸Š
            },
            
            // ğŸŒŠ æ´¥æ³¢é–¢é€£ã‚¢ãƒ©ãƒ¼ãƒ éŸ³è¨­å®šã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ
            tsunamiSoundMap: {
                major: 'urgent_siren',
                warning: 'classic_eew',
                advisory: 'simple_beep',
                cancelled: 'silent'
            },

            // ğŸŒŠ æ´¥æ³¢é–¢é€£ã®å°‚ç”¨éŸ³æºURLè¨­å®šã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ ğŸŒŠ
            tsunamiSoundUrls: {
                major: 'https://github.com/AfterEffects-OK/EarthquakeEarlyWarning/raw/refs/heads/main/Tsunami_Major%20tsunami%20warning.aac', // ä¾‹: 'https://example.com/major_warning.mp3'
                warning: 'https://github.com/AfterEffects-OK/EarthquakeEarlyWarning/raw/refs/heads/main/Tsunami_Tsunami%20warning.aac', // ä¾‹: 'https://example.com/warning.mp3'
                advisory: 'https://github.com/AfterEffects-OK/EarthquakeEarlyWarning/raw/refs/heads/main/Tsunami_Tsunami%20advisory.aac', // ä¾‹: 'https://example.com/advisory.mp3'
                cancelled: '' // ä¾‹: 'https://example.com/cancelled.mp3'
            },

            //  ã‚«ã‚¹ã‚¿ãƒ ãƒˆãƒ¼ãƒ³ã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ ğŸ¶
            customTones: {
                custom_a: {
                    baseFreq: 880,  // Hz (åŸºæº–å‘¨æ³¢æ•° - A)
                    modFreq: 120,   // Hz (å¤‰èª¿å¹… - A)
                },
                custom_b: {
                    baseFreq: 440,
                    modFreq: 220,
                    tempoMs: 300,   // ms (1éŸ³ã®é•·ã• - BãŒãƒ†ãƒ³ãƒã‚’ä»£è¡¨)
                    repeats: 3      // å› (ç¹°ã‚Šè¿”ã—å›æ•° - BãŒãƒªãƒ”ãƒ¼ãƒˆã‚’ä»£è¡¨)
                }
            },
            // ğŸ”Š ã‚«ã‚¹ã‚¿ãƒ URLéŸ³æº ğŸ”Š
            customUrls: {
                custom_url_a: 'https://github.com/AfterEffects-OK/EarthquakeEarlyWarning/raw/refs/heads/main/EEW_Woman_2.aac',
                custom_url_b: 'https://github.com/AfterEffects-OK/EarthquakeEarlyWarning/raw/refs/heads/main/EEW_Man.aac',
            },
            
            // UIã®æŠ˜ã‚ŠãŸãŸã¿çŠ¶æ…‹ã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ
            uiState: {
                isDisplaySettingsExpanded: false,
                isIntensityAlarmExpanded: false,
                isTsunamiAlarmExpanded: false,
                isCustomAlarmExpanded: false,
                isHistoryExpanded: true, // å±¥æ­´ã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§é–‹ã„ã¦ãŠã
                isTestUtilityExpanded: false
            }
        };

        // å®Ÿè¡Œä¸­ã®è¨­å®šå€¤
        let CURRENT_SETTINGS = {...DEFAULT_SETTINGS}; 
        
        // ----------------------------------------------------
        // ğŸ’¾ è¨­å®šã®ä¿å­˜ã¨ãƒ­ãƒ¼ãƒ‰æ©Ÿèƒ½ (LocalStorage) ğŸ’¾
        // ----------------------------------------------------
        
        /**
         * ç¾åœ¨ã®è¨­å®šã‚’ãƒ–ãƒ©ã‚¦ã‚¶ã®LocalStorageã«ä¿å­˜ã™ã‚‹
         * @param {Object} newSettings - æ›´æ–°ã™ã‚‹è¨­å®šã®ä¸€éƒ¨ã¾ãŸã¯å…¨éƒ¨
         */
        function saveSettings(newSettings) {
            
            // ç¾åœ¨ã®è¨­å®šã‚’ãƒ‡ã‚£ãƒ¼ãƒ—ãƒãƒ¼ã‚¸
            const mergedSettings = { 
                ...CURRENT_SETTINGS,
                ...newSettings,
                eewSoundMap: {
                    ...CURRENT_SETTINGS.eewSoundMap,
                    ...(newSettings.eewSoundMap || {})
                },
                tsunamiSoundMap: {
                    ...CURRENT_SETTINGS.tsunamiSoundMap,
                    ...(newSettings.tsunamiSoundMap || {})
                },
                tsunamiSoundUrls: {
                    ...CURRENT_SETTINGS.tsunamiSoundUrls,
                    ...(newSettings.tsunamiSoundUrls || {})
                },
                customTones: {
                    ...CURRENT_SETTINGS.customTones,
                    ...(newSettings.customTones || {})
                },
                customUrls: {
                    ...CURRENT_SETTINGS.customUrls,
                    ...(newSettings.customUrls || {})
                },
                uiState: {
                    ...CURRENT_SETTINGS.uiState,
                    ...(newSettings.uiState || {})
                }
            };
            
            try {
                localStorage.setItem(LOCAL_STORAGE_KEY, JSON.stringify(mergedSettings));
                CURRENT_SETTINGS = mergedSettings; // å®Ÿè¡Œä¸­ã®è¨­å®šã‚’æ›´æ–°
                console.log('è¨­å®šã‚’LocalStorageã«ä¿å­˜ã—ã¾ã—ãŸã€‚');
            } catch (e) {
                console.error('è¨­å®šã®ä¿å­˜ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ:', e);
            }
        }
        
        /** LocalStorageã‹ã‚‰è¨­å®šã‚’ãƒ­ãƒ¼ãƒ‰ã—ã€å®Ÿè¡Œä¸­ã®è¨­å®šã‚’æ›´æ–°ã™ã‚‹ */
        function loadSettingsFromLocalStorage() {
            try {
                const savedSettings = localStorage.getItem(LOCAL_STORAGE_KEY);
                if (savedSettings) {
                    const loaded = JSON.parse(savedSettings);
                    
                    // ãƒ­ãƒ¼ãƒ‰ã—ãŸè¨­å®šã‚’ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆè¨­å®šã¨ãƒãƒ¼ã‚¸ã—ã¦CURRENT_SETTINGSã«ã‚»ãƒƒãƒˆ
                    CURRENT_SETTINGS = {
                        ...DEFAULT_SETTINGS, 
                        ...loaded,
                        eewSoundMap: {
                            ...DEFAULT_SETTINGS.eewSoundMap,
                            ...(loaded.eewSoundMap || {})
                        },
                        tsunamiSoundMap: {
                            ...DEFAULT_SETTINGS.tsunamiSoundMap,
                            ...(loaded.tsunamiSoundMap || {})
                        },
                        tsunamiSoundUrls: {
                            ...DEFAULT_SETTINGS.tsunamiSoundUrls,
                            ...(loaded.tsunamiSoundUrls || {})
                        },
                        customTones: {
                            ...DEFAULT_SETTINGS.customTones,
                            ...(loaded.customTones || {})
                        },
                         customUrls: {
                            ...DEFAULT_SETTINGS.customUrls,
                            ...(loaded.customUrls || {})
                        },
                        uiState: {
                            ...DEFAULT_SETTINGS.uiState,
                            ...(loaded.uiState || {})
                        }
                    };
                    console.log('è¨­å®šã‚’LocalStorageã‹ã‚‰ãƒ­ãƒ¼ãƒ‰ã—ã¾ã—ãŸã€‚');
                } else {
                    // åˆå›èµ·å‹•æ™‚ã€ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆè¨­å®šã‚’ä¿å­˜
                    saveSettings(DEFAULT_SETTINGS); 
                    console.log('LocalStorageã«è¨­å®šãŒãªã„ãŸã‚ã€ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆè¨­å®šã‚’é©ç”¨ã—ã¾ã—ãŸã€‚');
                }
            } catch (e) {
                console.error('è¨­å®šã®ãƒ­ãƒ¼ãƒ‰ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ:', e);
                CURRENT_SETTINGS = {...DEFAULT_SETTINGS};
            }
            
            // UIã«é©ç”¨
            updateUIFromSettings();
            // URLéŸ³æºã®ãƒ­ãƒ¼ãƒ‰ã‚’ãƒˆãƒªã‚¬ãƒ¼
            loadAllCustomUrls();
        }

        
        /** å®Ÿè¡Œä¸­ã®è¨­å®šã«åŸºã¥ã„ã¦UIã‚’æ›´æ–°ã™ã‚‹ */
        function updateUIFromSettings() {
            minIntensitySelect.value = CURRENT_SETTINGS.minIntensityScale;
            minIntensityTickerSelect.value = CURRENT_SETTINGS.minIntensityScaleTicker;
            eewDurationInput.value = CURRENT_SETTINGS.eewDuration;
            quakeDurationInput.value = CURRENT_SETTINGS.quakeDuration;
            
            // ğŸš¨ éœ‡åº¦åˆ¥ã‚¢ãƒ©ãƒ¼ãƒ éŸ³è¨­å®šã‚’UIã«é©ç”¨ ğŸš¨
            soundForInt4El.value = CURRENT_SETTINGS.eewSoundMap.int4_down;
            soundForInt5El.value = CURRENT_SETTINGS.eewSoundMap.int5_mid;
            soundForInt6El.value = CURRENT_SETTINGS.eewSoundMap.int6_up;

            // ğŸŒŠ æ´¥æ³¢ã‚¢ãƒ©ãƒ¼ãƒ éŸ³è¨­å®šã‚’UIã«é©ç”¨ ğŸŒŠ
            soundForTsunamiMajorEl.value = CURRENT_SETTINGS.tsunamiSoundMap.major;
            soundForTsunamiWarningEl.value = CURRENT_SETTINGS.tsunamiSoundMap.warning;
            soundForTsunamiAdvisoryEl.value = CURRENT_SETTINGS.tsunamiSoundMap.advisory;
            soundForTsunamiCancelledEl.value = CURRENT_SETTINGS.tsunamiSoundMap.cancelled;

            // ğŸŒŠ æ´¥æ³¢å°‚ç”¨URLéŸ³æºè¨­å®šã‚’UIã«é©ç”¨ ğŸŒŠ
            tsunamiUrlMajorInput.value = CURRENT_SETTINGS.tsunamiSoundUrls.major;
            tsunamiUrlWarningInput.value = CURRENT_SETTINGS.tsunamiSoundUrls.warning;
            tsunamiUrlAdvisoryInput.value = CURRENT_SETTINGS.tsunamiSoundUrls.advisory;
            tsunamiUrlCancelledInput.value = CURRENT_SETTINGS.tsunamiSoundUrls.cancelled;
            
            // ğŸµ ã‚«ã‚¹ã‚¿ãƒ ãƒˆãƒ¼ãƒ³ (ã‚·ãƒ³ã‚»éŸ³) è¨­å®šã‚’UIã«é©ç”¨ ğŸ¶
            const customA = CURRENT_SETTINGS.customTones.custom_a;
            const customB = CURRENT_SETTINGS.customTones.custom_b;
            
            customA_BaseFreq.value = customA.baseFreq;
            customA_ModFreq.value = customA.modFreq;
            customB_TempoMs.value = customB.tempoMs;

            // ğŸ”Š ã‚«ã‚¹ã‚¿ãƒ URLéŸ³æºè¨­å®šã‚’UIã«é©ç”¨ ğŸ”Š
            customUrlAInput.value = CURRENT_SETTINGS.customUrls.custom_url_a;
            customUrlBInput.value = CURRENT_SETTINGS.customUrls.custom_url_b;
            
            // UIã®æŠ˜ã‚ŠãŸãŸã¿çŠ¶æ…‹ã‚’é©ç”¨
            applyCollapsibleState(displaySettingsContent, displaySettingsIcon, CURRENT_SETTINGS.uiState.isDisplaySettingsExpanded);
            applyCollapsibleState(intensityAlarmContent, intensityAlarmIcon, CURRENT_SETTINGS.uiState.isIntensityAlarmExpanded);
            applyCollapsibleState(tsunamiAlarmContent, tsunamiAlarmIcon, CURRENT_SETTINGS.uiState.isTsunamiAlarmExpanded);
            applyCollapsibleState(customAlarmContent, customAlarmIcon, CURRENT_SETTINGS.uiState.isCustomAlarmExpanded);
            applyCollapsibleState(historyContentEl, historyIconEl, CURRENT_SETTINGS.uiState.isHistoryExpanded);
            applyCollapsibleState(testUtilityContent, testUtilityIcon, CURRENT_SETTINGS.uiState.isTestUtilityExpanded);
        }
        

        /** æŠ˜ã‚ŠãŸãŸã¿è¦ç´ ã®å±•é–‹çŠ¶æ…‹ã‚’é©ç”¨ã™ã‚‹ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•° */
        function applyCollapsibleState(contentEl, iconEl, isExpanded) {
            if (isExpanded) {
                contentEl.classList.add('expanded');
                iconEl.textContent = 'â–¼'; 
            } else {
                contentEl.classList.remove('expanded');
                iconEl.textContent = 'â–¶';
            }
        }

        // ----------------------------------------------------
        // âš™ï¸ åˆæœŸåŒ–ã¨ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ âš™ï¸
        // ----------------------------------------------------

        const INTENSITY_OPTIONS = [
            { value: 0, label: 'è¨­å®šãªã—/1æœªæº€' }, { value: 10, label: '1' },
            { value: 20, label: '2' }, { value: 30, label: '3' }, 
            { value: 40, label: '4' }, { value: 45, label: '5å¼±' },
            { value: 50, label: '5å¼·' }, { value: 55, label: '6å¼±' },
            { value: 60, label: '6å¼·' }, { value: 70, label: '7' },
        ];
        
        /** DOMã¨åˆæœŸè¨­å®šã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ— */
        function setupApp() {
            // éœ‡åº¦ã‚»ãƒ¬ã‚¯ã‚¿ãƒ¼ã®ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’ä½œæˆ
            INTENSITY_OPTIONS.forEach(optionData => {
                const option = document.createElement('option');
                option.value = optionData.value;
                option.textContent = optionData.label;
                minIntensitySelect.appendChild(option.cloneNode(true));
                minIntensityTickerSelect.appendChild(option.cloneNode(true));
            });
            
            // è¡¨ç¤ºè¨­å®šã®ãƒˆã‚°ãƒ«æ©Ÿèƒ½
            toggleDisplaySettings.addEventListener('click', () => {
                const isExpanded = displaySettingsContent.classList.toggle('expanded');
                applyCollapsibleState(displaySettingsContent, displaySettingsIcon, isExpanded);
                saveSettings({ uiState: { isDisplaySettingsExpanded: isExpanded } });
            });

            // UIã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã®è¨­å®š (è¡¨ç¤ºè¨­å®š)
            minIntensitySelect.addEventListener('change', (event) => {
                saveSettings({ minIntensityScale: parseInt(event.target.value, 10) });
            });
            // ãƒ†ãƒ­ãƒƒãƒ—æœ€ä½éœ‡åº¦ã®ãƒªã‚¹ãƒŠãƒ¼ã‚’è¿½åŠ 
            minIntensityTickerSelect.addEventListener('change', (event) => {
                saveSettings({ minIntensityScaleTicker: parseInt(event.target.value, 10) });
            });
            eewDurationInput.addEventListener('change', (event) => {
                const newValue = parseInt(event.target.value, 10);
                if (newValue >= 5) saveSettings({ eewDuration: newValue });
                else event.target.value = CURRENT_SETTINGS.eewDuration;
            });
            // ãƒ†ãƒ­ãƒƒãƒ—é€Ÿåº¦è¨­å®šã®ãƒªã‚¹ãƒŠãƒ¼
            quakeDurationInput.addEventListener('change', (event) => {
                const newValue = parseInt(event.target.value, 10);
                if (newValue >= 10) saveSettings({ quakeDuration: newValue });
                else event.target.value = CURRENT_SETTINGS.quakeDuration;
            });

            // éœ‡åº¦åˆ¥ã‚¢ãƒ©ãƒ¼ãƒ éŸ³è¨­å®šã®ãƒªã‚¹ãƒŠãƒ¼
            const updateSoundMap = () => {
                const newMap = {
                    int4_down: soundForInt4El.value,
                    int5_mid: soundForInt5El.value,
                    int6_up: soundForInt6El.value,
                };
                saveSettings({ eewSoundMap: newMap });
            };
            soundForInt4El.addEventListener('change', updateSoundMap);
            soundForInt5El.addEventListener('change', updateSoundMap);
            soundForInt6El.addEventListener('change', updateSoundMap);

            // ğŸŒŠ æ´¥æ³¢ã‚¢ãƒ©ãƒ¼ãƒ éŸ³è¨­å®šã®ãƒªã‚¹ãƒŠãƒ¼ ğŸŒŠ
            const updateTsunamiSoundMap = () => {
                const newMap = {
                    major: soundForTsunamiMajorEl.value,
                    warning: soundForTsunamiWarningEl.value,
                    advisory: soundForTsunamiAdvisoryEl.value,
                    cancelled: soundForTsunamiCancelledEl.value,
                };
                saveSettings({ tsunamiSoundMap: newMap });
            };
            soundForTsunamiMajorEl.addEventListener('change', updateTsunamiSoundMap);
            soundForTsunamiWarningEl.addEventListener('change', updateTsunamiSoundMap);
            soundForTsunamiAdvisoryEl.addEventListener('change', updateTsunamiSoundMap);
            soundForTsunamiCancelledEl.addEventListener('change', updateTsunamiSoundMap);

            // ğŸŒŠ æ´¥æ³¢å°‚ç”¨URLéŸ³æºã®ãƒªã‚¹ãƒŠãƒ¼ ğŸŒŠ
            const handleTsunamiUrlChange = (inputEl, statusEl, key) => {
                inputEl.addEventListener('change', (event) => {
                    const newUrl = event.target.value.trim();
                    statusEl.textContent = 'ãƒ­ãƒ¼ãƒ‰ä¸­...';
                    statusEl.classList.remove('text-green-500', 'text-red-500');
                    statusEl.classList.add('text-yellow-500');

                    const update = {};
                    update[key] = newUrl;
                    
                    saveSettings({ tsunamiSoundUrls: update }); 
                    
                    loadAudioFromUrl(`tsunami_${key}`, newUrl, statusEl);
                });
            };
            handleTsunamiUrlChange(tsunamiUrlMajorInput, tsunamiUrlMajorStatus, 'major');
            handleTsunamiUrlChange(tsunamiUrlWarningInput, tsunamiUrlWarningStatus, 'warning');
            handleTsunamiUrlChange(tsunamiUrlAdvisoryInput, tsunamiUrlAdvisoryStatus, 'advisory');
            handleTsunamiUrlChange(tsunamiUrlCancelledInput, tsunamiUrlCancelledStatus, 'cancelled');
            
            // ğŸµ ã‚«ã‚¹ã‚¿ãƒ ãƒˆãƒ¼ãƒ³ (ã‚·ãƒ³ã‚»éŸ³) è¨­å®šã®ãƒªã‚¹ãƒŠãƒ¼ ğŸ¶
            const setupCustomToneListener = (inputEl, toneKey, propName) => {
                inputEl.addEventListener('change', (event) => {
                    const newValue = parseInt(event.target.value, 10);
                    if (isNaN(newValue)) return;
                    
                    const update = {};
                    update[toneKey] = {};
                    update[toneKey][propName] = newValue;

                    saveSettings({ customTones: update });
                });
            };

            setupCustomToneListener(customA_BaseFreq, 'custom_a', 'baseFreq');
            setupCustomToneListener(customA_ModFreq, 'custom_a', 'modFreq');
            setupCustomToneListener(customB_TempoMs, 'custom_b', 'tempoMs'); 

            // ğŸ”Š ã‚«ã‚¹ã‚¿ãƒ URLéŸ³æºã®ãƒªã‚¹ãƒŠãƒ¼ ğŸ”Š
            const handleUrlChange = (inputEl, statusEl, key) => {
                inputEl.addEventListener('change', (event) => {
                    const newUrl = event.target.value.trim();
                    statusEl.textContent = 'ãƒ­ãƒ¼ãƒ‰ä¸­...';
                    statusEl.classList.remove('text-green-500', 'text-red-500');
                    statusEl.classList.add('text-yellow-500');

                    const update = {};
                    update[key] = newUrl;
                    
                    // saveSettingsã‚’å‘¼ã³å‡ºã—ã¦CURRENT_SETTINGSã‚’æ›´æ–°ã—ã€localStorageã«ä¿å­˜
                    saveSettings({ customUrls: update }); 
                    
                    // URLãŒå¤‰æ›´ã•ã‚ŒãŸã‚‰éŸ³æºã®ãƒ­ãƒ¼ãƒ‰ã‚’è©¦ã¿ã‚‹
                    if (newUrl) {
                        loadAudioFromUrl(key, newUrl, statusEl);
                    } else {
                        audioBuffers[key] = null;
                        statusEl.textContent = 'æœªè¨­å®š';
                        statusEl.classList.remove('text-yellow-500', 'text-red-500');
                    }
                });
            };
            
            handleUrlChange(customUrlAInput, customUrlAStatus, 'custom_url_a');
            handleUrlChange(customUrlBInput, customUrlBStatus, 'custom_url_b');
            
            
            // éœ‡åº¦åˆ¥ã‚¢ãƒ©ãƒ¼ãƒ è¨­å®šã®ãƒˆã‚°ãƒ«æ©Ÿèƒ½
            toggleIntensityAlarm.addEventListener('click', () => {
                const isExpanded = intensityAlarmContent.classList.toggle('expanded');
                applyCollapsibleState(intensityAlarmContent, intensityAlarmIcon, isExpanded);
                saveSettings({ uiState: { isIntensityAlarmExpanded: isExpanded } });
            });

            // æ´¥æ³¢ã‚¢ãƒ©ãƒ¼ãƒ è¨­å®šã®ãƒˆã‚°ãƒ«æ©Ÿèƒ½
            toggleTsunamiAlarm.addEventListener('click', () => {
                const isExpanded = tsunamiAlarmContent.classList.toggle('expanded');
                applyCollapsibleState(tsunamiAlarmContent, tsunamiAlarmIcon, isExpanded);
                saveSettings({ uiState: { isTsunamiAlarmExpanded: isExpanded } });
            });

            // ã‚«ã‚¹ã‚¿ãƒ ã‚¢ãƒ©ãƒ¼ãƒ è¨­å®šã®ãƒˆã‚°ãƒ«æ©Ÿèƒ½
            customAlarmToggle.addEventListener('click', () => {
                const isExpanded = customAlarmContent.classList.toggle('expanded');
                applyCollapsibleState(customAlarmContent, customAlarmIcon, isExpanded);
                saveSettings({ uiState: { isCustomAlarmExpanded: isExpanded } });
            });

            // å±¥æ­´ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã®ãƒˆã‚°ãƒ«æ©Ÿèƒ½
            toggleHistoryButton.addEventListener('click', (e) => {
                if (e.target.id === 'clear-history') return; // å…¨æ¶ˆå»ãƒœã‚¿ãƒ³ã¯é™¤å¤–
                const isExpanded = historyContentEl.classList.toggle('expanded');
                applyCollapsibleState(historyContentEl, historyIconEl, isExpanded);
                saveSettings({ uiState: { isHistoryExpanded: isExpanded } });
            });
            
            // ãƒ†ã‚¹ãƒˆ/ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ã®ãƒˆã‚°ãƒ«æ©Ÿèƒ½
            toggleTestUtility.addEventListener('click', () => {
                const isExpanded = testUtilityContent.classList.toggle('expanded');
                applyCollapsibleState(testUtilityContent, testUtilityIcon, isExpanded);
                saveSettings({ uiState: { isTestUtilityExpanded: isExpanded } });
            });

            // è¨­å®šãƒ‘ãƒãƒ«ã®ãƒˆã‚°ãƒ«æ©Ÿèƒ½
            toggleSettingsButton.addEventListener('click', () => {
                const isHidden = testControls.classList.contains('-translate-x-full');
                if (isHidden) { // ãƒ‘ãƒãƒ«ãŒéš ã‚Œã¦ã„ã‚‹å ´åˆ â†’ é–‹ã
                    testControls.classList.remove('-translate-x-full');
                    toggleSettingsButton.textContent = 'â—€ è¨­å®š';
                    // ãƒœã‚¿ãƒ³ã‚’ãƒ‘ãƒãƒ«ã®å³ç«¯ã«ç§»å‹•ã•ã›ã‚‹
                    toggleSettingsButton.classList.remove('left-0', 'rounded-r-lg');
                    toggleSettingsButton.classList.add('left-[400px]', 'rounded-l-lg');
                } else { // ãƒ‘ãƒãƒ«ãŒè¡¨ç¤ºã•ã‚Œã¦ã„ã‚‹å ´åˆ â†’ é–‰ã˜ã‚‹
                    testControls.classList.add('-translate-x-full');
                    toggleSettingsButton.textContent = 'è¨­å®š â–¶';
                    // ãƒœã‚¿ãƒ³ã‚’å…ƒã®ä½ç½®ã«æˆ»ã™
                    toggleSettingsButton.classList.remove('left-[400px]', 'rounded-l-lg');
                    toggleSettingsButton.classList.add('left-0', 'rounded-r-lg');
                }
            });
            
            // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³çµ‚äº†æ™‚ã«ãƒ†ãƒ­ãƒƒãƒ—ã‚’éè¡¨ç¤ºã«ã™ã‚‹ãƒªã‚¹ãƒŠãƒ¼
            tickerContent.addEventListener('animationend', () => {
                quakeTickerArea.style.display = 'none';
                tickerContent.style.animationName = 'none'; // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ãƒªã‚»ãƒƒãƒˆ
                console.log('åœ°éœ‡æƒ…å ±ãƒ†ãƒ­ãƒƒãƒ—ãŒå®Œå…¨ã«ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã‚¢ã‚¦ãƒˆã—ã¾ã—ãŸã€‚');
            });

            // å±¥æ­´ã‚¯ãƒªã‚¢ãƒœã‚¿ãƒ³ã®ãƒªã‚¹ãƒŠãƒ¼
            clearHistoryButton.addEventListener('click', () => {
                receivedHistory = [];
                localStorage.removeItem(HISTORY_STORAGE_KEY); // LocalStorageã‹ã‚‰ã‚‚å‰Šé™¤
                renderHistoryList(); // UIã‚’æ›´æ–°
            });


            // AudioContextã‚’åˆæœŸåŒ–
            initializeAudioContext();
        }

        /**
         * ğŸ”ŠğŸ–¼ï¸ ã‚¢ã‚»ãƒƒãƒˆï¼ˆéŸ³å£°ãƒ»ç”»åƒï¼‰ã‚’ãƒ—ãƒªãƒ­ãƒ¼ãƒ‰ã™ã‚‹
         */
        function preloadAssets() {
            console.log('ã‚¢ã‚»ãƒƒãƒˆã®ãƒ—ãƒªãƒ­ãƒ¼ãƒ‰ã‚’é–‹å§‹ã—ã¾ã™...');

            // 1. éŸ³å£°ãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒ—ãƒªãƒ­ãƒ¼ãƒ‰
            // ç¾åœ¨ã®è¨­å®šï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ã‚’å«ã‚€ï¼‰ã«åŸºã¥ã„ã¦ã€ã™ã¹ã¦ã®URLéŸ³æºã®èª­ã¿è¾¼ã¿ã‚’é–‹å§‹ã—ã¾ã™ã€‚
            loadAllCustomUrls();

            // 2. ç”»åƒãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒ—ãƒªãƒ­ãƒ¼ãƒ‰
            // æ´¥æ³¢è­¦å ±ã‚¢ã‚¤ã‚³ãƒ³ã‚’äº‹å‰ã«èª­ã¿è¾¼ã‚“ã§ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã•ã›ã¾ã™ã€‚
            const tsunamiIconUrl = 'https://github.com/AfterEffects-OK/EarthquakeEarlyWarning/blob/main/TsunamiHazardSign.svg.png?raw=true';
            const tsunamiIcon = new Image();
            tsunamiIcon.src = tsunamiIconUrl;
            tsunamiIcon.onload = () => {
                console.log('æ´¥æ³¢ã‚¢ã‚¤ã‚³ãƒ³ç”»åƒã®ãƒ—ãƒªãƒ­ãƒ¼ãƒ‰ãŒå®Œäº†ã—ã¾ã—ãŸã€‚');
            };
            tsunamiIcon.onerror = () => {
                console.error('æ´¥æ³¢ã‚¢ã‚¤ã‚³ãƒ³ç”»åƒã®ãƒ—ãƒªãƒ­ãƒ¼ãƒ‰ã«å¤±æ•—ã—ã¾ã—ãŸã€‚');
            };
        }

        /** å±¥æ­´ãƒªã‚¹ãƒˆã‚’UIã«æç”»ã™ã‚‹ */
        function renderHistoryList() {
            historyListEl.innerHTML = ''; // ãƒªã‚¹ãƒˆã‚’ã‚¯ãƒªã‚¢
            
            receivedHistory.slice().reverse().forEach(item => { // æ–°ã—ã„ã‚‚ã®ãŒä¸‹ã«è¡¨ç¤ºã•ã‚Œã‚‹ã‚ˆã†ã«é€†é †ã«ã™ã‚‹
                const li = document.createElement('li');
                li.className = `history-item ${item.displayed ? 'displayed' : 'skipped'}`;
                
                // ç™ºç”Ÿæ—¥æ™‚ã‚’å¹´æœˆæ—¥æ™‚åˆ†ç§’ã§è¡¨ç¤º
                const timeStr = new Date(item.time).toLocaleString('ja-JP', { hour: '2-digit', minute: '2-digit', second: '2-digit' });
                const displayStatus = item.displayed ? 'è¡¨ç¤º' : 'ã‚¹ã‚­ãƒƒãƒ—';
                
                let infoText = '';
                if (item.type === 'EEW') {
                    infoText = `[EEW] éœ‡åº¦: ${item.maxIntText} | éœ‡æº: ${item.epicenter}`;
                } else if (item.type === 'QuakeInfo') {
                    infoText = `[åœ°éœ‡æƒ…å ±] éœ‡åº¦: ${item.maxIntText} | éœ‡æº: ${item.epicenter}`;
                } else if (item.type === 'TsunamiInfo') {
                    // æ´¥æ³¢æƒ…å ±ã®å ´åˆã‚‚å†…å®¹ã‚’è¡¨ç¤º
                    infoText = `[æ´¥æ³¢æƒ…å ±] ${item.epicenter}`; // epicenterã«ãƒ†ã‚­ã‚¹ãƒˆãŒå…¥ã£ã¦ã„ã‚‹
                }

                li.innerHTML = `
                    <div class="flex justify-between items-center text-white">
                        <span class="font-semibold">${timeStr}</span>
                        <span class="font-bold text-xs px-1.5 py-0.5 rounded ${item.displayed ? 'bg-green-600' : 'bg-yellow-600'}">${displayStatus}</span>
                    </div>
                    <p class="text-gray-300 mt-0.5">${infoText}</p>
                `;
                historyListEl.prepend(li); // æ–°ã—ã„é …ç›®ã‚’ãƒªã‚¹ãƒˆã®å…ˆé ­ã«è¿½åŠ 
            });
        }

        /** å±¥æ­´ãƒ‡ãƒ¼ã‚¿ã‚’è¿½åŠ ã™ã‚‹ */
        function addHistoryItem(item) {
            receivedHistory.unshift(item); // æ–°ã—ã„ã‚‚ã®ã‚’å…ˆé ­ã«è¿½åŠ 
            if (receivedHistory.length > MAX_HISTORY_COUNT) {
                receivedHistory.pop(); // ä¸Šé™ã‚’è¶…ãˆãŸã‚‰å¤ã„ã‚‚ã®ã‚’å‰Šé™¤
            }
            renderHistoryList(); // UIã‚’æ›´æ–°
        }

        /** å±¥æ­´ã‚’LocalStorageã«ä¿å­˜ã™ã‚‹ */
        function saveHistoryToLocalStorage() {
            try {
                localStorage.setItem(HISTORY_STORAGE_KEY, JSON.stringify(receivedHistory));
            } catch (e) {
                console.error('å±¥æ­´ã®ä¿å­˜ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ:', e);
            }
        }

        /** LocalStorageã‹ã‚‰å±¥æ­´ã‚’ãƒ­ãƒ¼ãƒ‰ã™ã‚‹ */
        function loadHistoryFromLocalStorage() {
            try {
                const savedHistory = localStorage.getItem(HISTORY_STORAGE_KEY);
                if (savedHistory) {
                    receivedHistory = JSON.parse(savedHistory);
                    console.log('å±¥æ­´ã‚’LocalStorageã‹ã‚‰ãƒ­ãƒ¼ãƒ‰ã—ã¾ã—ãŸã€‚');
                }
            } catch (e) {
                console.error('å±¥æ­´ã®ãƒ­ãƒ¼ãƒ‰ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ:', e);
                receivedHistory = [];
            }
            renderHistoryList(); // ãƒ­ãƒ¼ãƒ‰ã—ãŸå±¥æ­´ã‚’UIã«åæ˜ 
        }

        // ----------------------------------------------------
        // ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£é–¢æ•°
        // ----------------------------------------------------
        function intensityToJma(num) {
            if (num < 10) return '1æœªæº€'; // éœ‡åº¦1æœªæº€ã®åˆ¤å®šã‚’è¿½åŠ 
            const map = {
                10: '1', 20: '2', 30: '3', 40: '4', 45: '5å¼±',
                50: '5å¼·', 55: '6å¼±', 60: '6å¼·', 70: '7'
            };
            return map[num] || 'ä¸æ˜'; // 10ä»¥ä¸Šã§ãƒãƒƒãƒ—ã«ãªã„å ´åˆã¯ä¸æ˜
        }
        
        /**
         * ğŸš¨ åœ°éœ‡æƒ…å ±ãƒ†ãƒ­ãƒƒãƒ—ã®å¥èª­ç‚¹ã‚’ã‚¹ãƒšãƒ¼ã‚¹ã«å¤‰æ›ã™ã‚‹
         * @param {string} text - å¤‰æ›å¯¾è±¡ã®ãƒ†ã‚­ã‚¹ãƒˆ
         * @returns {string} å¥èª­ç‚¹ã‚’ã‚¹ãƒšãƒ¼ã‚¹ã«ç½®æ›ã—ãŸãƒ†ã‚­ã‚¹ãƒˆ
         */
        function formatTickerText(text) {
            // å¥ç‚¹(ã€‚)ã‚’å…¨è§’ã‚¹ãƒšãƒ¼ã‚¹(ã€€)ã«ç½®æ›
            let formattedText = text.replace(/ã€‚/g, 'ã€€');
            // èª­ç‚¹(ã€)ã‚’åŠè§’ã‚¹ãƒšãƒ¼ã‚¹( )ã«ç½®æ›
            formattedText = formattedText.replace(/ã€/g, ' ');
            return formattedText;
        }

        /** è­¦å‘Šè¡¨ç¤ºã‚’éè¡¨ç¤ºã«ã™ã‚‹ */
        function hideAlert() {
            const alerts = document.querySelectorAll('.eew-alert');
            alerts.forEach(alert => {
                const serial = alert.getAttribute('data-eew-serial');
                if (serial && activeAlertTimers[serial]) {
                    clearTimeout(activeAlertTimers[serial]);
                    delete activeAlertTimers[serial];
                }
                alert.remove();
            });
            
            // ãƒ†ãƒ­ãƒƒãƒ—ã‚‚å¼·åˆ¶éè¡¨ç¤º
            if (quakeTickerArea.style.display !== 'none') {
                quakeTickerArea.style.display = 'none';
                tickerContent.style.animationName = 'none';
                console.log('åœ°éœ‡æƒ…å ±ãƒ†ãƒ­ãƒƒãƒ—ã‚‚å¼·åˆ¶éè¡¨ç¤ºã«ã—ã¾ã—ãŸã€‚');
            }
            
            // ğŸŒŠ æ´¥æ³¢è­¦å ±ã®çŠ¶æ…‹ã‚‚ãƒªã‚»ãƒƒãƒˆã™ã‚‹
            hideTsunamiTicker();

            console.log('è¡¨ç¤ºä¸­ã®å…¨ã¦ã®ã‚¢ãƒ©ãƒ¼ãƒˆã‚’éè¡¨ç¤ºã«ã—ã¾ã—ãŸã€‚');
        }
        
        /** ğŸš¨ EEWã®ã‚¢ãƒ©ãƒ¼ãƒˆãŒã‚¿ã‚¤ãƒãƒ¼ã§æ¶ˆãˆãŸå¾Œã«ãƒ†ãƒ­ãƒƒãƒ—è¡¨ç¤ºã‚’ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ã™ã‚‹ ğŸš¨ */
        function scheduleQuakeTickerAfterEEW(maxInt) {
            // æ—¢ã«ãƒ†ãƒ­ãƒƒãƒ—ãŒè¡¨ç¤ºä¸­ã§ã€ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ãŒå‹•ã„ã¦ã„ã‚‹å ´åˆã¯ä½•ã‚‚ã—ãªã„ï¼ˆ552ãŒæ—¢ã«åˆ°ç€ã—ã¦ã„ã‚‹å¯èƒ½æ€§ï¼‰
            if (quakeTickerArea.style.display !== 'none' && tickerContent.style.animationPlayState === 'running') {
                console.log("EEWçµ‚äº†æ™‚: ãƒ†ãƒ­ãƒƒãƒ—ã¯æ—¢ã«è¡¨ç¤ºä¸­ï¼ˆP2P 552ãƒ‡ãƒ¼ã‚¿ã‚’å—ä¿¡æ¸ˆã¿ï¼‰ã®ãŸã‚ã€æ±ç”¨ãƒ†ãƒ­ãƒƒãƒ—ã¯ã‚¹ã‚­ãƒƒãƒ—ã—ã¾ã™ã€‚");
                return;
            }
            
            // ğŸš¨ ä¿®æ­£: éœ‡åº¦ã«å¿œã˜ã¦ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å¤‰æ›´
            const shakeDescription = maxInt >= 45 ? 'å¼·ã„æºã‚Œ' : 'æºã‚Œ';
            // æ±ç”¨ãƒ†ãƒ­ãƒƒãƒ—ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ç”Ÿæˆ
            const time = new Date().toLocaleTimeString('ja-JP', {hour: '2-digit', minute:'2-digit'});
            const genericMessage = `ğŸš¨ã€åœ°éœ‡ç™ºç”Ÿã€‘${time}é ƒã€${shakeDescription}ã‚’è¦³æ¸¬ã—ã¾ã—ãŸã€‚åœ°éœ‡ã®è©³ç´°æƒ…å ±ã¯ç¶šå ±ã‚’ãŠå¾…ã¡ãã ã•ã„ã€‚ ğŸš¨`;

            // showQuakeTicker ã«æ±ç”¨ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’æ¸¡ã™ (P2Pãƒ‡ãƒ¼ã‚¿æ§‹é€ ã®ä»£ã‚ã‚Šã«rawMessageã‚’ä¿æŒã™ã‚‹ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã¨ã—ã¦æ¸¡ã™)
            showQuakeTicker({ rawMessage: genericMessage });
            console.log("EEWçµ‚äº†æ™‚: æ±ç”¨åœ°éœ‡æƒ…å ±ãƒ†ãƒ­ãƒƒãƒ—ã®è¡¨ç¤ºã‚’é–‹å§‹ã—ã¾ã—ãŸã€‚");
        }

        /**
         * ğŸŒŠ æ´¥æ³¢è­¦å ±ãƒ†ãƒ­ãƒƒãƒ—ã®è¡¨ç¤ºã¨ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³è¨­å®š ğŸŒŠ
         */
        function showTsunamiTicker() {
            if (!activeTsunamiInfo) return; // è¡¨ç¤ºã™ã¹ãæƒ…å ±ãŒãªã‘ã‚Œã°ä½•ã‚‚ã—ãªã„

            const formattedMessage = `ğŸŒŠ ${formatTickerText(activeTsunamiInfo)} ğŸŒŠ`;

            // ãƒ†ãƒ­ãƒƒãƒ—ã‚¨ãƒªã‚¢ã®ã‚¹ã‚¿ã‚¤ãƒ«ã‚’æ´¥æ³¢ç”¨ã«å¤‰æ›´
            quakeTickerArea.style.backgroundColor = 'rgba(15, 76, 129, 0.95)'; // æ¿ƒã„é’
            quakeTickerArea.style.borderColor = '#60a5fa'; // æ˜ã‚‹ã„é’

            tickerContent.textContent = formattedMessage + ' '.repeat(10);
            quakeTickerArea.style.display = 'flex';

            const viewportWidth = quakeTickerArea.offsetWidth;
            const contentWidth = tickerContent.scrollWidth;
            const totalDistance = viewportWidth + contentWidth;
            const baseSpeed = viewportWidth / CURRENT_SETTINGS.quakeDuration;
            const totalDuration = totalDistance / baseSpeed;

            tickerContent.style.animationName = 'none';
            void tickerContent.offsetWidth;

            tickerContent.style.setProperty('--scroll-distance', `-${totalDistance}px`);
            tickerContent.style.animationDuration = `${totalDuration}s`;
            tickerContent.style.animationIterationCount = 'infinite'; // â˜…ç¹°ã‚Šè¿”ã—è¡¨ç¤º
            tickerContent.style.animationName = 'ticker-scroll';
            tickerContent.style.animationPlayState = 'running';

            console.log(`æ´¥æ³¢è­¦å ±ãƒ†ãƒ­ãƒƒãƒ—ã‚’è¡¨ç¤ºã—ã¾ã™: ${activeTsunamiInfo}`);
        }

        /** æ´¥æ³¢è­¦å ±ãƒ†ãƒ­ãƒƒãƒ—ã‚’éè¡¨ç¤ºã«ã™ã‚‹ */
        function hideTsunamiTicker() {
            if (!activeTsunamiInfo) return; // æ—¢ã«éè¡¨ç¤ºãªã‚‰ä½•ã‚‚ã—ãªã„

            activeTsunamiInfo = null; // æ´¥æ³¢è­¦å ±çŠ¶æ…‹ã‚’è§£é™¤

            // ãƒ†ãƒ­ãƒƒãƒ—ãŒæ´¥æ³¢ç”¨ã®å ´åˆã®ã¿éè¡¨ç¤ºå‡¦ç†ã‚’è¡Œã†
            if (quakeTickerArea.style.backgroundColor.startsWith('rgba(15, 76, 129')) {
                quakeTickerArea.style.display = 'none';
                tickerContent.style.animationName = 'none';
                tickerContent.style.animationIterationCount = '1'; // ç¹°ã‚Šè¿”ã—ã‚’ãƒªã‚»ãƒƒãƒˆ

                // ãƒ†ãƒ­ãƒƒãƒ—ã‚¨ãƒªã‚¢ã®ã‚¹ã‚¿ã‚¤ãƒ«ã‚’ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆï¼ˆåœ°éœ‡æƒ…å ±ç”¨ï¼‰ã«æˆ»ã™
                quakeTickerArea.style.backgroundColor = 'rgba(179, 11, 11, 0.95)';
                quakeTickerArea.style.borderColor = 'rgb(255, 255, 255)';
                console.log('æ´¥æ³¢è­¦å ±ãƒ†ãƒ­ãƒƒãƒ—ã‚’éè¡¨ç¤ºã«ã—ã¾ã—ãŸã€‚');
            }
        }

        let activeAlertTimers = {}; // EEWã‚·ãƒªã‚¢ãƒ«ç•ªå·ã¨ã‚¿ã‚¤ãƒãƒ¼IDã‚’ä¿æŒ

        /** è­¦å‘Šã®ã‚¿ã‚¤ãƒãƒ¼ã‚’è¨­å®šã™ã‚‹ (EEW/æ´¥æ³¢) */
        function setupAlertTimer(element, dataType, serial, maxInt) {
            // æ—¢å­˜ã‚¿ã‚¤ãƒãƒ¼ãŒã‚ã‚Œã°ã‚¯ãƒªã‚¢
            if (activeAlertTimers[serial]) {
                clearTimeout(activeAlertTimers[serial]);
                delete activeAlertTimers[serial];
            }

            const duration = CURRENT_SETTINGS.eewDuration;

            if (duration > 0) {
                const timer = setTimeout(() => {
                    // ã‚¢ãƒ©ãƒ¼ãƒˆãŒæ¶ˆãˆã‚‹ã‚¿ã‚¤ãƒŸãƒ³ã‚°ã§å¾Œç¶šå‡¦ç†ã‚’å®Ÿè¡Œ
                    if (dataType === 'EEW') { // ğŸš¨ ä¿®æ­£: éœ‡åº¦æƒ…å ±ã‚’æ¸¡ã™
                        scheduleQuakeTickerAfterEEW(maxInt);
                    } else if (dataType === 'TsunamiInfo') {
                        // æ´¥æ³¢ã‚¢ãƒ©ãƒ¼ãƒˆãŒæ¶ˆãˆãŸã‚‰ã€è©³ç´°ãƒ†ãƒ­ãƒƒãƒ—ã‚’é–‹å§‹
                        showTsunamiTicker();
                    }
                    
                    element.remove();
                    delete activeAlertTimers[serial];
                    console.log(`ã‚¢ãƒ©ãƒ¼ãƒˆ ${serial} ã‚’ã‚¿ã‚¤ãƒãƒ¼ã§éè¡¨ç¤ºã«ã—ã¾ã—ãŸã€‚`);
                }, duration * 1000);
                activeAlertTimers[serial] = timer;
            }
        }
        
        /** * åœ°éœ‡æƒ…å ±ãƒ†ãƒ­ãƒƒãƒ—ã®è¡¨ç¤ºã¨ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³è¨­å®š 
         * @param {Object} data - P2P Quakeã®552ãƒ‡ãƒ¼ã‚¿ã€ã¾ãŸã¯{ rawMessage: string }ã‚’æŒã¤ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ
         */
        function showQuakeTicker(data) {
            let wasTsunamiTickerActive = false;
            // æ—¢ã«ä½•ã‚‰ã‹ã®ãƒ†ãƒ­ãƒƒãƒ—ãŒè¡¨ç¤ºä¸­ã®å ´åˆã€ãã‚Œã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã—ã¦æ–°ã—ã„æƒ…å ±ã§ä¸Šæ›¸ãã™ã‚‹
            if (quakeTickerArea.style.display === 'flex') {
                console.log('è¡¨ç¤ºä¸­ã®ãƒ†ãƒ­ãƒƒãƒ—ã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã—ã€æ–°ã—ã„åœ°éœ‡æƒ…å ±ã«æ›´æ–°ã—ã¾ã™ã€‚');
                
                // æ´¥æ³¢ãƒ†ãƒ­ãƒƒãƒ—ãŒè¡¨ç¤ºã•ã‚Œã¦ã„ã‚‹å¯èƒ½æ€§ã‚‚è€ƒæ…®ã—ã€çŠ¶æ…‹ã¨ã‚¹ã‚¿ã‚¤ãƒ«ã‚’ãƒªã‚»ãƒƒãƒˆã™ã‚‹
                if (activeTsunamiInfo) {
                    wasTsunamiTickerActive = true;
                    hideTsunamiTicker();
                }

                // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã‚’å¼·åˆ¶çš„ã«ãƒªã‚»ãƒƒãƒˆ
                tickerContent.style.animationName = 'none';
                void tickerContent.offsetWidth; // DOMã®å†æç”»ã‚’å¼·åˆ¶
            }

            // ğŸš¨ ä¿®æ­£: æ±ç”¨ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã§ãªã„å ´åˆã€æœ€ä½éœ‡åº¦ã‚’ãƒã‚§ãƒƒã‚¯ã™ã‚‹
            if (!data.rawMessage) {
                const maxInt = data.earthquake?.maxScale || 0;
                if (maxInt < CURRENT_SETTINGS.minIntensityScaleTicker) {
                    console.log(`ãƒ†ãƒ­ãƒƒãƒ—è¡¨ç¤ºã‚’ã‚¹ã‚­ãƒƒãƒ—ã—ã¾ã—ãŸã€‚æœ€å¤§éœ‡åº¦ ${intensityToJma(maxInt)} ãŒè¨­å®šã•ã‚ŒãŸæœ€ä½éœ‡åº¦ ${intensityToJma(CURRENT_SETTINGS.minIntensityScaleTicker)} æœªæº€ã§ã™ã€‚`);
                    return;
                }
            }

            // æ´¥æ³¢è­¦å ±ãŒç™ºä»¤ä¸­ã®å ´åˆã¯ã€åœ°éœ‡æƒ…å ±ãƒ†ãƒ­ãƒƒãƒ—ã‚’è¡¨ç¤ºã—ãªã„
            if (activeTsunamiInfo && !wasTsunamiTickerActive) {
                console.log('æ´¥æ³¢è­¦å ±ãŒæœ‰åŠ¹ãªãŸã‚ã€åœ°éœ‡æƒ…å ±ãƒ†ãƒ­ãƒƒãƒ—ã®è¡¨ç¤ºã‚’ã‚¹ã‚­ãƒƒãƒ—ã—ã¾ã—ãŸã€‚');
                return;
            }
            
            let rawMessage;
            
            // æ±ç”¨ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒæ¸¡ã•ã‚ŒãŸå ´åˆï¼ˆEEWã‚¿ã‚¤ãƒãƒ¼çµ‚äº†æ™‚ï¼‰
            if (data.rawMessage) {
                rawMessage = data.rawMessage;
            } else {
                // P2P 552ãƒ‡ãƒ¼ã‚¿ãŒæ¸¡ã•ã‚ŒãŸå ´åˆï¼ˆé€šå¸¸ - processAlertDataã‹ã‚‰ï¼‰
                const time = new Date(data.earthquake.time || Date.now()).toLocaleTimeString('ja-JP', {hour: '2-digit', minute:'2-digit'});
                const maxIntText = intensityToJma(data.earthquake?.maxScale || 0);
                const epicenter = data.earthquake.hypocenter?.name || 'ä¸æ˜';
                const magnitude = data.earthquake?.magnitude || 'ä¸æ˜';
                const depth = data.earthquake.hypocenter?.depth ? `${data.earthquake.hypocenter.depth}km` : 'ä¸æ˜';

                rawMessage = `ğŸš¨ã€åœ°éœ‡æƒ…å ±ã€‘${time}é ƒç™ºç”Ÿ | éœ‡æºåœ°: ${epicenter} (éœ‡æºã®æ·±ã•: ${depth}) | åœ°éœ‡ã®è¦æ¨¡(M): ${magnitude} | æœ€å¤§éœ‡åº¦: ${maxIntText} ğŸš¨`;
            }
            
            const secondsPerScreen = CURRENT_SETTINGS.quakeDuration; // ç”»é¢å¹…ã‚’ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã™ã‚‹ã®ã«ã‹ã‹ã‚‹æ™‚é–“

            // å¥èª­ç‚¹ã‚’ã‚¹ãƒšãƒ¼ã‚¹ã«ç½®æ›
            const formattedMessage = formatTickerText(rawMessage);

            // ãƒ†ãƒ­ãƒƒãƒ—ã‚¨ãƒªã‚¢ã®æ›´æ–°
            tickerContent.textContent = formattedMessage + ' '.repeat(5); // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®æœ€å¾Œã«ã‚ãšã‹ãªã‚¹ãƒšãƒ¼ã‚¹ã‚’è¿½åŠ 
            
            // ç¢ºå®Ÿã«å¹…ã‚’å–å¾—ã™ã‚‹ãŸã‚ã€displayã‚’flexã«å¤‰æ›´ã—ã¦ã‹ã‚‰å¹…ã‚’å–å¾—
            quakeTickerArea.style.display = 'flex'; 
            
            // ç”»é¢å¹…ã¨ã‚³ãƒ³ãƒ†ãƒ³ãƒ„å¹…ã‚’å–å¾—
            const viewportWidth = quakeTickerArea.offsetWidth;
            // scrollWidthã¯ãƒ‘ãƒ‡ã‚£ãƒ³ã‚°ã‚’å«ã‚€è¦ç´ ã®å…¨ã‚³ãƒ³ãƒ†ãƒ³ãƒ„å¹…
            const contentWidth = tickerContent.scrollWidth; 
            
            // ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«é€Ÿåº¦ã®åŸºæº–
            const baseSpeed = viewportWidth / secondsPerScreen; 

            // ãƒ†ãƒ­ãƒƒãƒ—å…¨ä½“ï¼ˆç”»é¢å¹… + ã‚³ãƒ³ãƒ†ãƒ³ãƒ„å¹…ï¼‰ã‚’ç§»å‹•ã™ã‚‹ã®ã«ã‹ã‹ã‚‹æ™‚é–“ï¼ˆç§’ï¼‰
            const totalDistance = viewportWidth + contentWidth; 
            const totalDuration = totalDistance / baseSpeed;

            // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ãƒªã‚»ãƒƒãƒˆã—ã€é€Ÿåº¦ã‚’è¨­å®š
            tickerContent.style.animationName = 'none'; // ä¸€åº¦ãƒªã‚»ãƒƒãƒˆ
            // DOMã«å†æç”»ã‚’å¼·åˆ¶ã—ã€ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã‚’å†åº¦é©ç”¨
            void tickerContent.offsetWidth; 
            
            // CSSå¤‰æ•°ã«ç§»å‹•è·é›¢ã‚’è¨­å®š
            tickerContent.style.setProperty('--scroll-distance', `-${totalDistance}px`);
            
            // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã®ç¶™ç¶šæ™‚é–“ã¨å†ç”ŸçŠ¶æ…‹ã‚’è¨­å®š
            tickerContent.style.animationDuration = `${totalDuration}s`;
            tickerContent.style.animationIterationCount = '2'; // 2å›ãƒ«ãƒ¼ãƒ—è¡¨ç¤º
            tickerContent.style.animationName = 'ticker-scroll'; // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã‚’å†é©ç”¨
            tickerContent.style.animationPlayState = 'running';

            console.log(`åœ°éœ‡æƒ…å ±ãƒ†ãƒ­ãƒƒãƒ—ã‚’è¡¨ç¤ºã—ã¾ã™ã€‚ã‚³ãƒ³ãƒ†ãƒ³ãƒ„å¹…: ${contentWidth.toFixed(0)}px, ç”»é¢å¹…: ${viewportWidth.toFixed(0)}pxã€‚é€Ÿåº¦: ${baseSpeed.toFixed(0)}px/sã€ç·ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³æ™‚é–“: ${totalDuration.toFixed(1)}ç§’ã€‚`);

        }


        // ----------------------------------------------------
        // ğŸ”Š ã‚¢ãƒ©ãƒ¼ãƒ éŸ³æ©Ÿèƒ½ ğŸ”Š
        // ----------------------------------------------------
        let audioContext = null; 
        let audioBuffers = {}; // ğŸ”Š URLéŸ³æºã®ã‚­ãƒ£ãƒƒã‚·ãƒ¥ ğŸ”Š
        
        function initializeAudioContext() {
            if (audioContext && audioContext.state === 'running') return;
            if (audioContext && audioContext.state === 'suspended') {
                 audioContext.resume().catch(e => console.error("AudioContextã®å†é–‹ã‚¨ãƒ©ãƒ¼:", e));
                 return;
            }
            
            if (!audioContext) {
                try {
                    // Safariäº’æ›æ€§ã®ãŸã‚ã«webkitAudioContextã‚‚è€ƒæ…®
                    audioContext = new (window.AudioContext || window.webkitAudioContext)();
                    console.log('AudioContextã‚’åˆæœŸåŒ–ã—ã¾ã—ãŸã€‚');
                } catch (e) {
                    console.error('AudioContextã®åˆæœŸåŒ–ã«å¤±æ•—ã—ã¾ã—ãŸ:', e);
                }
            }
        }
        
        /**
         * ğŸ”Š URLã‹ã‚‰éŸ³æºã‚’ãƒ­ãƒ¼ãƒ‰ã—ã€ãƒ‡ã‚³ãƒ¼ãƒ‰ã—ã¦ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã™ã‚‹ ğŸ”Š
         * @param {string} urlKey - custom_url_a ã¾ãŸã¯ custom_url_b
         * @param {string} url - éŸ³æºã®URL
         * @param {HTMLElement} statusEl - ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è¡¨ç¤ºç”¨ã®DOMè¦ç´ 
         */
        async function loadAudioFromUrl(urlKey, url, statusEl) {
            if (!audioContext || !url) return;
            
            // URLãŒè¨­å®šã•ã‚Œã¦ã„ãªã„å ´åˆã¯ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’ã‚¯ãƒªã‚¢
            if (!url) {
                audioBuffers[urlKey] = null;
                if (statusEl) {
                    statusEl.textContent = 'æœªè¨­å®š';
                    statusEl.className = 'loading-status text-yellow-500';
                }
                return;
            }

            try {
                if (statusEl) {
                    statusEl.textContent = 'ãƒ­ãƒ¼ãƒ‰ä¸­...';
                    statusEl.className = 'loading-status text-yellow-500';
                }
                
                // Exponential Backoffã‚’ä½¿ç”¨ã—ãŸãƒªãƒˆãƒ©ã‚¤ãƒ­ã‚¸ãƒƒã‚¯
                const MAX_RETRIES = 3;
                let response = null;
                for (let i = 0; i < MAX_RETRIES; i++) {
                    try {
                        response = await fetch(url, { mode: 'cors' });
                        if (response.ok) break; // æˆåŠŸã—ãŸã‚‰ãƒ«ãƒ¼ãƒ—ã‚’æŠœã‘ã‚‹
                        // HTTPã‚¨ãƒ©ãƒ¼ã§ã‚‚404/403ã®å ´åˆã¯ãƒªãƒˆãƒ©ã‚¤ã—ã¦ã‚‚ç„¡é§„ãªã®ã§ã€ãƒªãƒˆãƒ©ã‚¤ã—ãªã„
                        if (response.status === 404 || response.status === 403) {
                             throw new Error(`HTTPã‚¨ãƒ©ãƒ¼: ${response.status}`);
                        }
                        // ãã®ä»–ã®ã‚¨ãƒ©ãƒ¼ (ä¾‹: 5xx, ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆãªã©) ã®å ´åˆã¯ãƒªãƒˆãƒ©ã‚¤
                        await new Promise(resolve => setTimeout(resolve, Math.pow(2, i) * 1000));
                        console.log(`ãƒªãƒˆãƒ©ã‚¤ ${i + 1}/${MAX_RETRIES}: URL ${urlKey} ã®ãƒ­ãƒ¼ãƒ‰ã‚’å†è©¦è¡Œã—ã¾ã™ã€‚`);
                    } catch (e) {
                        if (e.message.includes('404') || e.message.includes('403')) {
                            throw e; // 404/403ã¯å³åº§ã«ã‚¨ãƒ©ãƒ¼ã¨ã™ã‚‹
                        }
                        if (i === MAX_RETRIES - 1) throw e; // æœ€å¾Œã®è©¦è¡Œã§ã‚¨ãƒ©ãƒ¼ãªã‚‰ã‚¹ãƒ­ãƒ¼
                    }
                }
                
                if (!response || !response.ok) {
                    throw new Error(`HTTPã‚¨ãƒ©ãƒ¼: ${response ? response.status : 'ä¸æ˜ãªã‚¨ãƒ©ãƒ¼'}`);
                }
                
                const arrayBuffer = await response.arrayBuffer();
                const audioBuffer = await audioContext.decodeAudioData(arrayBuffer);

                audioBuffers[urlKey] = audioBuffer;
                
                if (statusEl) {
                    statusEl.textContent = `ãƒ­ãƒ¼ãƒ‰æˆåŠŸ (${(audioBuffer.duration).toFixed(1)}ç§’)`;
                    statusEl.className = 'loading-status text-green-500';
                }
                console.log(`éŸ³æº ${urlKey} ã‚’æ­£å¸¸ã«ãƒ­ãƒ¼ãƒ‰ã—ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã—ã¾ã—ãŸã€‚`);
            } catch (error) {
                audioBuffers[urlKey] = null;
                if (statusEl) {
                    statusEl.textContent = 'ãƒ­ãƒ¼ãƒ‰å¤±æ•— (CORS/URLã‚¨ãƒ©ãƒ¼)';
                    statusEl.className = 'loading-status text-red-500';
                }
                console.error(`éŸ³æº ${urlKey} ã®ãƒ­ãƒ¼ãƒ‰ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ:`, error);
                console.warn("CORSã‚¨ãƒ©ãƒ¼ã¾ãŸã¯ç„¡åŠ¹ãªURLã®å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚ã‚µãƒ¼ãƒãƒ¼å´ã§ 'Access-Control-Allow-Origin: *' ãŒè¨­å®šã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèªã—ã¦ãã ã•ã„ã€‚");
            }
        }

        /**
         * ãƒšãƒ¼ã‚¸ãƒ­ãƒ¼ãƒ‰æ™‚ã¾ãŸã¯è¨­å®šãƒ­ãƒ¼ãƒ‰æ™‚ã«å…¨ã¦ã®ã‚«ã‚¹ã‚¿ãƒ URLéŸ³æºã‚’ãƒ­ãƒ¼ãƒ‰ã™ã‚‹
         */
        function loadAllCustomUrls() {
            const urls = CURRENT_SETTINGS.customUrls;
            const statusMap = {
                'custom_url_a': customUrlAStatus,
                'custom_url_b': customUrlBStatus
            };
            const tsunamiUrls = CURRENT_SETTINGS.tsunamiSoundUrls;
            const tsunamiStatusMap = {
                'major': tsunamiUrlMajorStatus,
                'warning': tsunamiUrlWarningStatus,
                'advisory': tsunamiUrlAdvisoryStatus,
                'cancelled': tsunamiUrlCancelledStatus
            };

            // æ´¥æ³¢å°‚ç”¨URLã®ãƒ­ãƒ¼ãƒ‰
            for (const key in tsunamiUrls) {
                const url = tsunamiUrls[key];
                const statusEl = tsunamiStatusMap[key];
                if (url) {
                    loadAudioFromUrl(`tsunami_${key}`, url, statusEl);
                } else if (statusEl) {
                    statusEl.textContent = 'æœªè¨­å®š';
                }
            }

            for (const key in urls) {
                const url = urls[key];
                const statusEl = statusMap[key];
                // URLãŒè¨­å®šã•ã‚Œã¦ã„ã‚‹å ´åˆã®ã¿ãƒ­ãƒ¼ãƒ‰ã‚’è©¦ã¿ã‚‹
                if (url) {
                    loadAudioFromUrl(key, url, statusEl);
                } else {
                    // URLãŒç©ºã®å ´åˆã¯ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’ãƒªã‚»ãƒƒãƒˆ
                    if (statusEl) {
                        statusEl.textContent = 'æœªè¨­å®š';
                        statusEl.className = 'loading-status text-yellow-500';
                    }
                }
            }
        }

        
        /**
         * éœ‡åº¦ã«å¿œã˜ã¦é¸æŠã•ã‚ŒãŸã‚¢ãƒ©ãƒ¼ãƒ éŸ³ã‚’å†ç”Ÿã™ã‚‹
         * @param {number} maxInt - äºˆæƒ³æœ€å¤§éœ‡åº¦ (JMA Scale 10-70)
         */
        function playAlarmForIntensity(maxInt) {
            
            // ğŸš¨ ä¿®æ­£: éœ‡åº¦ãŒé«˜ã„æ–¹ã‹ã‚‰é †ç•ªã«è©•ä¾¡ã™ã‚‹ã‚ˆã†ã«ä¿®æ­£
            let soundKey;
            if (maxInt >= 55) { // éœ‡åº¦6å¼±ä»¥ä¸Š
                soundKey = 'int6_up';
            } else if (maxInt >= 45) { // éœ‡åº¦5å¼±ãƒ»5å¼·
                soundKey = 'int5_mid';
            } else { // ãã‚Œä»¥å¤– (éœ‡åº¦4ä»¥ä¸‹)
                soundKey = 'int4_down';
            }
            
            const alarmType = CURRENT_SETTINGS.eewSoundMap[soundKey] || 'classic_eew';
            
            if (alarmType === 'silent') {
                console.log(`ã‚¢ãƒ©ãƒ¼ãƒ ã¯${soundKey}ã®è¨­å®šã«ã‚ˆã‚ŠãƒŸãƒ¥ãƒ¼ãƒˆã•ã‚Œã¦ã„ã¾ã™ã€‚`);
                return;
            }
            
            initializeAudioContext();
            
            if (!audioContext) {
                console.error("AudioContextãŒåˆ©ç”¨ã§ãã¾ã›ã‚“ã€‚");
                return;
            }

            // ----------------------------------------------------
            // ğŸ”Š URLéŸ³æºã®å†ç”Ÿãƒ­ã‚¸ãƒƒã‚¯ ğŸ”Š
            // ----------------------------------------------------
            if (alarmType.startsWith('custom_url_')) {
                const buffer = audioBuffers[alarmType];
                if (buffer) {
                    const source = audioContext.createBufferSource();
                    source.buffer = buffer;
                    source.connect(audioContext.destination);
                    source.start(0);
                    console.log(`URLéŸ³æº (${alarmType}) ã‚’å†ç”Ÿã—ã¾ã—ãŸã€‚`);
                } else {
                    console.error(`${alarmType}: éŸ³å£°ãƒãƒƒãƒ•ã‚¡ãŒãƒ­ãƒ¼ãƒ‰ã•ã‚Œã¦ã„ãªã„ã‹ã€ãƒ­ãƒ¼ãƒ‰ã«å¤±æ•—ã—ã¦ã„ã¾ã™ã€‚ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®EEWéŸ³ã‚’å†ç”Ÿã—ã¾ã™ã€‚`);
                    // ãƒ­ãƒ¼ãƒ‰å¤±æ•—æ™‚ã¯ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ã¨ã—ã¦EEWæ¨™æº–éŸ³ã‚’å†ç”Ÿ
                    playSynthesizedAlarm('classic_eew'); 
                }
                return; // URLéŸ³æºã®å†ç”ŸãŒè©¦è¡Œã•ã‚ŒãŸã‚‰ã“ã“ã§çµ‚äº†
            }
            
            // ----------------------------------------------------
            // ğŸµ ã‚·ãƒ³ã‚»ã‚µã‚¤ã‚¶ãƒ¼éŸ³ã®å†ç”Ÿãƒ­ã‚¸ãƒƒã‚¯ ğŸ¶
            // ----------------------------------------------------
            playSynthesizedAlarm(alarmType);
        }

        /**
         * ğŸŒŠ æ´¥æ³¢ã®è­¦å ±ç¨®åˆ¥ã«å¿œã˜ãŸã‚¢ãƒ©ãƒ¼ãƒ éŸ³ã‚’å†ç”Ÿã™ã‚‹ ğŸŒŠ
         * @param {'major' | 'warning' | 'advisory' | 'cancelled'} tsunamiType - æ´¥æ³¢è­¦å ±ã®ç¨®åˆ¥
         */
        function playAlarmForTsunami(tsunamiType) {
            initializeAudioContext();
            if (!audioContext) {
                console.error("AudioContextãŒåˆ©ç”¨ã§ãã¾ã›ã‚“ã€‚");
                return;
            }

            // 1. å°‚ç”¨URLéŸ³æºã®å†ç”Ÿã‚’è©¦ã¿ã‚‹
            const urlKey = `tsunami_${tsunamiType}`;
            const buffer = audioBuffers[urlKey];
            if (buffer) {
                const source = audioContext.createBufferSource();
                source.buffer = buffer;
                source.connect(audioContext.destination);
                source.start(0);
                console.log(`æ´¥æ³¢å°‚ç”¨URLéŸ³æº (${urlKey}) ã‚’å†ç”Ÿã—ã¾ã—ãŸã€‚`);
                return; // å°‚ç”¨éŸ³æºã‚’å†ç”Ÿã—ãŸã‚‰ã“ã“ã§çµ‚äº†
            }

            // 2. å°‚ç”¨URLéŸ³æºãŒãªã„å ´åˆã€ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ã¨ã—ã¦<select>ã§è¨­å®šã•ã‚ŒãŸéŸ³ã‚’å†ç”Ÿ
            const fallbackAlarmType = CURRENT_SETTINGS.tsunamiSoundMap[tsunamiType] || 'silent';

            if (fallbackAlarmType === 'silent') {
                console.log(`æ´¥æ³¢ã‚¢ãƒ©ãƒ¼ãƒ  (${tsunamiType}) ã¯è¨­å®šã«ã‚ˆã‚ŠãƒŸãƒ¥ãƒ¼ãƒˆã•ã‚Œã¦ã„ã¾ã™ã€‚`);
                return;
            }
            
            console.log(`æ´¥æ³¢å°‚ç”¨URLéŸ³æº(${urlKey})ãŒè¦‹ã¤ã‹ã‚‰ãªã„ãŸã‚ã€ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯éŸ³æº(${fallbackAlarmType})ã‚’å†ç”Ÿã—ã¾ã™ã€‚`);
            
            // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯éŸ³æºãŒã‚«ã‚¹ã‚¿ãƒ URLéŸ³æº(A/B)ã®å ´åˆã‚‚è€ƒæ…®
            if (fallbackAlarmType.startsWith('custom_url_')) {
                playCustomUrlSound(fallbackAlarmType);
            } else {
                playSynthesizedAlarm(fallbackAlarmType);
            }
        }

        /**
         * ã‚·ãƒ³ã‚»ã‚µã‚¤ã‚¶ãƒ¼éŸ³ï¼ˆEEWæ¨™æº–ã€ã‚µã‚¤ãƒ¬ãƒ³ã€ã‚«ã‚¹ã‚¿ãƒ ãƒˆãƒ¼ãƒ³ï¼‰ã‚’å†ç”Ÿã™ã‚‹
         * @param {string} alarmType - å†ç”Ÿã™ã‚‹ã‚¢ãƒ©ãƒ¼ãƒ ã®ç¨®é¡
         */
        function playSynthesizedAlarm(alarmType) {
            
            // ----------------------------------------------------
            // ğŸ”Š URLéŸ³æºã®å†ç”Ÿãƒ­ã‚¸ãƒƒã‚¯ (æ±ç”¨ã‚«ã‚¹ã‚¿ãƒ URL A/B) ğŸ”Š
            // ----------------------------------------------------
            if (alarmType.startsWith('custom_url_')) {
                playCustomUrlSound(alarmType);
                return; // URLéŸ³æºã®å†ç”ŸãŒè©¦è¡Œã•ã‚ŒãŸã‚‰ã“ã“ã§çµ‚äº†
            }
            
            // ----------------------------------------------------
            // ğŸµ ã‚·ãƒ³ã‚»ã‚µã‚¤ã‚¶ãƒ¼éŸ³ã®å†ç”Ÿãƒ­ã‚¸ãƒƒã‚¯ ğŸ¶
            // ----------------------------------------------------
            playSynth(alarmType);
        }

        /**
         * ã‚·ãƒ³ã‚»ã‚µã‚¤ã‚¶ãƒ¼éŸ³ã‚’å†ç”Ÿã™ã‚‹å†…éƒ¨é–¢æ•°
         */
        function playSynth(alarmType) {
            
            if (!audioContext) { return; }
            
            let sequence = [];
            let repeat = 0;
            const masterGainVolume = 0.7;

            if (alarmType === 'classic_eew') {
                // EEWæ¨™æº–éŸ³ (660Hz/990Hz) - ãƒ”ãƒ§ãƒ­ãƒ”ãƒ§ãƒ­
                sequence = [
                    { freq: 660, duration: 0.15 }, 
                    { freq: 990, duration: 0.15 }, 
                    { freq: 0, duration: 0.05 },
                ];
                repeat = 4;
            } else if (alarmType === 'urgent_siren') {
                // ç·Šè¿«ã‚µã‚¤ãƒ¬ãƒ³éŸ³ (1000Hz/800Hz)
                sequence = [
                    { freq: 1000, duration: 0.1 }, 
                    { freq: 800, duration: 0.1 }, 
                    { freq: 0, duration: 0.05 },
                ];
                repeat = 8;
            } else if (alarmType === 'simple_beep') {
                // ãƒ”ãƒ¼ãƒ³éŸ³ (660Hz)
                sequence = [
                    { freq: 660, duration: 0.1 }, 
                    { freq: 0, duration: 0.2 },
                ];
                repeat = 3; 
            } else if (alarmType === 'custom_tone_a' || alarmType === 'custom_tone_b') {
                // ğŸµ ã‚«ã‚¹ã‚¿ãƒ ãƒˆãƒ¼ãƒ³ã®ãƒ­ã‚¸ãƒƒã‚¯ ğŸ¶
                const customA = CURRENT_SETTINGS.customTones.custom_a;
                const customB = CURRENT_SETTINGS.customTones.custom_b;
                
                // ã‚«ã‚¹ã‚¿ãƒ éŸ³ã®ã‚·ãƒ¼ã‚±ãƒ³ã‚¹å®šç¾©: [ãƒ™ãƒ¼ã‚¹å‘¨æ³¢æ•°, ãƒ™ãƒ¼ã‚¹ + å¤‰èª¿, ä¼‘æ†©] ã‚’ç¹°ã‚Šè¿”ã™
                const tempoSeconds = customB.tempoMs / 1000;

                sequence = [
                    { freq: customA.baseFreq, duration: tempoSeconds }, 
                    { freq: customA.baseFreq + customA.modFreq, duration: tempoSeconds }, 
                    { freq: 0, duration: 0.05 },
                ];
                repeat = customB.repeats;
                console.log(`ã‚«ã‚¹ã‚¿ãƒ ãƒˆãƒ¼ãƒ³ (${alarmType}) ã‚’å†ç”Ÿ: Base=${customA.baseFreq}Hz, Mod=${customA.modFreq}Hz, Tempo=${customB.tempoMs}ms, Repeat=${customB.repeats}`);
            } else {
                return; // æœªå®šç¾©ã®ã‚¢ãƒ©ãƒ¼ãƒ ã‚¿ã‚¤ãƒ—
            }
            
            const totalDuration = sequence.reduce((sum, s) => sum + s.duration, 0) * repeat;

            const masterGain = audioContext.createGain();
            masterGain.gain.setValueAtTime(masterGainVolume, audioContext.currentTime); 
            masterGain.connect(audioContext.destination);

            let startTime = audioContext.currentTime;

            for (let r = 0; r < repeat; r++) {
                sequence.forEach(tone => {
                    if (tone.freq > 0) {
                        const oscillator = audioContext.createOscillator();
                        const gainNode = audioContext.createGain();
                        
                        oscillator.type = 'sine';
                        oscillator.frequency.setValueAtTime(tone.freq, startTime);
                        
                        // ãƒ•ã‚§ãƒ¼ãƒ‰ã‚¤ãƒ³/ã‚¢ã‚¦ãƒˆå‡¦ç†
                        gainNode.gain.setValueAtTime(0.0001, startTime);
                        gainNode.gain.linearRampToValueAtTime(1.0, startTime + 0.01);
                        gainNode.gain.linearRampToValueAtTime(0.0001, startTime + tone.duration - 0.01);

                        oscillator.connect(gainNode);
                        gainNode.connect(masterGain);

                        oscillator.start(startTime);
                        oscillator.stop(startTime + tone.duration);
                    }
                    
                    startTime += tone.duration;
                });
            }

            console.log(`ã‚·ãƒ³ã‚»ã‚µã‚¤ã‚¶ãƒ¼ã‚¢ãƒ©ãƒ¼ãƒ éŸ³ã‚’å†ç”Ÿã—ã¾ã—ãŸ (${alarmType}ã€åˆè¨ˆ ${totalDuration.toFixed(2)} ç§’)ã€‚`);
        }

        /**
         * æ±ç”¨ã®ã‚«ã‚¹ã‚¿ãƒ URLéŸ³æº (A/B) ã‚’å†ç”Ÿã™ã‚‹
         */
        function playCustomUrlSound(alarmType) {
            const buffer = audioBuffers[alarmType];
            if (buffer) {
                const source = audioContext.createBufferSource();
                source.buffer = buffer;
                source.connect(audioContext.destination);
                source.start(0);
                console.log(`URLéŸ³æº (${alarmType}) ã‚’å†ç”Ÿã—ã¾ã—ãŸã€‚`);
            } else {
                console.error(`${alarmType}: éŸ³å£°ãƒãƒƒãƒ•ã‚¡ãŒãƒ­ãƒ¼ãƒ‰ã•ã‚Œã¦ã„ãªã„ã‹ã€ãƒ­ãƒ¼ãƒ‰ã«å¤±æ•—ã—ã¦ã„ã¾ã™ã€‚ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®EEWéŸ³ã‚’å†ç”Ÿã—ã¾ã™ã€‚`);
                // ãƒ­ãƒ¼ãƒ‰å¤±æ•—æ™‚ã¯ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ã¨ã—ã¦EEWæ¨™æº–éŸ³ã‚’å†ç”Ÿ
                playSynth('classic_eew'); 
            }
        }

        // ----------------------------------------------------
        // ğŸš¨ ãƒ¡ã‚¤ãƒ³ãƒ­ã‚¸ãƒƒã‚¯ (EEWå‡¦ç†ã€ç¶šå ±ã€ã‚¿ã‚¤ãƒãƒ¼) ğŸš¨
        // ----------------------------------------------------
        const WS_URL = 'wss://api.p2pquake.net/v2/ws';
        const P2P_TYPES = [551, 552, 556]; // EEW, åœ°éœ‡æƒ…å ±, æ´¥æ³¢äºˆå ±

        let ws;
        let reconnectInterval = 5000; 
        
        /** EEWã‚¢ãƒ©ãƒ¼ãƒˆè¦ç´ ã®ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’æ›´æ–°ã™ã‚‹ (551 ç¶šå ±ç”¨) */
        function updateAlertElementContent(element, data) {
            const maxInt = data.earthquake?.maxScale || 0;
            const serial = data.issue?.serial;
            const dataType = getDataType(data); // ğŸš¨ ä¿®æ­£: dataTypeã‚’å–å¾—
            
            // éœ‡æºåœ°ã¨ãƒã‚°ãƒ‹ãƒãƒ¥ãƒ¼ãƒ‰ã®æƒ…å ±ï¼ˆæ¬ ææ™‚ã¯ã€Œèª¿æŸ»ä¸­ã€ï¼‰
            const epicenterName = data.earthquake?.hypocenter?.name || 'èª¿æŸ»ä¸­';
            const maxIntText = intensityToJma(maxInt);
            const magnitude = data.earthquake?.magnitude || 'èª¿æŸ»ä¸­';
            
            // ğŸš¨ ä¿®æ­£: éœ‡åº¦ã«å¿œã˜ãŸè­¦å‘Šæ–‡è¨€
            const warningText = maxInt >= 45 ? 'å¼·ã„æºã‚Œã«è­¦æˆ’' : 'ä»Šå¾Œã®æƒ…å ±ã«æ³¨æ„';

            // HTMLæ›´æ–°ãƒ­ã‚¸ãƒƒã‚¯
            element.className = 'eew-alert'; 
            if (maxInt >= 55) { element.className += ' intensity-6-up'; } 
            else if (maxInt >= 45) { element.className += ' intensity-5-up'; } 
            else if (maxInt >= 30) { element.className += ' intensity-3-up'; }

            // ğŸš¨ ä¿®æ­£: éœ‡åº¦4ä»¥ä¸‹ã®ã‚³ãƒ³ãƒ‘ã‚¯ãƒˆè¡¨ç¤ºã®å ´åˆã€æ›´æ–°å¯¾è±¡ã®è¦ç´ ãŒå­˜åœ¨ã—ãªã„å¯èƒ½æ€§ãŒã‚ã‚‹ãŸã‚ã€nullãƒã‚§ãƒƒã‚¯ã‚’è¿½åŠ 
            const titleElement = element.querySelector('.text-xl.mt-1');
            if (titleElement) titleElement.textContent = `ã€${data.issue.type === 'Alert' ? 'è­¦å ±' : 'äºˆå ±'}ã€‘${warningText}ï¼ˆç¶šå ±ï¼‰`;
            const detailElement = element.querySelector('.text-lg.mt-1');
            if (detailElement) detailElement.textContent = `éœ‡æºåœ°: ${epicenterName} | M${magnitude} | äºˆæƒ³æœ€å¤§éœ‡åº¦: ${maxIntText}`;
            element.querySelector('.intensity-label').textContent = maxIntText;
            
            // ç¶šå ±ã§ã‚‚ã‚¢ãƒ©ãƒ¼ãƒ ã‚’é³´ã‚‰ã™
            if (dataType === 'EEW') {
                playAlarmForIntensity(maxInt);
            }
            
            setupAlertTimer(element, dataType, serial, maxInt);
        }

        /** EEW/æ´¥æ³¢ã®ã‚¢ãƒ©ãƒ¼ãƒˆè¦ç´ ã‚’æ–°è¦ä½œæˆã™ã‚‹ (551/556 æ–°è¦ç”¨) */
        function createAlertElement(data) {
            const dataType = getDataType(data); // ğŸš¨ ä¿®æ­£: ãƒ‡ãƒ¼ã‚¿ã‚¿ã‚¤ãƒ—ã‚’å†åˆ¤å®š
            const maxInt = data.earthquake?.maxScale || 0;
            const serial = data.issue?.serial || `alert-${Date.now()}`;

            // ğŸš¨ ä¿®æ­£: éœ‡åº¦5å¼±ä»¥ä¸Šã¯å¼·åˆ¶è¡¨ç¤ºã€‚ãã‚Œæœªæº€ã¯è¨­å®šã«å¾“ã†
            if (dataType === 'EEW' && maxInt < 45 && maxInt < CURRENT_SETTINGS.minIntensityScale) {
                const minIntensityLabel = intensityToJma(CURRENT_SETTINGS.minIntensityScale);
                console.log(`EEWå—ä¿¡: æœ€å¤§éœ‡åº¦ ${intensityToJma(maxInt)}ã€‚è¨­å®šã•ã‚ŒãŸæœ€ä½éœ‡åº¦ã€Œ${minIntensityLabel}ã€æœªæº€ã®ãŸã‚ã€ã‚¢ãƒ©ãƒ¼ãƒˆè¡¨ç¤ºã‚’ã‚¹ã‚­ãƒƒãƒ—ã—ã¾ã—ãŸã€‚`);
                return; // ã“ã“ã§å‡¦ç†ã‚’çµ‚äº†
            }

            let maxIntText = intensityToJma(maxInt);
            let titleText = '';
            let detailText = '';
            let baseClass = 'eew-alert';
            let alertTypeTitle = '';
            let intensityUnitText = 'æœ€å¤§éœ‡åº¦';
            let intensityDisplayHtml = ''; // éœ‡åº¦ã¾ãŸã¯ã‚¢ã‚¤ã‚³ãƒ³ã‚’è¡¨ç¤ºã™ã‚‹éƒ¨åˆ†
            let newAlertHtml = ''; // ğŸš¨ ä¿®æ­£: ã‚¢ãƒ©ãƒ¼ãƒˆã®HTMLã‚’æ§‹ç¯‰ã™ã‚‹ãŸã‚ã®å¤‰æ•°ã‚’è¿½åŠ 

            if (dataType === 'EEW') { // ç·Šæ€¥åœ°éœ‡é€Ÿå ± (EEW)
                // ğŸš¨ ä¿®æ­£: éœ‡åº¦ã«å¿œã˜ãŸè­¦å‘Šæ–‡è¨€
                const warningText = maxInt >= 45 ? 'å¼·ã„æºã‚Œã«è­¦æˆ’' : 'ä»Šå¾Œã®æƒ…å ±ã«æ³¨æ„';
                titleText = `ã€${data.issue.type === 'Alert' ? 'è­¦å ±' : 'äºˆå ±'}ã€‘${warningText}ï¼ˆæ–°è¦ï¼‰`;
                // éœ‡æºåœ°ã¨ãƒã‚°ãƒ‹ãƒãƒ¥ãƒ¼ãƒ‰ã®æƒ…å ±ï¼ˆæ¬ ææ™‚ã¯ã€Œèª¿æŸ»ä¸­ã€ï¼‰
                const epicenterName = data.earthquake?.hypocenter?.name || 'èª¿æŸ»ä¸­';
                const magnitude = data.earthquake?.magnitude || 'èª¿æŸ»ä¸­';
                const areasText = data.areas?.map(a => a.name).join(' ') || '';
                detailText = `éœ‡æºåœ°: ${epicenterName} | M${magnitude} | äºˆæƒ³æœ€å¤§éœ‡åº¦: ${maxIntText}`;
                if (areasText) {
                    detailText += `<br>å¯¾è±¡åœ°åŸŸ: ${areasText}`;
                }

                // ğŸš¨ ä¿®æ­£: éœ‡åº¦ã«å¿œã˜ã¦ã‚¢ãƒ©ãƒ¼ãƒˆã®ãƒ‡ã‚¶ã‚¤ãƒ³ã‚’åˆ‡ã‚Šæ›¿ãˆã‚‹
                if (maxInt < 45) { // éœ‡åº¦4ä»¥ä¸‹ã®å ´åˆ: 2è¡Œã‚³ãƒ³ãƒ‘ã‚¯ãƒˆãƒ‡ã‚¶ã‚¤ãƒ³
                    // ğŸš¨ ä¿®æ­£: éœ‡åº¦4ã¨3ä»¥ä¸‹ã§ãƒ©ãƒ™ãƒ«ã‚’åˆ‡ã‚Šæ›¿ãˆã‚‹
                    const detailMessage = maxInt === 40 ? 'ã‚„ã‚„å¼·ã„åœ°éœ‡' : 'åœ°éœ‡æƒ…å ±';

                    baseClass += ' intensity-3-up p-3';
                    newAlertHtml = `
                        <div class="flex flex-col gap-1 text-white">
                            <div class="flex items-center justify-between">
                                <p class="font-bold text-2xl bg-orange-700 px-2 py-1 rounded">åœ°éœ‡é€Ÿå ±</p>
                                <div class="flex items-baseline gap-2">
                                    <span class="text-xl font-semibold">æœ€å¤§éœ‡åº¦</span>
                                    <span class="text-5xl font-extrabold">${maxIntText}</span>
                                </div>
                            </div>
                            <div class="text-base font-semibold pt-1 border-t border-white/30">
                                <span>éœ‡æº: ${epicenterName}</span>
                            </div>
                        </div>
                    `;
                } else { // éœ‡åº¦5å¼±ä»¥ä¸Šã®å ´åˆ: å¾“æ¥ã®ãƒ‡ã‚¶ã‚¤ãƒ³
                    alertTypeTitle = 'ç·Šæ€¥åœ°éœ‡é€Ÿå ±';
                    intensityDisplayHtml = `<p class="intensity-unit">æœ€å¤§éœ‡åº¦</p><p class="intensity-label">${maxIntText}</p>`;
                    
                    if (maxInt >= 55) { baseClass += ' intensity-6-up'; } 
                    else if (maxInt >= 45) { baseClass += ' intensity-5-up'; }

                    newAlertHtml = `
                        <div class="flex items-center justify-between">
                            <div class="flex flex-col">
                                <p class="text-3xl font-bold">${alertTypeTitle}</p>
                                <p class="text-xl mt-1">${titleText}</p>
                                <p class="text-lg mt-1">${detailText}</p>
                            </div>
                            <div class="flex flex-col items-center ml-4">${intensityDisplayHtml}</div>
                        </div>
                    `;
                }
                playAlarmForIntensity(maxInt); // ã‚¢ãƒ©ãƒ¼ãƒ éŸ³ã¯å…±é€šã§é³´ã‚‰ã™

            } else if (dataType === 'TsunamiInfo') { // æ´¥æ³¢æƒ…å ±
                // ğŸš¨ ä¿®æ­£: ä¸Šéƒ¨ã‚¢ãƒ©ãƒ¼ãƒˆã«å¯¾è±¡åœ°åŸŸã‚’è¡¨ç¤ºã™ã‚‹
                const areasText = data.areas?.map(a => a.name).join('ã€') || '';
                detailText = areasText ? `å¯¾è±¡åœ°åŸŸ: ${areasText}` : 'è©³ç´°ã¯ç”»é¢ä¸‹éƒ¨ã®ãƒ†ãƒ­ãƒƒãƒ—ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚';

                let warningComment = ''; // æ³¨æ„å–šèµ·ã‚³ãƒ¡ãƒ³ãƒˆç”¨ã®å¤‰æ•°ã‚’è¿½åŠ 
                let textColorClass = 'text-white'; // æ–‡å­—è‰²ã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã¯ç™½

                // ä¿®æ­£: areas é…åˆ—ã® grade ã‚’ç›´æ¥ãƒã‚§ãƒƒã‚¯ã™ã‚‹
                const hasMajorWarning = data.areas?.some(a => a.grade === 'MajorWarning');
                const hasWarning = data.areas?.some(a => a.grade === 'Warning');
                const hasWatch = data.areas?.some(a => a.grade === 'Watch');

                // ä¿®æ­£: areasãŒãªã„å ´åˆã€issue.textã‹ã‚‰è­¦å ±ç¨®åˆ¥ã‚’åˆ¤å®šã™ã‚‹ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
                const text = data.issue?.text || '';
                const textHasMajorWarning = !hasMajorWarning && text.includes('å¤§æ´¥æ³¢è­¦å ±');
                const textHasWarning = !hasWarning && text.includes('æ´¥æ³¢è­¦å ±');
                const textHasWatch = !hasWatch && text.includes('æ´¥æ³¢æ³¨æ„å ±');


                if (hasMajorWarning || textHasMajorWarning) {
                    alertTypeTitle = 'å¤§æ´¥æ³¢è­¦å ±ã‚’ç™ºè¡¨';
                    warningComment = 'ãŸã ã¡ã«é«˜å°ã¸é¿é›£ã—ã¦ãã ã•ã„';
                    baseClass += ' bg-purple-800 border-purple-300'; // èƒŒæ™¯è‰²: èµ¤ç´«
                    playAlarmForTsunami('major');
                } else if (hasWarning) {
                    alertTypeTitle = 'æ´¥æ³¢è­¦å ±ã‚’ç™ºè¡¨';
                    warningComment = 'æµ·å²¸ã‹ã‚‰é›¢ã‚Œã¦ãã ã•ã„';
                    baseClass += ' bg-red-700 border-red-300'; // èƒŒæ™¯è‰²: èµ¤
                    playAlarmForTsunami('warning');
                } else if (hasWatch || textHasWatch) {
                    alertTypeTitle = 'æ´¥æ³¢æ³¨æ„å ±ã‚’ç™ºè¡¨';
                    warningComment = 'æµ·å²¸ã«è¿‘ã¥ã‹ãªã„ã§ãã ã•ã„';
                    baseClass += ' bg-yellow-500 border-yellow-200'; // èƒŒæ™¯è‰²: é»„è‰²
                    textColorClass = 'text-black'; // æ–‡å­—è‰²: é»’
                    playAlarmForTsunami('advisory');
                } else {
                    // isWarningãŒtrueã§ã‚‚ã€ã“ã“ã«åˆ°é”ã™ã‚‹å¯èƒ½æ€§ãŒã‚ã‚‹ (textHasWarning ã®ã¿ true ã®å ´åˆ)
                    // ãã®ãŸã‚ã€æ±ç”¨çš„ãªæ´¥æ³¢è­¦å ±ã¨ã—ã¦å‡¦ç†ã™ã‚‹
                    alertTypeTitle = 'æ´¥æ³¢æƒ…å ±'; 
                    warningComment = 'ãƒ†ãƒ¬ãƒ“ãƒ»ãƒ©ã‚¸ã‚ªã§æƒ…å ±ã‚’ç¢ºèª';
                    baseClass += ' bg-blue-600 border-blue-300';
                }
                titleText = warningComment; // å°ã•ã„æ–¹ã®ã‚¿ã‚¤ãƒˆãƒ«ã‚’æ³¨æ„å–šèµ·ã‚³ãƒ¡ãƒ³ãƒˆã«ç½®ãæ›ãˆ
                baseClass += ` animation-none ${textColorClass}`; // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ãªã—ã¨æ–‡å­—è‰²ã‚¯ãƒ©ã‚¹ã‚’è¿½åŠ 
                intensityDisplayHtml = `<div class="w-24 h-24"><img src="https://github.com/AfterEffects-OK/EarthquakeEarlyWarning/blob/main/TsunamiHazardSign.svg.png?raw=true" alt="æ´¥æ³¢ã‚¢ã‚¤ã‚³ãƒ³" class="w-full h-full object-contain"></div>`;
                newAlertHtml = `
                    <div class="flex items-center justify-between">
                        <div class="flex flex-col">
                            <p class="text-3xl font-bold">${alertTypeTitle}</p>
                            <p class="text-xl mt-1">${titleText}</p>
                            <p class="text-lg mt-1">${detailText}</p>
                        </div>
                        <div class="flex flex-col items-center ml-4">${intensityDisplayHtml}</div>
                    </div>
                `;
            } else {
                return;
            }
            
            const newAlert = document.createElement('div');
            if (dataType === 'EEW') {
                newAlert.setAttribute('data-eew-serial', serial);
            } else if (dataType === 'TsunamiInfo') {
                newAlert.setAttribute('data-alert-type', 'tsunami'); // æ´¥æ³¢ã‚¢ãƒ©ãƒ¼ãƒˆç”¨ã®å±æ€§ã‚’è¿½åŠ 
            }
            newAlert.id = `alert-${serial}`;
            newAlert.className = `${baseClass}`; 
            newAlert.innerHTML = newAlertHtml;

            eewContainer.prepend(newAlert);
            setupAlertTimer(newAlert, dataType, serial, maxInt);
        }

        /** ãƒ‡ãƒ¼ã‚¿æ§‹é€ ã‹ã‚‰EEW, åœ°éœ‡æƒ…å ±, æ´¥æ³¢æƒ…å ±ã®ã„ãšã‚Œã‹ã‚’åˆ¤å®šã™ã‚‹ */
        function getDataType(data) {
            if (data.earthquake && data.earthquake.hypocenter && data.issue?.serial) {
                return 'EEW'; // ã‚·ãƒªã‚¢ãƒ«ç•ªå·ä»˜ãã®åœ°éœ‡æƒ…å ± -> EEW
            } else if (data.earthquake && data.earthquake.hypocenter) {
                return 'QuakeInfo'; // ã‚·ãƒªã‚¢ãƒ«ç•ªå·ãªã—ã®åœ°éœ‡æƒ…å ± -> åœ°éœ‡æƒ…å ±ãƒ†ãƒ­ãƒƒãƒ—
            } else if (data.areas && data.areas.some(a => a.grade)) {
                return 'TsunamiInfo'; // 'grade'ã‚’æŒã¤areasãŒã‚ã‚‹ -> æ´¥æ³¢æƒ…å ±
            } else if (data.cancelled === true || data.issue?.text?.includes('è§£é™¤')) {
                return 'TsunamiInfo'; // è§£é™¤å ±
            }
            return 'Unknown';
        }

        /** P2P Quakeã‹ã‚‰å—ä¿¡ã—ãŸãƒ‡ãƒ¼ã‚¿ã®ã‚¨ãƒ³ãƒˆãƒªãƒ¼ãƒã‚¤ãƒ³ãƒˆ */
        function processAlertData(data) {
            const dataType = getDataType(data);

            if (dataType === 'Unknown') {
                console.log(`å‡¦ç†å¯¾è±¡å¤–ã®ãƒ‡ãƒ¼ã‚¿ã‚’å—ä¿¡ã—ã¾ã—ãŸ (code: ${data.code})ã€‚ã‚¹ã‚­ãƒƒãƒ—ã—ã¾ã™ã€‚`, data);
                return;
            }
            
            const historyItem = {
                time: data.time || new Date().toISOString(),
                // ä¿®æ­£: issue.textãŒå­˜åœ¨ã™ã‚Œã°ã€ãã‚Œã‚’å„ªå…ˆçš„ã«epicenterã¨ã—ã¦ä½¿ç”¨ã™ã‚‹
                // ã“ã‚Œã«ã‚ˆã‚Šã€å–æ¶ˆå ±ãªã©ã®ãƒ†ã‚­ã‚¹ãƒˆæƒ…å ±ã‚‚å±¥æ­´ã«æ®‹ã‚‹
                epicenter: data.issue?.text || data.earthquake?.hypocenter?.name || 'ä¸æ˜',
                maxInt: data.earthquake?.maxScale || 0,
                maxIntText: intensityToJma(data.earthquake?.maxScale || 0),
                displayed: false, // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã¯éè¡¨ç¤º
                type: 'Unknown'
            };

            if (dataType === 'EEW') {
                historyItem.type = 'EEW';
                const serial = data.issue.serial;
                const existingElement = document.querySelector(`[data-eew-serial="${serial}"]`);
                if (existingElement) {
                    // ç¶šå ±ã¨ã—ã¦æ—¢å­˜ã®ã‚¢ãƒ©ãƒ¼ãƒˆã‚’æ›´æ–°
                    console.log(`EEWç¶šå ±ã‚’å‡¦ç†ã—ã¾ã™ (serial: ${serial})`);
                    historyItem.displayed = true; // ç¶šå ±ã¯å¿…ãšè¡¨ç¤ºã•ã‚Œã‚‹
                    updateAlertElementContent(existingElement, data);
                    // ğŸš¨ ä¿®æ­£: ç¶šå ±å—ä¿¡æ™‚ã«ãƒ†ãƒ­ãƒƒãƒ—ã‚‚å¼·åˆ¶çš„ã«æ›´æ–°ã™ã‚‹
                    console.log('EEWç¶šå ±ã«ã‚ˆã‚Šã€åœ°éœ‡æƒ…å ±ãƒ†ãƒ­ãƒƒãƒ—ã‚’æœ€æ–°æƒ…å ±ã«æ›´æ–°ã—ã¾ã™ã€‚');
                    showQuakeTicker(data);
                } else {
                    // æ–°è¦ã‚¢ãƒ©ãƒ¼ãƒˆã¨ã—ã¦ä½œæˆ
                    createAlertElement(data);
                }
            } else if (dataType === 'QuakeInfo') {
                // ğŸš¨ ä¿®æ­£: ã“ã“ã§ã®ç›´æ¥å‘¼ã³å‡ºã—ã¯éœ‡åº¦ãƒã‚§ãƒƒã‚¯ã‚’ showQuakeTicker é–¢æ•°å†…ã§è¡Œã†
                const maxInt = data.earthquake?.maxScale || 0;
                if (maxInt >= CURRENT_SETTINGS.minIntensityScaleTicker) {
                    showQuakeTicker(data);
                    historyItem.displayed = true;
                    historyItem.type = 'QuakeInfo';
                } else {
                    historyItem.displayed = false;
                    console.log(`åœ°éœ‡æƒ…å ±ãƒ†ãƒ­ãƒƒãƒ—ã®è¡¨ç¤ºã‚’ã‚¹ã‚­ãƒƒãƒ—ã—ã¾ã—ãŸã€‚æœ€å¤§éœ‡åº¦ ${intensityToJma(maxInt)} ãŒè¨­å®šã•ã‚ŒãŸæœ€ä½éœ‡åº¦ ${intensityToJma(CURRENT_SETTINGS.minIntensityScaleTicker)} æœªæº€ã§ã™ã€‚`);
                }
                
            } else if (dataType === 'TsunamiInfo') {
                historyItem.type = 'TsunamiInfo';
                historyItem.epicenter = data.issue?.text || data.areas?.map(a => a.name).join('ã€') || 'æ´¥æ³¢æƒ…å ±';
                const text = data.issue?.text || '';
                const isCancelled = text.includes('è§£é™¤');

                // ä¿®æ­£: areas é…åˆ—ã® grade ã‚’ãƒã‚§ãƒƒã‚¯ã™ã‚‹
                const isWarning = data.areas?.some(area => 
                    area.grade === 'MajorWarning' || // å¤§æ´¥æ³¢è­¦å ±
                    area.grade === 'Warning' ||      // æ´¥æ³¢è­¦å ±
                    area.grade === 'Watch'           // æ´¥æ³¢æ³¨æ„å ±
                ) || (
                    // ä¿®æ­£: areasãŒãªã„å ´åˆã€issue.textã®å†…å®¹ã§ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯åˆ¤å®š
                    !isCancelled && // è§£é™¤å ±ã¯é™¤ã
                    (text.includes('å¤§æ´¥æ³¢è­¦å ±') || text.includes('æ´¥æ³¢è­¦å ±') || text.includes('æ´¥æ³¢æ³¨æ„å ±'))
                );

                /**
                 * ğŸŒŠ æ´¥æ³¢ãƒ†ãƒ­ãƒƒãƒ—ç”¨ã®è©³ç´°ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ç”Ÿæˆã™ã‚‹ ğŸŒŠ
                 * @param {Object} data - P2P 556ãƒ‡ãƒ¼ã‚¿
                 * @returns {string} ç”Ÿæˆã•ã‚ŒãŸãƒ†ãƒ­ãƒƒãƒ—ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
                 */
                function createTsunamiTickerMessage(data) {
                    if (!data.areas || data.areas.length === 0) {
                        return data.issue?.text || 'æ´¥æ³¢ã«é–¢ã™ã‚‹æƒ…å ±ãŒç™ºè¡¨ã•ã‚Œã¾ã—ãŸã€‚';
                    }

                    // è­¦å ±ãƒ¬ãƒ™ãƒ«ã”ã¨ã«åœ°åŸŸã‚’ã‚°ãƒ«ãƒ¼ãƒ—åŒ–
                    const groupedAreas = {
                        MajorWarning: [],
                        Warning: [],
                        Watch: []
                    };
                    data.areas.forEach(area => {
                        if (groupedAreas[area.grade]) {
                            groupedAreas[area.grade].push(area);
                        }
                    });

                    // æœ€ã‚‚é«˜ã„è­¦å ±ãƒ¬ãƒ™ãƒ«ã‚’æ±ºå®š
                    const hasMajorWarning = data.areas.some(a => a.grade === 'MajorWarning');
                    const hasWarning = data.areas.some(a => a.grade === 'Warning');

                    let highestGradeText = 'æ´¥æ³¢æ³¨æ„å ±';
                    let highestCallToAction = 'æµ·å²¸ã«è¿‘ã¥ã‹ãªã„ã§ãã ã•ã„';
                    let highestGradeAreas = groupedAreas.Watch;

                    if (hasMajorWarning) {
                        highestGradeText = 'å¤§æ´¥æ³¢è­¦å ±';
                        highestCallToAction = 'ãŸã ã¡ã«é«˜å°ã¸é¿é›£ã—ã¦ãã ã•ã„';
                        highestGradeAreas = groupedAreas.MajorWarning;
                    } else if (hasWarning) {
                        highestGradeText = 'æ´¥æ³¢è­¦å ±';
                        highestCallToAction = 'æµ·å²¸ã‹ã‚‰é›¢ã‚Œã¦ãã ã•ã„';
                        highestGradeAreas = groupedAreas.Warning;
                    }

                    // ãƒ¡ã‚¤ãƒ³ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®ç”Ÿæˆ (æœ€é«˜ãƒ¬ãƒ™ãƒ«ã®è­¦å ±å¯¾è±¡åœ°åŸŸ)
                    const mainAreasText = highestGradeAreas.map(a => a.name).join(' ');
                    const mainMessage = `ã€${highestGradeText}ã€‘ ${mainAreasText} ã« ${highestGradeText}ãŒç™ºè¡¨ã•ã‚Œã¾ã—ãŸ ${highestCallToAction}`;

                    // è©³ç´°æƒ…å ±ã®ç”Ÿæˆ (è­¦å ±ãƒ¬ãƒ™ãƒ«ã”ã¨)
                    const gradeOrder = ['MajorWarning', 'Warning', 'Watch'];
                    const gradeLabels = { MajorWarning: 'å¤§æ´¥æ³¢è­¦å ±', Warning: 'æ´¥æ³¢è­¦å ±', Watch: 'æ´¥æ³¢æ³¨æ„å ±' };
                    let detailsMessage = '';
                    let hasAnyDetails = false; // ğŸš¨ ä¿®æ­£: ã„ãšã‚Œã‹ã®åœ°åŸŸã«è©³ç´°æƒ…å ±ãŒã‚ã‚‹ã‹ã‚’è¿½è·¡ã™ã‚‹ãƒ•ãƒ©ã‚°

                    gradeOrder.forEach(grade => {
                        if (groupedAreas[grade].length > 0) {
                            const areasDetailsText = groupedAreas[grade].map(area => {
                                let subDetails = [];
                                // ğŸš¨ ä¿®æ­£: è©³ç´°æƒ…å ±ãŒã‚ã‚Œã°ãƒ•ãƒ©ã‚°ã‚’ç«‹ã¦ã‚‹
                                if (area.firstHeight) {
                                    if (area.firstHeight.time) {
                                        const arrivalTime = new Date(area.firstHeight.time);
                                        subDetails.push(`åˆ°é” ${arrivalTime.getHours()}æ™‚${arrivalTime.getMinutes()}åˆ†`);
                                    } else if (area.firstHeight.condition) {
                                        subDetails.push(area.firstHeight.condition);
                                    }
                                    if (subDetails.length > 0) hasAnyDetails = true;
                                }
                                if (area.maxHeight) {
                                    if (area.maxHeight.value) {
                                        subDetails.push(`äºˆæƒ³é«˜ã• ${area.maxHeight.value}m`);
                                    } else if (area.maxHeight.condition) {
                                        subDetails.push(`äºˆæƒ³é«˜ã• ${area.maxHeight.condition}`);
                                    }
                                    if (subDetails.length > 0 && !hasAnyDetails) hasAnyDetails = true;
                                }
                                return `${area.name}${subDetails.length > 0 ? `(${subDetails.join(' ')})` : ''}`;
                            }).join(' ');
                            detailsMessage += ` ã€${gradeLabels[grade]}ã€‘ ${areasDetailsText}`;
                        }
                    });

                    // ğŸš¨ ä¿®æ­£: è©³ç´°æƒ…å ±ãŒã‚ã‚‹å ´åˆã®ã¿ã€Œåˆ°é”äºˆæƒ³æ™‚é–“ã¨é«˜ã•ã€ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’è¿½åŠ 
                    if (detailsMessage && hasAnyDetails) {
                        return `${mainMessage}ã€€ã€€åˆ°é”äºˆæƒ³æ™‚é–“ã¨é«˜ã• ${detailsMessage}`;
                    }

                    return mainMessage;
                }

                if (isCancelled) {
                    // è§£é™¤å ±ã‚’å—ä¿¡ã—ãŸã‚‰ã€è¡¨ç¤ºä¸­ã®ã™ã¹ã¦ã®æ´¥æ³¢ã‚¢ãƒ©ãƒ¼ãƒˆã‚’å‰Šé™¤
                    document.querySelectorAll('[data-alert-type="tsunami"]').forEach(el => el.remove());
                    hideTsunamiTicker();
                    playAlarmForTsunami('cancelled');
                    console.log('æ´¥æ³¢è­¦å ±ã®è§£é™¤å ±ã‚’å—ä¿¡ã—ãŸãŸã‚ã€é–¢é€£ã‚¢ãƒ©ãƒ¼ãƒˆã‚’éè¡¨ç¤ºã«ã—ã¾ã—ãŸã€‚');
                    historyItem.displayed = true; // è§£é™¤ã‚‚é‡è¦ãªæƒ…å ±ãªã®ã§è¡¨ç¤ºæ‰±ã„
                } else if (isWarning) {
                    // è­¦å ±ãƒ»æ³¨æ„å ±ã‚’å—ä¿¡ã—ãŸã‚‰ã€ä¸Šéƒ¨ã‚¢ãƒ©ãƒ¼ãƒˆã¨ã—ã¦è¡¨ç¤º
                    activeTsunamiInfo = createTsunamiTickerMessage(data); // æ–°ã—ã„é–¢æ•°ã§ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ç”Ÿæˆ
                    createAlertElement(data);
                    historyItem.displayed = true;
                } else {
                    console.log(`æ´¥æ³¢æƒ…å ±ã‚’å—ä¿¡ã—ã¾ã—ãŸãŒã€è­¦å ±ãƒ»æ³¨æ„å ±ãƒ»è§£é™¤å ±ã§ã¯ãªã„ãŸã‚è¡¨ç¤ºã‚’ã‚¹ã‚­ãƒƒãƒ—ã—ã¾ã—ãŸ: ${text}`);
                }
            }

            // è¡¨ç¤ºåˆ¤å®šãƒ­ã‚¸ãƒƒã‚¯ (createAlertElementå†…ã§è¡Œã‚ã‚Œã‚‹ãŸã‚ã€ã“ã“ã§å†åˆ¤å®š)
            if (dataType === 'EEW' && historyItem.maxInt) {
                if (historyItem.maxInt >= 45 || historyItem.maxInt >= CURRENT_SETTINGS.minIntensityScale) {
                    historyItem.displayed = true;
                }
            }

            // å±¥æ­´ã‚’è¿½åŠ 
            addHistoryItem(historyItem);

            // å±¥æ­´ã‚’æ°¸ç¶šåŒ–
            saveHistoryToLocalStorage();
        }

        // ----------------------------------------------------
        // ğŸŒ WebSocketæ¥ç¶š ğŸŒ
        // ----------------------------------------------------
        function connectWebSocket() {
            if (ws) { ws.close(); }

            loadStatusEl.textContent = 'æ¥ç¶šä¸­...';

            ws = new WebSocket(WS_URL);

            ws.onopen = () => {
                loadStatusEl.textContent = 'æ¥ç¶šå®Œäº†';
                loadStatusEl.classList.remove('bg-yellow-700');
                loadStatusEl.classList.add('bg-teal-700');

                ws.send(JSON.stringify({ "types": P2P_TYPES }));
                setTimeout(() => { loadStatusEl.classList.add('hidden'); }, 5000);
                reconnectInterval = 5000; 
            };

            ws.onmessage = (event) => {
                try {
                    const data = JSON.parse(event.data);
                    if (P2P_TYPES.includes(data.code)) {
                        console.log('åœ°éœ‡æƒ…å ±ã‚’å—ä¿¡:', data);
                        processAlertData(data); 
                    }
                } catch (e) {
                    console.error('JSONè§£æã‚¨ãƒ©ãƒ¼:', e);
                }
            };

            ws.onclose = (event) => {
                loadStatusEl.textContent = 'åˆ‡æ–­ã€‚å†æ¥ç¶šä¸­...';
                loadStatusEl.classList.remove('hidden');
                loadStatusEl.classList.remove('bg-teal-700');
                loadStatusEl.classList.add('bg-yellow-700');

                setTimeout(connectWebSocket, reconnectInterval);
            };

            ws.onerror = (error) => {
                console.error('WebSocketã‚¨ãƒ©ãƒ¼:', error);
                loadStatusEl.textContent = 'æ¥ç¶šã‚¨ãƒ©ãƒ¼';
                loadStatusEl.classList.remove('hidden');
                loadStatusEl.classList.remove('bg-teal-700');
                loadStatusEl.classList.add('bg-red-700');

                ws.close(); 
            };
        }

        // ----------------------------------------------------
        // ğŸŒŸ ãƒ†ã‚¹ãƒˆæ©Ÿèƒ½ã®å®Ÿè£… ğŸŒŸ
        // ----------------------------------------------------
        const TEST_EEW_SERIAL_A = "TEST-EEW-SERIAL-001";
        
        const TEST_DATA = {
            // ğŸš¨ ä¿®æ­£: EEWã®ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ã‚’ã€ã‚ˆã‚Šç¾å®Ÿçš„ãªå½¢å¼ã«ä¿®æ­£
            'eew_5weak_a': {
                "code": 551, "issue": {"source": "è©¦é¨“ç”¨A", "time": new Date().toISOString(), "type": "Alert", "serial": TEST_EEW_SERIAL_A},
                "earthquake": {
                    "time": new Date().toISOString(), "hypocenter": {"name": "èƒ½ç™»åŠå³¶æ²–", "depth": 10},
                    "maxScale": 45, "magnitude": 6.2
                },
                "areas": [
                    { "pref": "çŸ³å·çœŒ", "name": "çŸ³å·çœŒèƒ½ç™»", "scaleFrom": 45, "scaleTo": 45, "kindCode": "10" }
                ],
                "isTest": true
            },
            'eew_6strong_a': {
                "code": 551, "issue": {"source": "è©¦é¨“ç”¨A", "time": new Date().toISOString(), "type": "Alert", "serial": TEST_EEW_SERIAL_A},
                "earthquake": {
                    "time": new Date().toISOString(), "hypocenter": {"name": "èƒ½ç™»åŠå³¶æ²–", "depth": 10},
                    "maxScale": 60, "magnitude": 7.5
                },
                "areas": [
                    { "pref": "çŸ³å·çœŒ", "name": "çŸ³å·çœŒèƒ½ç™»", "scaleFrom": 60, "scaleTo": 60, "kindCode": "11" },
                    { "pref": "æ–°æ½ŸçœŒ", "name": "æ–°æ½ŸçœŒä¸Šè¶Š", "scaleFrom": 40, "scaleTo": 40, "kindCode": "10" }
                ],
                "isTest": true
            },
            // ğŸš¨ ä¿®æ­£: åœ°éœ‡æƒ…å ±(éœ‡åº¦é€Ÿå ±)ã®ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ã‚’ã€ã‚ˆã‚Šç¾å®Ÿçš„ãªå½¢å¼ã«ä¿®æ­£
            'quake_3': {
                "code": 551, "issue": {"source": "è©¦é¨“ç”¨", "time": new Date().toISOString(), "type": "DetailScale"},
                "earthquake": {
                    "time": new Date().toISOString(), "hypocenter": {"name": "åƒè‘‰çœŒæ±æ–¹æ²–", "depth": 30},
                    "maxScale": 30, "magnitude": 5.0
                }, "isTest": true
            },
            'tsunami_advisory': {
                "code": 556,
                "areas": [
                    {"grade": "Watch", "immediate": false, "name": "å²©æ‰‹çœŒ"},
                    {"grade": "Watch", "immediate": false, "name": "å®®åŸçœŒ"}
                ],
                "issue": {
                    "source": "è©¦é¨“ç”¨", "time": new Date().toISOString(), "type": "Tsunami", "serial": `TEST-TSUNAMI-${Date.now()}`,
                    "text": "å²©æ‰‹çœŒã€å®®åŸçœŒã«æ´¥æ³¢æ³¨æ„å ±ã‚’ç™ºè¡¨ã—ã¾ã—ãŸã€‚"
                },
                "isTest": true
            },
            'tsunami_major_warning': {
                "code": 556, "issue": {
                    "source": "è©¦é¨“ç”¨", "time": new Date().toISOString(), "type": "Tsunami", "serial": `TEST-TSUNAMI-${Date.now()}`,
                    "text": "æ²–ç¸„çœŒã«å¤§æ´¥æ³¢è­¦å ±ãŒç™ºè¡¨ã•ã‚Œã¾ã—ãŸã€‚ãŸã ã¡ã«é«˜å°ã«é¿é›£ã—ã¦ãã ã•ã„ã€‚"
                },
                "areas": [
                    {"grade": "MajorWarning", "immediate": true, "name": "æ²–ç¸„æœ¬å³¶åœ°æ–¹"},
                    {"grade": "MajorWarning", "immediate": true, "name": "å®®å¤å³¶ãƒ»å…«é‡å±±åœ°æ–¹"}
                ],
                "isTest": true
            }
        };

        testEew5WeakA.addEventListener('click', () => { processAlertData(TEST_DATA['eew_5weak_a']); });
        testEew6StrongA.addEventListener('click', () => { processAlertData(TEST_DATA['eew_6strong_a']); });
        testQuake3Button.addEventListener('click', () => { processAlertData(TEST_DATA['quake_3']); });
        testTsunamiAdvisory.addEventListener('click', () => { processAlertData(TEST_DATA['tsunami_advisory']); });
        testTsunamiMajorWarning.addEventListener('click', () => { processAlertData(TEST_DATA['tsunami_major_warning']); });
        
        testSoundButton.addEventListener('click', () => {
            // ç¾åœ¨ã®éœ‡åº¦6å¼·ã«è¨­å®šã•ã‚Œã¦ã„ã‚‹ã‚¢ãƒ©ãƒ¼ãƒ è¨­å®šã‚’ä½¿ã£ã¦ãƒ†ã‚¹ãƒˆ
            const maxInt = 60; 
            playAlarmForIntensity(maxInt);
            console.log(`ãƒ†ã‚¹ãƒˆ: éœ‡åº¦6å¼·ã«è¨­å®šã•ã‚Œã¦ã„ã‚‹ã‚¢ãƒ©ãƒ¼ãƒ  (${CURRENT_SETTINGS.eewSoundMap.int6_up}) ã‚’å†ç”Ÿã—ã¾ã™ã€‚`);
        });

        clearAlertButton.addEventListener('click', () => { hideAlert(); });

        // ----------------------------------------------------
        // ğŸš€ èµ·å‹• ğŸš€
        // ----------------------------------------------------
        window.onload = () => {
            setupApp(); // UIã¨AudioContextã®åˆæœŸåŒ–
            loadSettingsFromLocalStorage(); // LocalStorageã‹ã‚‰è¨­å®šã‚’ãƒ­ãƒ¼ãƒ‰ (ã“ã®ä¸­ã§éŸ³å£°ãƒ­ãƒ¼ãƒ‰ãŒå‘¼ã°ã‚Œã‚‹)
            loadHistoryFromLocalStorage(); // LocalStorageã‹ã‚‰å±¥æ­´ã‚’ãƒ­ãƒ¼ãƒ‰
            preloadAssets(); // ğŸš¨ ç”»åƒã¨éŸ³å£°ã‚¢ã‚»ãƒƒãƒˆã®ãƒ—ãƒªãƒ­ãƒ¼ãƒ‰ã‚’å®Ÿè¡Œ
            connectWebSocket(); // WebSocketæ¥ç¶šã‚’é–‹å§‹
            
            loadStatusEl.classList.remove('hidden');
        };
    </script>
</body>
</html>