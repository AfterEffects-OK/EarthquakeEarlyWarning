
<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç·Šæ€¥åœ°éœ‡é€Ÿå ± EEW Overlay</title>
    <!-- Tailwind CSS (CDN) ã‚’èª­ã¿è¾¼ã¿ã¾ã™ -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* OBSã§ã®èƒŒæ™¯é€éã¨ãƒ•ãƒ«ã‚¹ã‚¯ãƒªãƒ¼ãƒ³è¡¨ç¤ºã‚’ç¢ºå®Ÿã«ã™ã‚‹ãŸã‚ã®ã‚¹ã‚¿ã‚¤ãƒ« */
        body {
            margin: 0;
            padding: 0;
            background-color: transparent !important;
            overflow: hidden;
            font-family: 'Inter', sans-serif;
            width: 100vw;
            height: 100vh;
            position: relative;
        }

        /* ã‚¢ãƒ©ãƒ¼ãƒˆã‚³ãƒ³ãƒ†ãƒŠã®ã‚¹ã‚¿ã‚¤ãƒ« */
        #eew-container {
            position: absolute; 
            top: 20px; 
            left: 50%;
            transform: translateX(-50%);
            width: 90%;
            max-width: 800px;
            pointer-events: none;
            z-index: 1000;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        /* å€‹ã€…ã®ã‚¢ãƒ©ãƒ¼ãƒˆè¦ç´ ã®åŸºæœ¬ã‚¹ã‚¿ã‚¤ãƒ« */
        .eew-alert {
            display: block;
            color: white;
            padding: 20px 30px;
            border-radius: 12px;
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.4);
            border: 4px solid white;
            transition: all 0.3s ease-in-out;
            animation: pulse-border 1s infinite alternate;
            pointer-events: none;
        }

        /* éœ‡åº¦ã«å¿œã˜ã¦èƒŒæ™¯è‰²ã‚’èª¿æ•´ */
        .eew-alert.intensity-3-up {
            background-color: #ff8c00; /* éœ‡åº¦3ä»¥ä¸Š: ã‚ªãƒ¬ãƒ³ã‚¸ */
        }
        .eew-alert.intensity-5-up {
            background-color: #ff4500; /* éœ‡åº¦5å¼±ä»¥ä¸Š: èµ¤ã‚ªãƒ¬ãƒ³ã‚¸ */
        }
        .eew-alert.intensity-6-up {
            background-color: #dc143c; /* éœ‡åº¦6å¼±ä»¥ä¸Š: æ¿ƒã„èµ¤ */
            animation: shake 0.5s infinite; 
        }

        /* ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã‚­ãƒ¼ãƒ•ãƒ¬ãƒ¼ãƒ  */
        @keyframes pulse-border {
            from { border-color: white; box-shadow: 0 0 10px #fff; }
            to { border-color: yellow; box-shadow: 0 0 20px yellow; }
        }

        @keyframes shake {
            0% { transform: translate(1px, 1px); }
            20% { transform: translate(-1px, -2px); }
            40% { transform: translate(-3px, 0px); }
            60% { transform: translate(3px, 2px); }
            80% { transform: translate(-1px, -1px); }
            100% { transform: translate(1px, -2px); }
        }

        /* éœ‡åº¦è¡¨ç¤ºã®ã‚¹ã‚¿ã‚¤ãƒ« */
        .intensity-label {
            font-size: 3rem;
            font-weight: 800;
            line-height: 1;
        }
        .intensity-unit {
            font-size: 1.5rem;
            font-weight: 600;
        }

        /* ãƒœã‚¿ãƒ³ã®ãƒ†ã‚­ã‚¹ãƒˆã‚’ä¸­å¤®æƒãˆã«ã—ã¦æ”¹è¡Œã‚’å¯èƒ½ã«ã™ã‚‹ */
        .test-button-label {
            display: flex;
            flex-direction: column;
            line-height: 1.2;
        }

        /* æŠ˜ã‚ŠãŸãŸã¿ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã®ãƒ™ãƒ¼ã‚¹ã‚¹ã‚¿ã‚¤ãƒ« */
        .collapsible-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease-out, padding 0.3s ease-out;
            padding-top: 0;
            padding-bottom: 0;
            /* Flex gapã‚’ç¶­æŒã™ã‚‹ãŸã‚ã€å­è¦ç´ ã®ãƒãƒ¼ã‚¸ãƒ³ã‚’ãƒªã‚»ãƒƒãƒˆ */
            display: flex;
            flex-direction: column;
            gap: 0.5rem; /* gap-2ã«ç›¸å½“ */
        }

        .collapsible-content.expanded {
            max-height: 1500px; /* URLå…¥åŠ›æ¬„ãŒå¢—ãˆãŸãŸã‚æœ€å¤§å€¤ã‚’å¤§ããã™ã‚‹ */
            padding-top: 0.75rem; /* p-3ã«ç›¸å½“ */
            padding-bottom: 0; /* è¦ªè¦ç´ ã®ãƒ‘ãƒ‡ã‚£ãƒ³ã‚°ã«ä¾å­˜ */
        }
        
        /* çµ±åˆã•ã‚ŒãŸãƒˆã‚°ãƒ«ãƒœã‚¿ãƒ³ã®ã‚¹ã‚¿ã‚¤ãƒ« */
        .toggle-header {
             /* è¦ªã®ãƒ‘ãƒ‡ã‚£ãƒ³ã‚°ã¨ç«¶åˆã—ãªã„ã‚ˆã†ã«ãƒãƒ¼ã‚¸ãƒ³ã¨ãƒ‘ãƒ‡ã‚£ãƒ³ã‚°ã‚’èª¿æ•´ */
             padding-top: 0.5rem;
             padding-bottom: 0.5rem;
             margin-top: -0.5rem; 
             margin-left: -0.75rem; /* padding-left: p-3 (0.75rem)ã®èª¿æ•´ */
             margin-right: -0.75rem; /* padding-right: p-3 (0.75rem)ã®èª¿æ•´ */
             padding-left: 0.75rem;
             padding-right: 0.75rem;
             /* å¢ƒç•Œç·šèª¿æ•´ */
             border-top: 1px solid transparent; /* å†…éƒ¨ã®pb-1/mb-1ã¨åˆã‚ã›ã¦å¢ƒç•Œç·šã‚’è¦‹ã›ãªã„ã‚ˆã†ã«ã™ã‚‹ */
             border-bottom: 1px solid;
             
        }
        
        /* ãƒ­ãƒ¼ãƒ‰ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ç”¨ã®ã‚¯ãƒ©ã‚¹ */
        .loading-status {
            font-size: 0.75rem; /* text-xs */
            font-weight: 600; /* font-semibold */
            padding-left: 0.25rem; /* pl-1 */
        }
        
        /* ãƒ‹ãƒ¥ãƒ¼ã‚¹ãƒ†ãƒ­ãƒƒãƒ— (Ticker) ã‚¹ã‚¿ã‚¤ãƒ« */
        #quake-ticker-area {
            position: fixed;
            bottom: 20px; 
            left: 0;
            width: 100%;
            background-color: rgba(179, 11, 11, 0.95); /* èµ¤ç³»ã®èƒŒæ™¯ */
            color: white;
            overflow: hidden; 
            z-index: 1500;
            display: none; /* Initially hidden, JS will set to flex when needed */
            align-items: center;
            white-space: nowrap;
            padding: 2px 0; 
            
            font-size: 34px; 
            font-weight: 900; 
            line-height: 1.4; /* è¡Œé–“ã‚’èª¿æ•´ */
            
            /* ç™½ã‚¨ãƒƒã‚¸ã‚’ä¸Šã¨ä¸‹ã«è¿½åŠ  */
            box-shadow: 0 0 20px rgba(255, 255, 255, 0.7); /* ç™½ãå…‰ã‚‹ã‚·ãƒ£ãƒ‰ã‚¦ */
            border-top: 4px solid rgb(255, 255, 255); /* å¢ƒç•Œç·šã‚‚å¤ªãã™ã‚‹ */
            border-bottom: 4px solid rgb(255, 255, 255); /* ä¸‹ã«ã‚‚ç™½ã„å¢ƒç•Œç·šã‚’è¿½åŠ  */
            
            /* ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«é–‹å§‹ä½ç½®ã‚’å³ç«¯ã«ã™ã‚‹ãŸã‚ã®ãƒ‘ãƒ‡ã‚£ãƒ³ã‚° */
            padding-left: 100%; 
        }
        
        /* ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã‚’åˆæœŸçŠ¶æ…‹ã§ä¸€æ™‚åœæ­¢ */
        #ticker-content {
            display: inline-block;
            animation-name: ticker-scroll;
            animation-timing-function: linear;
            animation-iteration-count: 1; /* 1å›ã®ã¿å®Ÿè¡Œ */
            animation-fill-mode: forwards; /* çµ‚äº†æ™‚ã®çŠ¶æ…‹ã‚’ç¶­æŒ (ç”»é¢å¤–ã§åœæ­¢) */
            animation-play-state: paused; /* åˆæœŸçŠ¶æ…‹ã¯åœæ­¢ */
            padding-right: 48px; /* ãƒ†ãƒ­ãƒƒãƒ—ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã®å³å´ã«ã‚‚ã‚¹ãƒšãƒ¼ã‚¹ã‚’è¿½åŠ  */
        }

        /* ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã®å®šç¾© */
        @keyframes ticker-scroll {
            /* JSã§è¨­å®šã•ã‚ŒãŸ --scroll-distance åˆ†ã ã‘å·¦ã«ç§»å‹• */
            to { transform: translateX(var(--scroll-distance, -100%)); } 
        }
        
        /* ãƒ­ãƒ¼ãƒ‰å®Œäº†ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ */
        #load-status {
            font-size: 0.9rem;
            font-weight: 600;
            padding: 4px 8px;
            background-color: rgba(17, 94, 89, 0.9); /* teal-700 */
            color: white;
            border-radius: 6px;
        }

        /* å±¥æ­´ãƒªã‚¹ãƒˆã®ã‚¹ã‚¿ã‚¤ãƒ« */
        #history-list {
            max-height: 300px; /* é«˜ã•ãŒ300pxã‚’è¶…ãˆãŸã‚‰ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ« */
            overflow-y: auto;
            padding-right: 8px; /* ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ãƒãƒ¼ã®ãŸã‚ã®ã‚¹ãƒšãƒ¼ã‚¹ */
        }
        .history-item {
            font-size: 0.75rem; /* text-xs */
            padding: 6px;
            border-radius: 4px;
            margin-bottom: 4px;
            border-left: 4px solid;
        }
        .history-item.displayed {
            background-color: rgba(67, 56, 202, 0.3); /* bg-indigo-800/30 */
            border-color: #4ade80; /* green-400 */
        }
        .history-item.skipped {
            background-color: rgba(75, 85, 99, 0.2); /* bg-gray-600/20 */
            border-color: #facc15; /* yellow-400 */
            opacity: 0.7;
        }
    </style>
</head>
<body>
    
    <!-- ç·Šæ€¥åœ°éœ‡é€Ÿå ±ã®ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤è¡¨ç¤ºã‚¨ãƒªã‚¢ -->
    <div id="eew-display-area" class="relative w-full h-full pointer-events-none">
        <!-- ãƒ­ãƒ¼ãƒ‰å®Œäº†ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ç”¨ -->
        <p id="load-status" class="text-white text-center absolute top-2 right-2 z-20 transition-all">æº–å‚™ä¸­...</p>

        <!-- ã‚¢ãƒ©ãƒ¼ãƒˆè¦ç´ ã‚’æ ¼ç´ã™ã‚‹ã‚³ãƒ³ãƒ†ãƒŠ -->
        <div id="eew-container">
        </div>
    </div>
    
    <!-- ğŸš¨ åœ°éœ‡æƒ…å ±ãƒ†ãƒ­ãƒƒãƒ—è¡¨ç¤ºã‚¨ãƒªã‚¢ (ç”»é¢ä¸‹éƒ¨å›ºå®š) ğŸš¨ -->
    <div id="quake-ticker-area">
        <div id="ticker-content"></div>
    </div>
    <!-- åœ°éœ‡æƒ…å ±ãƒ†ãƒ­ãƒƒãƒ—è¡¨ç¤ºã‚¨ãƒªã‚¢ çµ‚äº† -->

    <!-- è¨­å®šãƒˆã‚°ãƒ«ãƒœã‚¿ãƒ³ -->
    <button id="toggle-settings" class="fixed top-1/2 left-0 -translate-y-1/2 bg-gray-900 bg-opacity-70 text-white p-2 rounded-r-lg shadow-xl z-[2001] pointer-events-auto transition hover:bg-gray-700 focus:outline-none">
        è¨­å®š â–¼
    </button>

    <!-- ãƒ†ã‚¹ãƒˆç”¨ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ãƒ‘ãƒãƒ« -->
    <div id="test-controls" class="w-[320px] p-4 pb-24 bg-gray-900 bg-opacity-95 fixed top-0 left-0 bottom-[120px] transform -translate-x-full transition-transform duration-300 z-[2000] overflow-y-auto" style="pointer-events: auto;">
        
        <h2 class="text-white text-xl font-bold mb-4 border-b border-gray-700 pb-2">EEW ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤è¨­å®š (Local Storage)</h2>

        <!-- 1. è¡¨ç¤ºè¨­å®šã‚°ãƒ«ãƒ¼ãƒ— -->
        <div class="flex flex-col gap-2 p-3 bg-gray-800 rounded-lg mb-4">
            <p class="text-sm font-semibold text-gray-300 w-full border-b border-gray-700 pb-1 mb-1">â–¶ è¡¨ç¤ºãƒ»ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³è¨­å®š</p>
            
            <div class="flex items-center justify-between">
                <!-- ä¿®æ­£ç®‡æ‰€ -->
                <label for="min-intensity" class="text-white text-sm font-medium whitespace-nowrap">EEWè¡¨ç¤ºæœ€ä½éœ‡åº¦:</label>
                <select id="min-intensity" class="p-1 rounded text-sm w-20 bg-gray-700 text-white focus:ring-yellow-500 focus:border-yellow-500 text-right">
                    <!-- ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã¯JavaScriptã§è¨­å®š -->
                </select>
            </div>
            <div class="flex items-center justify-between">
                <label for="eew-duration" class="text-white text-sm font-medium whitespace-nowrap">EEWã‚¢ãƒ©ãƒ¼ãƒˆæ™‚é–“(ç§’):</label>
                <input type="number" id="eew-duration" min="5" max="300" class="p-1 rounded text-sm w-20 bg-gray-700 text-white focus:ring-yellow-500 focus:border-yellow-500 text-right">
            </div>
            <div class="flex items-center justify-between">
                <label for="quake-duration" class="text-white text-sm font-medium whitespace-nowrap">æƒ…å ±ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«(ç§’):</label>
                <input type="number" id="quake-duration" min="10" max="300" class="p-1 rounded text-sm w-20 bg-gray-700 text-white focus:ring-yellow-500 focus:border-yellow-500 text-right">
            </div>
        </div>
        
        <!-- 2. ğŸš¨ éœ‡åº¦åˆ¥ã‚¢ãƒ©ãƒ¼ãƒ éŸ³è¨­å®šã‚°ãƒ«ãƒ¼ãƒ— ğŸš¨ -->
        <div class="flex flex-col bg-red-800 rounded-lg mb-4 border border-yellow-500 p-3">
            <!-- ãƒ˜ãƒƒãƒ€ãƒ¼ (ã‚¯ãƒªãƒƒã‚¯ã§å±•é–‹/æŠ˜ã‚ŠãŸãŸã¿) -->
            <button id="toggle-intensity-alarm" class="toggle-header flex items-center w-full text-sm font-semibold text-yellow-300 border-yellow-700 hover:text-white transition">
                <span id="intensity-alarm-icon" class="text-base mr-2 transform transition-transform duration-300">â–¶</span>
                <span>éœ‡åº¦åˆ¥ã‚¢ãƒ©ãƒ¼ãƒ éŸ³è¨­å®š</span>
            </button>
            
            <!-- æŠ˜ã‚ŠãŸãŸã¿å¯èƒ½ãªã‚³ãƒ³ãƒ†ãƒ³ãƒ„ -->
            <div id="intensity-alarm-content" class="collapsible-content">
                <!-- å…±é€šã®ã‚ªãƒ—ã‚·ãƒ§ãƒ³ãƒªã‚¹ãƒˆ -->
                <script>
                    const soundOptions = `
                        <option value="classic_eew">EEWæ¨™æº–éŸ³</option>
                        <option value="urgent_siren">ğŸš¨ ç·Šè¿«ã‚µã‚¤ãƒ¬ãƒ³éŸ³</option>
                        <option value="custom_tone_a">ğŸµ ã‚«ã‚¹ã‚¿ãƒ ãƒˆãƒ¼ãƒ³ A</option>
                        <option value="custom_tone_b">ğŸ¶ ã‚«ã‚¹ã‚¿ãƒ ãƒˆãƒ¼ãƒ³ B</option>
                        <option value="custom_url_a">ğŸ”Š URLéŸ³æº A</option>
                        <option value="custom_url_b">ğŸ”Š URLéŸ³æº B</option>
                        <option value="simple_beep">ãƒ”ãƒ¼ãƒ³éŸ³ (660Hz)</option>
                        <option value="silent">ãƒŸãƒ¥ãƒ¼ãƒˆ</option>
                    `;
                </script>

                <div class="flex items-center justify-between">
                    <label class="text-white text-sm font-medium">éœ‡åº¦4ä»¥ä¸‹ç”¨:</label>
                    <select id="sound-for-int4" class="p-1 rounded text-sm w-36 bg-red-700 text-white focus:ring-yellow-500 focus:border-yellow-500" onload="this.innerHTML = soundOptions">
                        <script>document.write(soundOptions)</script>
                    </select>
                </div>

                <div class="flex items-center justify-between">
                    <label class="text-white text-sm font-medium">éœ‡åº¦5å¼± & 5å¼·ç”¨:</label>
                    <select id="sound-for-int5" class="p-1 rounded text-sm w-36 bg-red-700 text-white focus:ring-yellow-500 focus:border-yellow-500" onload="this.innerHTML = soundOptions">
                        <script>document.write(soundOptions)</script>
                    </select>
                </div>

                <div class="flex items-center justify-between">
                    <label class="text-white text-sm font-medium">éœ‡åº¦6å¼± ã‹ã‚‰ 7ç”¨:</label>
                    <select id="sound-for-int6" class="p-1 rounded text-sm w-36 bg-red-700 text-white focus:ring-yellow-500 focus:border-yellow-500" onload="this.innerHTML = soundOptions">
                        <script>document.write(soundOptions)</script>
                    </select>
                </div>
            </div>
        </div>

        <!-- 3. ğŸµ ã‚«ã‚¹ã‚¿ãƒ ã‚¢ãƒ©ãƒ¼ãƒ éŸ³ã®è¨­å®šã‚°ãƒ«ãƒ¼ãƒ— ğŸ¶ -->
        <div class="flex flex-col p-3 bg-gray-800 rounded-lg mb-4 border border-gray-600">
            <!-- ãƒ˜ãƒƒãƒ€ãƒ¼ (ã‚¯ãƒªãƒƒã‚¯ã§å±•é–‹/æŠ˜ã‚ŠãŸãŸã¿) - ã‚¢ã‚¤ã‚³ãƒ³ã‚’çµ±åˆ -->
            <button id="toggle-custom-alarm" class="toggle-header flex items-center w-full text-sm font-semibold text-gray-300 border-gray-700 hover:text-white transition">
                <span id="custom-alarm-icon" class="text-base mr-2 transform transition-transform duration-300">â–¶</span>
                <span>ã‚«ã‚¹ã‚¿ãƒ ã‚¢ãƒ©ãƒ¼ãƒ éŸ³ã®ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿è¨­å®š</span>
            </button>
            
            <!-- æŠ˜ã‚ŠãŸãŸã¿å¯èƒ½ãªã‚³ãƒ³ãƒ†ãƒ³ãƒ„ -->
            <div id="custom-alarm-content" class="collapsible-content">
                
                <!-- ã‚«ã‚¹ã‚¿ãƒ ãƒˆãƒ¼ãƒ³ (ã‚·ãƒ³ã‚»ã‚µã‚¤ã‚¶ãƒ¼éŸ³) -->
                <div class="flex flex-col gap-1 p-2 bg-gray-700 rounded-lg">
                    <p class="text-sm font-bold text-yellow-400">ğŸµ ã‚«ã‚¹ã‚¿ãƒ ãƒˆãƒ¼ãƒ³ A (å¤‰èª¿éŸ³)</p>
                    <div class="flex justify-between items-center text-xs text-white">
                        <label>ãƒ™ãƒ¼ã‚¹å‘¨æ³¢æ•° (Hz):</label>
                        <input type="number" id="custom-a-baseFreq" min="100" max="2000" class="p-1 rounded w-16 bg-gray-600 text-white text-right">
                    </div>
                    <div class="flex justify-between items-center text-xs text-white">
                        <label>å¤‰èª¿å¹… (Hz):</label>
                        <input type="number" id="custom-a-modFreq" min="0" max="1000" class="p-1 rounded w-16 bg-gray-600 text-white text-right">
                    </div>
                    <p class="text-sm font-bold text-yellow-400 mt-2">ğŸ¶ ã‚«ã‚¹ã‚¿ãƒ ãƒˆãƒ¼ãƒ³ B (ãƒ†ãƒ³ãƒ/ãƒªãƒ”ãƒ¼ãƒˆ)</p>
                    <div class="flex justify-between items-center text-xs text-white">
                        <label>ãƒ†ãƒ³ãƒ (ms/éŸ³):</label>
                        <input type="number" id="custom-b-tempoMs" min="50" max="1000" class="p-1 rounded w-16 bg-gray-600 text-white text-right">
                    </div>
                </div>

                <!-- URLéŸ³æº A -->
                <div class="flex flex-col gap-1 p-2 bg-gray-700 rounded-lg">
                    <p class="text-sm font-bold text-green-400">ğŸ”Š URLéŸ³æº A (.mp3/.wavãªã©)</p>
                    <input type="text" id="custom-url-a-input" placeholder="CORSå¯¾å¿œã®éŸ³å£°URL (mp3/wav)" class="p-1 rounded w-full bg-gray-600 text-white text-xs">
                    <p id="custom-url-a-status" class="loading-status text-yellow-500">æœªè¨­å®š</p>
                </div>
                
                <!-- URLéŸ³æº B -->
                <div class="flex flex-col gap-1 p-2 bg-gray-700 rounded-lg">
                    <p class="text-sm font-bold text-green-400">ğŸ”Š URLéŸ³æº B (.mp3/.wavãªã©)</p>
                    <input type="text" id="custom-url-b-input" placeholder="CORSå¯¾å¿œã®éŸ³å£°URL (mp3/wav)" class="p-1 rounded w-full bg-gray-600 text-white text-xs">
                    <p id="custom-url-b-status" class="loading-status text-yellow-500">æœªè¨­å®š</p>
                </div>
            </div>
        </div>

        <!-- 5. å—ä¿¡å±¥æ­´ã‚°ãƒ«ãƒ¼ãƒ— -->
        <div class="flex flex-col gap-2 p-3 bg-gray-800 rounded-lg mb-4">
            <!-- ãƒ˜ãƒƒãƒ€ãƒ¼ (ã‚¯ãƒªãƒƒã‚¯ã§å±•é–‹/æŠ˜ã‚ŠãŸãŸã¿) -->
            <button id="toggle-history" class="toggle-header flex justify-between items-center w-full text-sm font-semibold text-gray-300 border-gray-700 hover:text-white transition">
                <div class="flex items-center">
                    <span id="history-icon" class="text-base mr-2 transform transition-transform duration-300">â–¶</span>
                    <span class="leading-tight text-left">å—ä¿¡å±¥æ­´<br>(æœ€æ–°50ä»¶)</span>
                </div>
                <span id="clear-history" class="text-xs text-gray-400 hover:text-white transition z-10 p-1 -mr-1">å…¨æ¶ˆå»</span>
            </button>
            
            <!-- æŠ˜ã‚ŠãŸãŸã¿å¯èƒ½ãªã‚³ãƒ³ãƒ†ãƒ³ãƒ„ -->
            <div id="history-content" class="collapsible-content">
                <!-- å‡¡ä¾‹ã‚’è¿½åŠ  -->
                <div class="text-xs text-gray-400 flex items-center gap-3 px-1">
                    <span>å‡¡ä¾‹:</span>
                    <div class="flex items-center gap-1">
                        <span class="w-2.5 h-2.5" style="background-color: #4ade80;"></span>
                        <span>è¡¨ç¤º</span>
                    </div>
                    <div class="flex items-center gap-1">
                        <span class="w-2.5 h-2.5" style="background-color: #facc15;"></span>
                        <span>ã‚¹ã‚­ãƒƒãƒ—</span>
                    </div>
                </div>
                <ul id="history-list"></ul>
            </div>
        </div>

        <!-- 4. ãƒ†ã‚¹ãƒˆã‚°ãƒ«ãƒ¼ãƒ— -->
        <div class="flex flex-col gap-2 p-3 bg-gray-800 rounded-lg">
            <p class="text-sm font-semibold text-gray-300 w-full border-b border-gray-700 pb-1 mb-1">â–¶ ãƒ†ã‚¹ãƒˆ/ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£</p>
            <div class="grid grid-cols-2 gap-2">
                <!-- ç¶šå ±ãƒ†ã‚¹ãƒˆç”¨ã‚°ãƒ«ãƒ¼ãƒ—A -->
                <button id="test-eew-5weak-a" class="px-2 py-1 bg-yellow-600 text-white font-semibold rounded-lg hover:bg-yellow-700 transition duration-150 text-sm shadow-md">
                    <span class="test-button-label">éœ‡åº¦5å¼±<br>ï¼ˆæ–°è¦EEWï¼‰</span>
                </button>
                <button id="test-eew-6strong-a" class="px-2 py-1 bg-red-700 text-white font-semibold rounded-lg hover:bg-red-800 transition duration-150 text-sm shadow-md">
                    <span class="test-button-label">éœ‡åº¦6å¼·<br>ï¼ˆEEWç¶šå ±ï¼‰</span>
                </button>
                <button id="test-quake-3" class="px-2 py-1 bg-orange-600 text-white font-semibold rounded-lg hover:bg-orange-700 transition duration-150 text-sm shadow-md">åœ°éœ‡æƒ…å ±<br>ãƒ†ãƒ­ãƒƒãƒ—</button>
                <button id="test-sound" class="px-2 py-1 bg-purple-600 text-white font-semibold rounded-lg hover:bg-purple-700 transition duration-150 text-sm shadow-md">ã‚¢ãƒ©ãƒ¼ãƒ éŸ³<br>ãƒ†ã‚¹ãƒˆ</button>
                <button id="test-tsunami-advisory" class="px-2 py-1 bg-blue-600 text-white font-semibold rounded-lg hover:bg-blue-700 transition duration-150 text-sm shadow-md">
                    <span class="test-button-label">æ´¥æ³¢æ³¨æ„å ±<br>ãƒ†ã‚¹ãƒˆ</span>
                </button>
                <button id="test-tsunami-major-warning" class="px-2 py-1 bg-purple-800 text-white font-semibold rounded-lg hover:bg-purple-900 transition duration-150 text-sm shadow-md">
                    <span class="test-button-label">å¤§æ´¥æ³¢è­¦å ±<br>ãƒ†ã‚¹ãƒˆ</span>
                </button>
            </div>
            <button id="clear-alert" class="w-full px-2 py-1 bg-gray-500 text-white font-semibold rounded-lg hover:bg-gray-600 transition duration-150 text-sm shadow-md mt-2">ã™ã¹ã¦ã®ã‚¢ãƒ©ãƒ¼ãƒˆã‚’éè¡¨ç¤º</button>
        </div>
    </div>
    <!-- ãƒ†ã‚¹ãƒˆç”¨ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ãƒ‘ãƒãƒ« çµ‚äº† -->


    <script>
        // DOMè¦ç´ ã®å–å¾—
        const eewContainer = document.getElementById('eew-container');
        const loadStatusEl = document.getElementById('load-status');
        const minIntensitySelect = document.getElementById('min-intensity'); 
        const eewDurationInput = document.getElementById('eew-duration');
        const quakeDurationInput = document.getElementById('quake-duration'); 

        // ğŸš¨ ãƒ†ãƒ­ãƒƒãƒ—é–¢é€£ ğŸš¨
        const quakeTickerArea = document.getElementById('quake-ticker-area');
        const tickerContent = document.getElementById('ticker-content');

        const toggleSettingsButton = document.getElementById('toggle-settings');
        const testControls = document.getElementById('test-controls');
        
        // ğŸš¨ éœ‡åº¦åˆ¥ã‚¢ãƒ©ãƒ¼ãƒ è¨­å®šè¦ç´  ğŸš¨
        const toggleIntensityAlarm = document.getElementById('toggle-intensity-alarm');
        const intensityAlarmContent = document.getElementById('intensity-alarm-content');
        const intensityAlarmIcon = document.getElementById('intensity-alarm-icon');
        const soundForInt4El = document.getElementById('sound-for-int4');
        const soundForInt5El = document.getElementById('sound-for-int5');
        const soundForInt6El = document.getElementById('sound-for-int6');

        // ğŸµ ã‚«ã‚¹ã‚¿ãƒ ã‚¢ãƒ©ãƒ¼ãƒ è¨­å®šè¦ç´  ğŸ¶
        const customAlarmToggle = document.getElementById('toggle-custom-alarm');
        const customAlarmContent = document.getElementById('custom-alarm-content');
        const customAlarmIcon = document.getElementById('custom-alarm-icon'); 
        
        // ã‚«ã‚¹ã‚¿ãƒ ãƒˆãƒ¼ãƒ³ (ã‚·ãƒ³ã‚»éŸ³)
        const customA_BaseFreq = document.getElementById('custom-a-baseFreq');
        const customA_ModFreq = document.getElementById('custom-a-modFreq');
        const customB_TempoMs = document.getElementById('custom-b-tempoMs');
        
        // ã‚«ã‚¹ã‚¿ãƒ URLéŸ³æº
        const customUrlAInput = document.getElementById('custom-url-a-input');
        const customUrlAStatus = document.getElementById('custom-url-a-status');
        const customUrlBInput = document.getElementById('custom-url-b-input');
        const customUrlBStatus = document.getElementById('custom-url-b-status');

        // å±¥æ­´é–¢é€£ã®è¦ç´ 
        const historyListEl = document.getElementById('history-list');
        const toggleHistoryButton = document.getElementById('toggle-history');
        const historyContentEl = document.getElementById('history-content');
        const historyIconEl = document.getElementById('history-icon');
        const clearHistoryButton = document.getElementById('clear-history');


        // ãƒ†ã‚¹ãƒˆç”¨ãƒœã‚¿ãƒ³ã®å–å¾—
        const testEew5WeakA = document.getElementById('test-eew-5weak-a');
        const testEew6StrongA = document.getElementById('test-eew-6strong-a');
        const testQuake3Button = document.getElementById('test-quake-3');
        const testTsunamiAdvisory = document.getElementById('test-tsunami-advisory');
        const testTsunamiMajorWarning = document.getElementById('test-tsunami-major-warning');
        const testSoundButton = document.getElementById('test-sound'); 
        const clearAlertButton = document.getElementById('clear-alert');

        // æ´¥æ³¢è­¦å ±ã®çŠ¶æ…‹ã‚’ç®¡ç†ã™ã‚‹å¤‰æ•°
        let activeTsunamiInfo = null;


        // å±¥æ­´ãƒ‡ãƒ¼ã‚¿ã‚’ä¿æŒã™ã‚‹é…åˆ—
        let receivedHistory = [];
        const MAX_HISTORY_COUNT = 50;

        // ----------------------------------------------------
        // ğŸŒŸ æ°¸ç¶šåŒ–ã®ãŸã‚ã®è¨­å®š ğŸŒŸ
        // ----------------------------------------------------
        const HISTORY_STORAGE_KEY = 'eewOverlayHistory';
        const LOCAL_STORAGE_KEY = 'eewOverlaySettings';

        const DEFAULT_SETTINGS = {
            minIntensityScale: 50, // éœ‡åº¦5å¼±
            eewDuration: 15,       // EEWè¡¨ç¤ºæ™‚é–“ (ç§’)
            quakeDuration: 20,     // åœ°éœ‡æƒ…å ±ãƒ†ãƒ­ãƒƒãƒ—ã®ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«é€Ÿåº¦ (ç§’/ç”»é¢å¹…)
            
            // ğŸš¨ éœ‡åº¦åˆ¥ã‚¢ãƒ©ãƒ¼ãƒ éŸ³è¨­å®šã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ
            eewSoundMap: {
                int4_down: 'classic_eew',
                int5_mid: 'urgent_siren', 
                int6_up: 'urgent_siren'    
            },
            
            // ğŸµ ã‚«ã‚¹ã‚¿ãƒ ãƒˆãƒ¼ãƒ³ã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ ğŸ¶
            customTones: {
                custom_a: {
                    baseFreq: 880,  // Hz (åŸºæº–å‘¨æ³¢æ•° - A)
                    modFreq: 120,   // Hz (å¤‰èª¿å¹… - A)
                },
                custom_b: {
                    baseFreq: 440,
                    modFreq: 220,
                    tempoMs: 300,   // ms (1éŸ³ã®é•·ã• - BãŒãƒ†ãƒ³ãƒã‚’ä»£è¡¨)
                    repeats: 3      // å› (ç¹°ã‚Šè¿”ã—å›æ•° - BãŒãƒªãƒ”ãƒ¼ãƒˆã‚’ä»£è¡¨)
                }
            },
            // ğŸ”Š ã‚«ã‚¹ã‚¿ãƒ URLéŸ³æº ğŸ”Š
            customUrls: {
                custom_url_a: '',
                custom_url_b: '',
            },
            
            // UIã®æŠ˜ã‚ŠãŸãŸã¿çŠ¶æ…‹ã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ
            uiState: {
                isIntensityAlarmExpanded: false,
                isCustomAlarmExpanded: false,
                isHistoryExpanded: true // å±¥æ­´ã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§é–‹ã„ã¦ãŠã
            }
        };

        // å®Ÿè¡Œä¸­ã®è¨­å®šå€¤
        let CURRENT_SETTINGS = {...DEFAULT_SETTINGS}; 
        
        // ----------------------------------------------------
        // ğŸ’¾ è¨­å®šã®ä¿å­˜ã¨ãƒ­ãƒ¼ãƒ‰æ©Ÿèƒ½ (LocalStorage) ğŸ’¾
        // ----------------------------------------------------
        
        /**
         * ç¾åœ¨ã®è¨­å®šã‚’ãƒ–ãƒ©ã‚¦ã‚¶ã®LocalStorageã«ä¿å­˜ã™ã‚‹
         * @param {Object} newSettings - æ›´æ–°ã™ã‚‹è¨­å®šã®ä¸€éƒ¨ã¾ãŸã¯å…¨éƒ¨
         */
        function saveSettings(newSettings) {
            
            // ç¾åœ¨ã®è¨­å®šã‚’ãƒ‡ã‚£ãƒ¼ãƒ—ãƒãƒ¼ã‚¸
            const mergedSettings = { 
                ...CURRENT_SETTINGS,
                ...newSettings,
                eewSoundMap: {
                    ...CURRENT_SETTINGS.eewSoundMap,
                    ...(newSettings.eewSoundMap || {})
                },
                customTones: {
                    ...CURRENT_SETTINGS.customTones,
                    ...(newSettings.customTones || {})
                },
                customUrls: {
                    ...CURRENT_SETTINGS.customUrls,
                    ...(newSettings.customUrls || {})
                },
                uiState: {
                    ...CURRENT_SETTINGS.uiState,
                    ...(newSettings.uiState || {})
                }
            };
            
            try {
                localStorage.setItem(LOCAL_STORAGE_KEY, JSON.stringify(mergedSettings));
                CURRENT_SETTINGS = mergedSettings; // å®Ÿè¡Œä¸­ã®è¨­å®šã‚’æ›´æ–°
                console.log('è¨­å®šã‚’LocalStorageã«ä¿å­˜ã—ã¾ã—ãŸã€‚');
            } catch (e) {
                console.error('è¨­å®šã®ä¿å­˜ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ:', e);
            }
        }
        
        /** LocalStorageã‹ã‚‰è¨­å®šã‚’ãƒ­ãƒ¼ãƒ‰ã—ã€å®Ÿè¡Œä¸­ã®è¨­å®šã‚’æ›´æ–°ã™ã‚‹ */
        function loadSettingsFromLocalStorage() {
            try {
                const savedSettings = localStorage.getItem(LOCAL_STORAGE_KEY);
                if (savedSettings) {
                    const loaded = JSON.parse(savedSettings);
                    
                    // ãƒ­ãƒ¼ãƒ‰ã—ãŸè¨­å®šã‚’ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆè¨­å®šã¨ãƒãƒ¼ã‚¸ã—ã¦CURRENT_SETTINGSã«ã‚»ãƒƒãƒˆ
                    CURRENT_SETTINGS = {
                        ...DEFAULT_SETTINGS, 
                        ...loaded,
                        eewSoundMap: {
                            ...DEFAULT_SETTINGS.eewSoundMap,
                            ...(loaded.eewSoundMap || {})
                        },
                        customTones: {
                            ...DEFAULT_SETTINGS.customTones,
                            ...(loaded.customTones || {})
                        },
                         customUrls: {
                            ...DEFAULT_SETTINGS.customUrls,
                            ...(loaded.customUrls || {})
                        },
                        uiState: {
                            ...DEFAULT_SETTINGS.uiState,
                            ...(loaded.uiState || {})
                        }
                    };
                    console.log('è¨­å®šã‚’LocalStorageã‹ã‚‰ãƒ­ãƒ¼ãƒ‰ã—ã¾ã—ãŸã€‚');
                } else {
                    // åˆå›èµ·å‹•æ™‚ã€ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆè¨­å®šã‚’ä¿å­˜
                    saveSettings(DEFAULT_SETTINGS); 
                    console.log('LocalStorageã«è¨­å®šãŒãªã„ãŸã‚ã€ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆè¨­å®šã‚’é©ç”¨ã—ã¾ã—ãŸã€‚');
                }
            } catch (e) {
                console.error('è¨­å®šã®ãƒ­ãƒ¼ãƒ‰ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ:', e);
                CURRENT_SETTINGS = {...DEFAULT_SETTINGS};
            }
            
            // UIã«é©ç”¨
            updateUIFromSettings();
            // URLéŸ³æºã®ãƒ­ãƒ¼ãƒ‰ã‚’ãƒˆãƒªã‚¬ãƒ¼
            loadAllCustomUrls();
        }

        
        /** å®Ÿè¡Œä¸­ã®è¨­å®šã«åŸºã¥ã„ã¦UIã‚’æ›´æ–°ã™ã‚‹ */
        function updateUIFromSettings() {
            minIntensitySelect.value = CURRENT_SETTINGS.minIntensityScale;
            eewDurationInput.value = CURRENT_SETTINGS.eewDuration;
            quakeDurationInput.value = CURRENT_SETTINGS.quakeDuration;
            
            // ğŸš¨ éœ‡åº¦åˆ¥ã‚¢ãƒ©ãƒ¼ãƒ éŸ³è¨­å®šã‚’UIã«é©ç”¨ ğŸš¨
            soundForInt4El.value = CURRENT_SETTINGS.eewSoundMap.int4_down;
            soundForInt5El.value = CURRENT_SETTINGS.eewSoundMap.int5_mid;
            soundForInt6El.value = CURRENT_SETTINGS.eewSoundMap.int6_up;
            
            // ğŸµ ã‚«ã‚¹ã‚¿ãƒ ãƒˆãƒ¼ãƒ³ (ã‚·ãƒ³ã‚»éŸ³) è¨­å®šã‚’UIã«é©ç”¨ ğŸ¶
            const customA = CURRENT_SETTINGS.customTones.custom_a;
            const customB = CURRENT_SETTINGS.customTones.custom_b;
            
            customA_BaseFreq.value = customA.baseFreq;
            customA_ModFreq.value = customA.modFreq;
            customB_TempoMs.value = customB.tempoMs;

            // ğŸ”Š ã‚«ã‚¹ã‚¿ãƒ URLéŸ³æºè¨­å®šã‚’UIã«é©ç”¨ ğŸ”Š
            customUrlAInput.value = CURRENT_SETTINGS.customUrls.custom_url_a;
            customUrlBInput.value = CURRENT_SETTINGS.customUrls.custom_url_b;
            
            // UIã®æŠ˜ã‚ŠãŸãŸã¿çŠ¶æ…‹ã‚’é©ç”¨
            applyCollapsibleState(intensityAlarmContent, intensityAlarmIcon, CURRENT_SETTINGS.uiState.isIntensityAlarmExpanded);
            applyCollapsibleState(customAlarmContent, customAlarmIcon, CURRENT_SETTINGS.uiState.isCustomAlarmExpanded);
            applyCollapsibleState(historyContentEl, historyIconEl, CURRENT_SETTINGS.uiState.isHistoryExpanded);
        }
        
        /** æŠ˜ã‚ŠãŸãŸã¿è¦ç´ ã®å±•é–‹çŠ¶æ…‹ã‚’é©ç”¨ã™ã‚‹ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•° */
        function applyCollapsibleState(contentEl, iconEl, isExpanded) {
            if (isExpanded) {
                contentEl.classList.add('expanded');
                iconEl.textContent = 'â–¼'; 
            } else {
                contentEl.classList.remove('expanded');
                iconEl.textContent = 'â–¶';
            }
        }

        // ----------------------------------------------------
        // âš™ï¸ åˆæœŸåŒ–ã¨ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ âš™ï¸
        // ----------------------------------------------------

        const INTENSITY_OPTIONS = [
            { value: 0, label: 'è¨­å®šãªã—/1æœªæº€' }, { value: 10, label: '1' },
            { value: 20, label: '2' }, { value: 30, label: '3' }, 
            { value: 40, label: '4' }, { value: 45, label: '5å¼±' },
            { value: 50, label: '5å¼·' }, { value: 55, label: '6å¼±' },
            { value: 60, label: '6å¼·' }, { value: 70, label: '7' },
        ];
        
        /** DOMã¨åˆæœŸè¨­å®šã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ— */
        function setupApp() {
            // éœ‡åº¦ã‚»ãƒ¬ã‚¯ã‚¿ãƒ¼ã®ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’ä½œæˆ
            INTENSITY_OPTIONS.forEach(optionData => {
                const option = document.createElement('option');
                option.value = optionData.value;
                option.textContent = optionData.label;
                minIntensitySelect.appendChild(option);
            });
            
            // UIã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã®è¨­å®š (è¡¨ç¤ºè¨­å®š)
            minIntensitySelect.addEventListener('change', (event) => {
                saveSettings({ minIntensityScale: parseInt(event.target.value, 10) });
            });
            eewDurationInput.addEventListener('change', (event) => {
                const newValue = parseInt(event.target.value, 10);
                if (newValue >= 5) saveSettings({ eewDuration: newValue });
                else event.target.value = CURRENT_SETTINGS.eewDuration;
            });
            // ãƒ†ãƒ­ãƒƒãƒ—é€Ÿåº¦è¨­å®šã®ãƒªã‚¹ãƒŠãƒ¼
            quakeDurationInput.addEventListener('change', (event) => {
                const newValue = parseInt(event.target.value, 10);
                if (newValue >= 10) saveSettings({ quakeDuration: newValue });
                else event.target.value = CURRENT_SETTINGS.quakeDuration;
            });

            // éœ‡åº¦åˆ¥ã‚¢ãƒ©ãƒ¼ãƒ éŸ³è¨­å®šã®ãƒªã‚¹ãƒŠãƒ¼
            const updateSoundMap = () => {
                const newMap = {
                    int4_down: soundForInt4El.value,
                    int5_mid: soundForInt5El.value,
                    int6_up: soundForInt6El.value,
                };
                saveSettings({ eewSoundMap: newMap });
            };
            soundForInt4El.addEventListener('change', updateSoundMap);
            soundForInt5El.addEventListener('change', updateSoundMap);
            soundForInt6El.addEventListener('change', updateSoundMap);
            
            // ğŸµ ã‚«ã‚¹ã‚¿ãƒ ãƒˆãƒ¼ãƒ³ (ã‚·ãƒ³ã‚»éŸ³) è¨­å®šã®ãƒªã‚¹ãƒŠãƒ¼ ğŸ¶
            const setupCustomToneListener = (inputEl, toneKey, propName) => {
                inputEl.addEventListener('change', (event) => {
                    const newValue = parseInt(event.target.value, 10);
                    if (isNaN(newValue)) return;
                    
                    const update = {};
                    update[toneKey] = {};
                    update[toneKey][propName] = newValue;

                    saveSettings({ customTones: update });
                });
            };

            setupCustomToneListener(customA_BaseFreq, 'custom_a', 'baseFreq');
            setupCustomToneListener(customA_ModFreq, 'custom_a', 'modFreq');
            setupCustomToneListener(customB_TempoMs, 'custom_b', 'tempoMs'); 

            // ğŸ”Š ã‚«ã‚¹ã‚¿ãƒ URLéŸ³æºã®ãƒªã‚¹ãƒŠãƒ¼ ğŸ”Š
            const handleUrlChange = (inputEl, statusEl, key) => {
                inputEl.addEventListener('change', (event) => {
                    const newUrl = event.target.value.trim();
                    statusEl.textContent = 'ãƒ­ãƒ¼ãƒ‰ä¸­...';
                    statusEl.classList.remove('text-green-500', 'text-red-500');
                    statusEl.classList.add('text-yellow-500');

                    const update = {};
                    update[key] = newUrl;
                    
                    // saveSettingsã‚’å‘¼ã³å‡ºã—ã¦CURRENT_SETTINGSã‚’æ›´æ–°ã—ã€localStorageã«ä¿å­˜
                    saveSettings({ customUrls: update }); 
                    
                    // URLãŒå¤‰æ›´ã•ã‚ŒãŸã‚‰éŸ³æºã®ãƒ­ãƒ¼ãƒ‰ã‚’è©¦ã¿ã‚‹
                    if (newUrl) {
                        loadAudioFromUrl(key, newUrl, statusEl);
                    } else {
                        audioBuffers[key] = null;
                        statusEl.textContent = 'æœªè¨­å®š';
                        statusEl.classList.remove('text-yellow-500', 'text-red-500');
                    }
                });
            };
            
            handleUrlChange(customUrlAInput, customUrlAStatus, 'custom_url_a');
            handleUrlChange(customUrlBInput, customUrlBStatus, 'custom_url_b');
            
            
            // éœ‡åº¦åˆ¥ã‚¢ãƒ©ãƒ¼ãƒ è¨­å®šã®ãƒˆã‚°ãƒ«æ©Ÿèƒ½
            toggleIntensityAlarm.addEventListener('click', () => {
                const isExpanded = intensityAlarmContent.classList.toggle('expanded');
                applyCollapsibleState(intensityAlarmContent, intensityAlarmIcon, isExpanded);
                saveSettings({ uiState: { isIntensityAlarmExpanded: isExpanded } });
            });

            // ã‚«ã‚¹ã‚¿ãƒ ã‚¢ãƒ©ãƒ¼ãƒ è¨­å®šã®ãƒˆã‚°ãƒ«æ©Ÿèƒ½
            customAlarmToggle.addEventListener('click', () => {
                const isExpanded = customAlarmContent.classList.toggle('expanded');
                applyCollapsibleState(customAlarmContent, customAlarmIcon, isExpanded);
                saveSettings({ uiState: { isCustomAlarmExpanded: isExpanded } });
            });

            // å±¥æ­´ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã®ãƒˆã‚°ãƒ«æ©Ÿèƒ½
            toggleHistoryButton.addEventListener('click', (e) => {
                if (e.target.id === 'clear-history') return; // å…¨æ¶ˆå»ãƒœã‚¿ãƒ³ã¯é™¤å¤–
                const isExpanded = historyContentEl.classList.toggle('expanded');
                applyCollapsibleState(historyContentEl, historyIconEl, isExpanded);
                saveSettings({ uiState: { isHistoryExpanded: isExpanded } });
            });

            // è¨­å®šãƒ‘ãƒãƒ«ã®ãƒˆã‚°ãƒ«æ©Ÿèƒ½
            toggleSettingsButton.addEventListener('click', () => {
                const isHidden = testControls.classList.contains('-translate-x-full');
                if (isHidden) {
                    testControls.classList.remove('-translate-x-full');
                    toggleSettingsButton.textContent = 'è¨­å®š â–²';
                } else {
                    testControls.classList.add('-translate-x-full');
                    toggleSettingsButton.textContent = 'è¨­å®š â–¼';
                }
            });
            
            // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³çµ‚äº†æ™‚ã«ãƒ†ãƒ­ãƒƒãƒ—ã‚’éè¡¨ç¤ºã«ã™ã‚‹ãƒªã‚¹ãƒŠãƒ¼
            tickerContent.addEventListener('animationend', () => {
                quakeTickerArea.style.display = 'none';
                tickerContent.style.animationName = 'none'; // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ãƒªã‚»ãƒƒãƒˆ
                console.log('åœ°éœ‡æƒ…å ±ãƒ†ãƒ­ãƒƒãƒ—ãŒå®Œå…¨ã«ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã‚¢ã‚¦ãƒˆã—ã¾ã—ãŸã€‚');
            });

            // å±¥æ­´ã‚¯ãƒªã‚¢ãƒœã‚¿ãƒ³ã®ãƒªã‚¹ãƒŠãƒ¼
            clearHistoryButton.addEventListener('click', () => {
                receivedHistory = [];
                localStorage.removeItem(HISTORY_STORAGE_KEY); // LocalStorageã‹ã‚‰ã‚‚å‰Šé™¤
                renderHistoryList(); // UIã‚’æ›´æ–°
            });


            // AudioContextã‚’åˆæœŸåŒ–
            initializeAudioContext();
        }

        /** å±¥æ­´ãƒªã‚¹ãƒˆã‚’UIã«æç”»ã™ã‚‹ */
        function renderHistoryList() {
            historyListEl.innerHTML = ''; // ãƒªã‚¹ãƒˆã‚’ã‚¯ãƒªã‚¢
            
            receivedHistory.forEach(item => {
                const li = document.createElement('li');
                li.className = `history-item ${item.displayed ? 'displayed' : 'skipped'}`;
                
                const timeStr = new Date(item.time).toLocaleTimeString('ja-JP');
                const displayStatus = item.displayed ? 'è¡¨ç¤º' : 'ã‚¹ã‚­ãƒƒãƒ—';
                
                let infoText = '';
                if (item.type === 'EEW') {
                    infoText = `[EEW] éœ‡åº¦: ${item.maxIntText} | éœ‡æº: ${item.epicenter}`;
                } else if (item.type === 'QuakeInfo') {
                    infoText = `[åœ°éœ‡æƒ…å ±] éœ‡åº¦: ${item.maxIntText} | éœ‡æº: ${item.epicenter}`;
                }

                li.innerHTML = `
                    <div class="flex justify-between items-center text-white">
                        <span class="font-semibold">${timeStr}</span>
                        <span class="font-bold text-xs px-1.5 py-0.5 rounded ${item.displayed ? 'bg-green-600' : 'bg-yellow-600'}">${displayStatus}</span>
                    </div>
                    <p class="text-gray-300 mt-0.5">${infoText}</p>
                `;
                historyListEl.appendChild(li);
            });
        }

        /** å±¥æ­´ãƒ‡ãƒ¼ã‚¿ã‚’è¿½åŠ ã™ã‚‹ */
        function addHistoryItem(item) {
            receivedHistory.unshift(item); // æ–°ã—ã„ã‚‚ã®ã‚’å…ˆé ­ã«è¿½åŠ 
            if (receivedHistory.length > MAX_HISTORY_COUNT) {
                receivedHistory.pop(); // ä¸Šé™ã‚’è¶…ãˆãŸã‚‰å¤ã„ã‚‚ã®ã‚’å‰Šé™¤
            }
            renderHistoryList(); // UIã‚’æ›´æ–°
        }

        /** å±¥æ­´ã‚’LocalStorageã«ä¿å­˜ã™ã‚‹ */
        function saveHistoryToLocalStorage() {
            try {
                localStorage.setItem(HISTORY_STORAGE_KEY, JSON.stringify(receivedHistory));
            } catch (e) {
                console.error('å±¥æ­´ã®ä¿å­˜ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ:', e);
            }
        }

        /** LocalStorageã‹ã‚‰å±¥æ­´ã‚’ãƒ­ãƒ¼ãƒ‰ã™ã‚‹ */
        function loadHistoryFromLocalStorage() {
            try {
                const savedHistory = localStorage.getItem(HISTORY_STORAGE_KEY);
                if (savedHistory) {
                    receivedHistory = JSON.parse(savedHistory);
                    console.log('å±¥æ­´ã‚’LocalStorageã‹ã‚‰ãƒ­ãƒ¼ãƒ‰ã—ã¾ã—ãŸã€‚');
                }
            } catch (e) {
                console.error('å±¥æ­´ã®ãƒ­ãƒ¼ãƒ‰ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ:', e);
                receivedHistory = [];
            }
            renderHistoryList(); // ãƒ­ãƒ¼ãƒ‰ã—ãŸå±¥æ­´ã‚’UIã«åæ˜ 
        }

        // ----------------------------------------------------
        // ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£é–¢æ•°
        // ----------------------------------------------------
        function intensityToJma(num) {
            const map = {
                10: '1', 20: '2', 30: '3', 40: '4', 45: '5å¼±',
                50: '5å¼·', 55: '6å¼±', 60: '6å¼·', 70: '7'
            };
            return map[num] || 'ä¸æ˜';
        }
        
        /**
         * ğŸš¨ åœ°éœ‡æƒ…å ±ãƒ†ãƒ­ãƒƒãƒ—ã®å¥èª­ç‚¹ã‚’ã‚¹ãƒšãƒ¼ã‚¹ã«å¤‰æ›ã™ã‚‹
         * @param {string} text - å¤‰æ›å¯¾è±¡ã®ãƒ†ã‚­ã‚¹ãƒˆ
         * @returns {string} å¥èª­ç‚¹ã‚’ã‚¹ãƒšãƒ¼ã‚¹ã«ç½®æ›ã—ãŸãƒ†ã‚­ã‚¹ãƒˆ
         */
        function formatTickerText(text) {
            // å¥ç‚¹(ã€‚)ã‚’å…¨è§’ã‚¹ãƒšãƒ¼ã‚¹(ã€€)ã«ç½®æ›
            let formattedText = text.replace(/ã€‚/g, 'ã€€');
            // èª­ç‚¹(ã€)ã‚’åŠè§’ã‚¹ãƒšãƒ¼ã‚¹( )ã«ç½®æ›
            formattedText = formattedText.replace(/ã€/g, ' ');
            return formattedText;
        }

        /** è­¦å‘Šè¡¨ç¤ºã‚’éè¡¨ç¤ºã«ã™ã‚‹ */
        function hideAlert() {
            const alerts = document.querySelectorAll('.eew-alert');
            alerts.forEach(alert => {
                const serial = alert.getAttribute('data-eew-serial');
                if (serial && activeAlertTimers[serial]) {
                    clearTimeout(activeAlertTimers[serial]);
                    delete activeAlertTimers[serial];
                }
                alert.remove();
            });
            
            // ãƒ†ãƒ­ãƒƒãƒ—ã‚‚å¼·åˆ¶éè¡¨ç¤º
            if (quakeTickerArea.style.display !== 'none') {
                quakeTickerArea.style.display = 'none';
                tickerContent.style.animationName = 'none';
                console.log('åœ°éœ‡æƒ…å ±ãƒ†ãƒ­ãƒƒãƒ—ã‚‚å¼·åˆ¶éè¡¨ç¤ºã«ã—ã¾ã—ãŸã€‚');
            }
            
            // ğŸŒŠ æ´¥æ³¢è­¦å ±ã®çŠ¶æ…‹ã‚‚ãƒªã‚»ãƒƒãƒˆã™ã‚‹
            hideTsunamiTicker();

            console.log('è¡¨ç¤ºä¸­ã®å…¨ã¦ã®ã‚¢ãƒ©ãƒ¼ãƒˆã‚’éè¡¨ç¤ºã«ã—ã¾ã—ãŸã€‚');
        }
        
        /** ğŸš¨ EEWã®ã‚¢ãƒ©ãƒ¼ãƒˆãŒã‚¿ã‚¤ãƒãƒ¼ã§æ¶ˆãˆãŸå¾Œã«ãƒ†ãƒ­ãƒƒãƒ—è¡¨ç¤ºã‚’ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ã™ã‚‹ ğŸš¨ */
        function scheduleQuakeTickerAfterEEW() {
            // æ—¢ã«ãƒ†ãƒ­ãƒƒãƒ—ãŒè¡¨ç¤ºä¸­ã§ã€ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ãŒå‹•ã„ã¦ã„ã‚‹å ´åˆã¯ä½•ã‚‚ã—ãªã„ï¼ˆ552ãŒæ—¢ã«åˆ°ç€ã—ã¦ã„ã‚‹å¯èƒ½æ€§ï¼‰
            if (quakeTickerArea.style.display !== 'none' && tickerContent.style.animationPlayState === 'running') {
                console.log("EEWçµ‚äº†æ™‚: ãƒ†ãƒ­ãƒƒãƒ—ã¯æ—¢ã«è¡¨ç¤ºä¸­ï¼ˆP2P 552ãƒ‡ãƒ¼ã‚¿ã‚’å—ä¿¡æ¸ˆã¿ï¼‰ã®ãŸã‚ã€æ±ç”¨ãƒ†ãƒ­ãƒƒãƒ—ã¯ã‚¹ã‚­ãƒƒãƒ—ã—ã¾ã™ã€‚");
                return;
            }
            
            // æ±ç”¨ãƒ†ãƒ­ãƒƒãƒ—ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ç”Ÿæˆ
            const time = new Date().toLocaleTimeString('ja-JP', {hour: '2-digit', minute:'2-digit'});
            const genericMessage = `ğŸš¨ã€åœ°éœ‡ç™ºç”Ÿã€‘${time}é ƒã€å¼·ã„æºã‚Œã‚’è¦³æ¸¬ã—ã¾ã—ãŸã€‚åœ°éœ‡ã®è©³ç´°æƒ…å ±ã¯ç¶šå ±ã‚’ãŠå¾…ã¡ãã ã•ã„ã€‚ ğŸš¨`;

            // showQuakeTicker ã«æ±ç”¨ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’æ¸¡ã™ (P2Pãƒ‡ãƒ¼ã‚¿æ§‹é€ ã®ä»£ã‚ã‚Šã«rawMessageã‚’ä¿æŒã™ã‚‹ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã¨ã—ã¦æ¸¡ã™)
            showQuakeTicker({ rawMessage: genericMessage });
            console.log("EEWçµ‚äº†æ™‚: æ±ç”¨åœ°éœ‡æƒ…å ±ãƒ†ãƒ­ãƒƒãƒ—ã®è¡¨ç¤ºã‚’é–‹å§‹ã—ã¾ã—ãŸã€‚");
        }

        /**
         * ğŸŒŠ æ´¥æ³¢è­¦å ±ãƒ†ãƒ­ãƒƒãƒ—ã®è¡¨ç¤ºã¨ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³è¨­å®š ğŸŒŠ
         */
        function showTsunamiTicker() {
            if (!activeTsunamiInfo) return; // è¡¨ç¤ºã™ã¹ãæƒ…å ±ãŒãªã‘ã‚Œã°ä½•ã‚‚ã—ãªã„

            const formattedMessage = `ğŸŒŠ ${formatTickerText(activeTsunamiInfo)} ğŸŒŠ`;

            // ãƒ†ãƒ­ãƒƒãƒ—ã‚¨ãƒªã‚¢ã®ã‚¹ã‚¿ã‚¤ãƒ«ã‚’æ´¥æ³¢ç”¨ã«å¤‰æ›´
            quakeTickerArea.style.backgroundColor = 'rgba(15, 76, 129, 0.95)'; // æ¿ƒã„é’
            quakeTickerArea.style.borderColor = '#60a5fa'; // æ˜ã‚‹ã„é’

            tickerContent.textContent = formattedMessage + ' '.repeat(10);
            quakeTickerArea.style.display = 'flex';

            const viewportWidth = quakeTickerArea.offsetWidth;
            const contentWidth = tickerContent.scrollWidth;
            const totalDistance = viewportWidth + contentWidth;
            const baseSpeed = viewportWidth / CURRENT_SETTINGS.quakeDuration;
            const totalDuration = totalDistance / baseSpeed;

            tickerContent.style.animationName = 'none';
            void tickerContent.offsetWidth;

            tickerContent.style.setProperty('--scroll-distance', `-${totalDistance}px`);
            tickerContent.style.animationDuration = `${totalDuration}s`;
            tickerContent.style.animationIterationCount = 'infinite'; // â˜…ç¹°ã‚Šè¿”ã—è¡¨ç¤º
            tickerContent.style.animationName = 'ticker-scroll';
            tickerContent.style.animationPlayState = 'running';

            console.log(`æ´¥æ³¢è­¦å ±ãƒ†ãƒ­ãƒƒãƒ—ã‚’è¡¨ç¤ºã—ã¾ã™: ${activeTsunamiInfo}`);
        }

        /** æ´¥æ³¢è­¦å ±ãƒ†ãƒ­ãƒƒãƒ—ã‚’éè¡¨ç¤ºã«ã™ã‚‹ */
        function hideTsunamiTicker() {
            if (!activeTsunamiInfo) return; // æ—¢ã«éè¡¨ç¤ºãªã‚‰ä½•ã‚‚ã—ãªã„

            activeTsunamiInfo = null; // æ´¥æ³¢è­¦å ±çŠ¶æ…‹ã‚’è§£é™¤

            // ãƒ†ãƒ­ãƒƒãƒ—ãŒæ´¥æ³¢ç”¨ã®å ´åˆã®ã¿éè¡¨ç¤ºå‡¦ç†ã‚’è¡Œã†
            if (quakeTickerArea.style.backgroundColor.startsWith('rgba(15, 76, 129')) {
                quakeTickerArea.style.display = 'none';
                tickerContent.style.animationName = 'none';
                tickerContent.style.animationIterationCount = '1'; // ç¹°ã‚Šè¿”ã—ã‚’ãƒªã‚»ãƒƒãƒˆ

                // ãƒ†ãƒ­ãƒƒãƒ—ã‚¨ãƒªã‚¢ã®ã‚¹ã‚¿ã‚¤ãƒ«ã‚’ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆï¼ˆåœ°éœ‡æƒ…å ±ç”¨ï¼‰ã«æˆ»ã™
                quakeTickerArea.style.backgroundColor = 'rgba(179, 11, 11, 0.95)';
                quakeTickerArea.style.borderColor = 'rgb(255, 255, 255)';
                console.log('æ´¥æ³¢è­¦å ±ãƒ†ãƒ­ãƒƒãƒ—ã‚’éè¡¨ç¤ºã«ã—ã¾ã—ãŸã€‚');
            }
        }

        let activeAlertTimers = {}; // EEWã‚·ãƒªã‚¢ãƒ«ç•ªå·ã¨ã‚¿ã‚¤ãƒãƒ¼IDã‚’ä¿æŒ

        /** è­¦å‘Šã®ã‚¿ã‚¤ãƒãƒ¼ã‚’è¨­å®šã™ã‚‹ (EEW/æ´¥æ³¢) */
        function setupAlertTimer(element, code, serial) {
            // æ—¢å­˜ã‚¿ã‚¤ãƒãƒ¼ãŒã‚ã‚Œã°ã‚¯ãƒªã‚¢
            if (activeAlertTimers[serial]) {
                clearTimeout(activeAlertTimers[serial]);
                delete activeAlertTimers[serial];
            }

            const duration = CURRENT_SETTINGS.eewDuration; // EEW/æ´¥æ³¢è¡¨ç¤ºæ™‚é–“

            if (duration > 0) {
                const timer = setTimeout(() => {
                    // ã‚¢ãƒ©ãƒ¼ãƒˆãŒæ¶ˆãˆã‚‹ã‚¿ã‚¤ãƒŸãƒ³ã‚°ã§å¾Œç¶šå‡¦ç†ã‚’å®Ÿè¡Œ
                    if (code === 551) {
                        scheduleQuakeTickerAfterEEW();
                    } else if (code === 556) {
                        // æ´¥æ³¢ã‚¢ãƒ©ãƒ¼ãƒˆãŒæ¶ˆãˆãŸã‚‰ã€è©³ç´°ãƒ†ãƒ­ãƒƒãƒ—ã‚’é–‹å§‹
                        showTsunamiTicker();
                    }
                    
                    element.remove();
                    delete activeAlertTimers[serial];
                    console.log(`ã‚¢ãƒ©ãƒ¼ãƒˆ ${serial} ã‚’ã‚¿ã‚¤ãƒãƒ¼ã§éè¡¨ç¤ºã«ã—ã¾ã—ãŸã€‚`);
                }, duration * 1000);
                activeAlertTimers[serial] = timer;
            }
        }
        
        /** * åœ°éœ‡æƒ…å ±ãƒ†ãƒ­ãƒƒãƒ—ã®è¡¨ç¤ºã¨ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³è¨­å®š 
         * @param {Object} data - P2P Quakeã®552ãƒ‡ãƒ¼ã‚¿ã€ã¾ãŸã¯{ rawMessage: string }ã‚’æŒã¤ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ
         */
        function showQuakeTicker(data) {
            // æ´¥æ³¢è­¦å ±ãŒç™ºä»¤ä¸­ã®å ´åˆã¯ã€åœ°éœ‡æƒ…å ±ãƒ†ãƒ­ãƒƒãƒ—ã‚’è¡¨ç¤ºã—ãªã„
            if (activeTsunamiInfo) {
                console.log('æ´¥æ³¢è­¦å ±ãŒæœ‰åŠ¹ãªãŸã‚ã€åœ°éœ‡æƒ…å ±ãƒ†ãƒ­ãƒƒãƒ—ã®è¡¨ç¤ºã‚’ã‚¹ã‚­ãƒƒãƒ—ã—ã¾ã—ãŸã€‚');
                return;
            }
            
            let rawMessage;
            
            // æ±ç”¨ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒæ¸¡ã•ã‚ŒãŸå ´åˆï¼ˆEEWã‚¿ã‚¤ãƒãƒ¼çµ‚äº†æ™‚ï¼‰
            if (data.rawMessage) {
                rawMessage = data.rawMessage;
            } else {
                // P2P 552ãƒ‡ãƒ¼ã‚¿ãŒæ¸¡ã•ã‚ŒãŸå ´åˆï¼ˆé€šå¸¸ - processAlertDataã‹ã‚‰ï¼‰
                const time = new Date(data.earthquake.time || Date.now()).toLocaleTimeString('ja-JP', {hour: '2-digit', minute:'2-digit'});
                const maxIntText = intensityToJma(data.earthquake?.maxScale || 0);
                const epicenter = data.earthquake.hypocenter?.name || 'ä¸æ˜';
                const magnitude = data.earthquake?.magnitude || 'ä¸æ˜';
                const depth = data.earthquake.hypocenter?.depth ? `${data.earthquake.hypocenter.depth}km` : 'ä¸æ˜';

                rawMessage = `ğŸš¨ã€åœ°éœ‡æƒ…å ±ã€‘${time}é ƒç™ºç”Ÿ | éœ‡æºåœ°: ${epicenter} (éœ‡æºã®æ·±ã•: ${depth}) | åœ°éœ‡ã®è¦æ¨¡(M): ${magnitude} | æœ€å¤§éœ‡åº¦: ${maxIntText} ğŸš¨`;
            }
            
            const secondsPerScreen = CURRENT_SETTINGS.quakeDuration; // ç”»é¢å¹…ã‚’ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã™ã‚‹ã®ã«ã‹ã‹ã‚‹æ™‚é–“

            // å¥èª­ç‚¹ã‚’ã‚¹ãƒšãƒ¼ã‚¹ã«ç½®æ›
            const formattedMessage = formatTickerText(rawMessage);

            // ãƒ†ãƒ­ãƒƒãƒ—ã‚¨ãƒªã‚¢ã®æ›´æ–°
            tickerContent.textContent = formattedMessage + ' '.repeat(5); // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®æœ€å¾Œã«ã‚ãšã‹ãªã‚¹ãƒšãƒ¼ã‚¹ã‚’è¿½åŠ 
            
            // ç¢ºå®Ÿã«å¹…ã‚’å–å¾—ã™ã‚‹ãŸã‚ã€displayã‚’flexã«å¤‰æ›´ã—ã¦ã‹ã‚‰å¹…ã‚’å–å¾—
            quakeTickerArea.style.display = 'flex'; 
            
            // ç”»é¢å¹…ã¨ã‚³ãƒ³ãƒ†ãƒ³ãƒ„å¹…ã‚’å–å¾—
            const viewportWidth = quakeTickerArea.offsetWidth;
            // scrollWidthã¯ãƒ‘ãƒ‡ã‚£ãƒ³ã‚°ã‚’å«ã‚€è¦ç´ ã®å…¨ã‚³ãƒ³ãƒ†ãƒ³ãƒ„å¹…
            const contentWidth = tickerContent.scrollWidth; 
            
            // ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«é€Ÿåº¦ã®åŸºæº–
            const baseSpeed = viewportWidth / secondsPerScreen; 

            // ãƒ†ãƒ­ãƒƒãƒ—å…¨ä½“ï¼ˆç”»é¢å¹… + ã‚³ãƒ³ãƒ†ãƒ³ãƒ„å¹…ï¼‰ã‚’ç§»å‹•ã™ã‚‹ã®ã«ã‹ã‹ã‚‹æ™‚é–“ï¼ˆç§’ï¼‰
            const totalDistance = viewportWidth + contentWidth; 
            const totalDuration = totalDistance / baseSpeed;

            // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ãƒªã‚»ãƒƒãƒˆã—ã€é€Ÿåº¦ã‚’è¨­å®š
            tickerContent.style.animationName = 'none'; // ä¸€åº¦ãƒªã‚»ãƒƒãƒˆ
            // DOMã«å†æç”»ã‚’å¼·åˆ¶ã—ã€ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã‚’å†åº¦é©ç”¨
            void tickerContent.offsetWidth; 
            
            // CSSå¤‰æ•°ã«ç§»å‹•è·é›¢ã‚’è¨­å®š
            tickerContent.style.setProperty('--scroll-distance', `-${totalDistance}px`);
            
            // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã®ç¶™ç¶šæ™‚é–“ã¨å†ç”ŸçŠ¶æ…‹ã‚’è¨­å®š
            tickerContent.style.animationDuration = `${totalDuration}s`;
            tickerContent.style.animationName = 'ticker-scroll'; // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã‚’å†é©ç”¨
            tickerContent.style.animationPlayState = 'running';

            console.log(`åœ°éœ‡æƒ…å ±ãƒ†ãƒ­ãƒƒãƒ—ã‚’è¡¨ç¤ºã—ã¾ã™ã€‚ã‚³ãƒ³ãƒ†ãƒ³ãƒ„å¹…: ${contentWidth.toFixed(0)}px, ç”»é¢å¹…: ${viewportWidth.toFixed(0)}pxã€‚é€Ÿåº¦: ${baseSpeed.toFixed(0)}px/sã€ç·ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³æ™‚é–“: ${totalDuration.toFixed(1)}ç§’ã€‚`);

        }


        // ----------------------------------------------------
        // ğŸ”Š ã‚¢ãƒ©ãƒ¼ãƒ éŸ³æ©Ÿèƒ½ ğŸ”Š
        // ----------------------------------------------------
        let audioContext = null; 
        let audioBuffers = {}; // ğŸ”Š URLéŸ³æºã®ã‚­ãƒ£ãƒƒã‚·ãƒ¥ ğŸ”Š
        
        function initializeAudioContext() {
            if (audioContext && audioContext.state === 'running') return;
            if (audioContext && audioContext.state === 'suspended') {
                 audioContext.resume().catch(e => console.error("AudioContextã®å†é–‹ã‚¨ãƒ©ãƒ¼:", e));
                 return;
            }
            
            if (!audioContext) {
                try {
                    // Safariäº’æ›æ€§ã®ãŸã‚ã«webkitAudioContextã‚‚è€ƒæ…®
                    audioContext = new (window.AudioContext || window.webkitAudioContext)();
                    console.log('AudioContextã‚’åˆæœŸåŒ–ã—ã¾ã—ãŸã€‚');
                } catch (e) {
                    console.error('AudioContextã®åˆæœŸåŒ–ã«å¤±æ•—ã—ã¾ã—ãŸ:', e);
                }
            }
        }
        
        /**
         * ğŸ”Š URLã‹ã‚‰éŸ³æºã‚’ãƒ­ãƒ¼ãƒ‰ã—ã€ãƒ‡ã‚³ãƒ¼ãƒ‰ã—ã¦ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã™ã‚‹ ğŸ”Š
         * @param {string} urlKey - custom_url_a ã¾ãŸã¯ custom_url_b
         * @param {string} url - éŸ³æºã®URL
         * @param {HTMLElement} statusEl - ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è¡¨ç¤ºç”¨ã®DOMè¦ç´ 
         */
        async function loadAudioFromUrl(urlKey, url, statusEl) {
            if (!audioContext || !url) return;
            
            // URLãŒè¨­å®šã•ã‚Œã¦ã„ãªã„å ´åˆã¯ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’ã‚¯ãƒªã‚¢
            if (!url) {
                audioBuffers[urlKey] = null;
                if (statusEl) {
                    statusEl.textContent = 'æœªè¨­å®š';
                    statusEl.className = 'loading-status text-yellow-500';
                }
                return;
            }

            try {
                if (statusEl) {
                    statusEl.textContent = 'ãƒ­ãƒ¼ãƒ‰ä¸­...';
                    statusEl.className = 'loading-status text-yellow-500';
                }
                
                // Exponential Backoffã‚’ä½¿ç”¨ã—ãŸãƒªãƒˆãƒ©ã‚¤ãƒ­ã‚¸ãƒƒã‚¯
                const MAX_RETRIES = 3;
                let response = null;
                for (let i = 0; i < MAX_RETRIES; i++) {
                    try {
                        response = await fetch(url, { mode: 'cors' });
                        if (response.ok) break; // æˆåŠŸã—ãŸã‚‰ãƒ«ãƒ¼ãƒ—ã‚’æŠœã‘ã‚‹
                        // HTTPã‚¨ãƒ©ãƒ¼ã§ã‚‚404/403ã®å ´åˆã¯ãƒªãƒˆãƒ©ã‚¤ã—ã¦ã‚‚ç„¡é§„ãªã®ã§ã€ãƒªãƒˆãƒ©ã‚¤ã—ãªã„
                        if (response.status === 404 || response.status === 403) {
                             throw new Error(`HTTPã‚¨ãƒ©ãƒ¼: ${response.status}`);
                        }
                        // ãã®ä»–ã®ã‚¨ãƒ©ãƒ¼ (ä¾‹: 5xx, ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆãªã©) ã®å ´åˆã¯ãƒªãƒˆãƒ©ã‚¤
                        await new Promise(resolve => setTimeout(resolve, Math.pow(2, i) * 1000));
                        console.log(`ãƒªãƒˆãƒ©ã‚¤ ${i + 1}/${MAX_RETRIES}: URL ${urlKey} ã®ãƒ­ãƒ¼ãƒ‰ã‚’å†è©¦è¡Œã—ã¾ã™ã€‚`);
                    } catch (e) {
                        if (e.message.includes('404') || e.message.includes('403')) {
                            throw e; // 404/403ã¯å³åº§ã«ã‚¨ãƒ©ãƒ¼ã¨ã™ã‚‹
                        }
                        if (i === MAX_RETRIES - 1) throw e; // æœ€å¾Œã®è©¦è¡Œã§ã‚¨ãƒ©ãƒ¼ãªã‚‰ã‚¹ãƒ­ãƒ¼
                    }
                }
                
                if (!response || !response.ok) {
                    throw new Error(`HTTPã‚¨ãƒ©ãƒ¼: ${response ? response.status : 'ä¸æ˜ãªã‚¨ãƒ©ãƒ¼'}`);
                }
                
                const arrayBuffer = await response.arrayBuffer();
                const audioBuffer = await audioContext.decodeAudioData(arrayBuffer);

                audioBuffers[urlKey] = audioBuffer;
                
                if (statusEl) {
                    statusEl.textContent = `ãƒ­ãƒ¼ãƒ‰æˆåŠŸ (${(audioBuffer.duration).toFixed(1)}ç§’)`;
                    statusEl.className = 'loading-status text-green-500';
                }
                console.log(`éŸ³æº ${urlKey} ã‚’æ­£å¸¸ã«ãƒ­ãƒ¼ãƒ‰ã—ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã—ã¾ã—ãŸã€‚`);
            } catch (error) {
                audioBuffers[urlKey] = null;
                if (statusEl) {
                    statusEl.textContent = 'ãƒ­ãƒ¼ãƒ‰å¤±æ•— (CORS/URLã‚¨ãƒ©ãƒ¼)';
                    statusEl.className = 'loading-status text-red-500';
                }
                console.error(`éŸ³æº ${urlKey} ã®ãƒ­ãƒ¼ãƒ‰ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ:`, error);
                console.warn("CORSã‚¨ãƒ©ãƒ¼ã¾ãŸã¯ç„¡åŠ¹ãªURLã®å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚ã‚µãƒ¼ãƒãƒ¼å´ã§ 'Access-Control-Allow-Origin: *' ãŒè¨­å®šã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèªã—ã¦ãã ã•ã„ã€‚");
            }
        }

        /**
         * ãƒšãƒ¼ã‚¸ãƒ­ãƒ¼ãƒ‰æ™‚ã¾ãŸã¯è¨­å®šãƒ­ãƒ¼ãƒ‰æ™‚ã«å…¨ã¦ã®ã‚«ã‚¹ã‚¿ãƒ URLéŸ³æºã‚’ãƒ­ãƒ¼ãƒ‰ã™ã‚‹
         */
        function loadAllCustomUrls() {
            const urls = CURRENT_SETTINGS.customUrls;
            const statusMap = {
                'custom_url_a': customUrlAStatus,
                'custom_url_b': customUrlBStatus
            };

            for (const key in urls) {
                const url = urls[key];
                const statusEl = statusMap[key];
                // URLãŒè¨­å®šã•ã‚Œã¦ã„ã‚‹å ´åˆã®ã¿ãƒ­ãƒ¼ãƒ‰ã‚’è©¦ã¿ã‚‹
                if (url) {
                    loadAudioFromUrl(key, url, statusEl);
                } else {
                    // URLãŒç©ºã®å ´åˆã¯ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’ãƒªã‚»ãƒƒãƒˆ
                    if (statusEl) {
                        statusEl.textContent = 'æœªè¨­å®š';
                        statusEl.className = 'loading-status text-yellow-500';
                    }
                }
            }
        }

        
        /**
         * éœ‡åº¦ã«å¿œã˜ã¦é¸æŠã•ã‚ŒãŸã‚¢ãƒ©ãƒ¼ãƒ éŸ³ã‚’å†ç”Ÿã™ã‚‹
         * @param {number} maxInt - äºˆæƒ³æœ€å¤§éœ‡åº¦ (JMA Scale 10-70)
         */
        function playAlarmForIntensity(maxInt) {
            
            // éœ‡åº¦ã«å¿œã˜ã¦ã©ã®è¨­å®šã‚’ä½¿ã†ã‹æ±ºå®š
            let soundKey = 'int4_down'; 
            if (maxInt >= 55) { 
                soundKey = 'int6_up';
            } else if (maxInt >= 45) { 
                soundKey = 'int5_mid';
            } 
            
            const alarmType = CURRENT_SETTINGS.eewSoundMap[soundKey] || 'classic_eew';
            
            if (alarmType === 'silent') {
                console.log(`ã‚¢ãƒ©ãƒ¼ãƒ ã¯${soundKey}ã®è¨­å®šã«ã‚ˆã‚ŠãƒŸãƒ¥ãƒ¼ãƒˆã•ã‚Œã¦ã„ã¾ã™ã€‚`);
                return;
            }
            
            initializeAudioContext();
            
            if (!audioContext) {
                console.error("AudioContextãŒåˆ©ç”¨ã§ãã¾ã›ã‚“ã€‚");
                return;
            }

            // ----------------------------------------------------
            // ğŸ”Š URLéŸ³æºã®å†ç”Ÿãƒ­ã‚¸ãƒƒã‚¯ ğŸ”Š
            // ----------------------------------------------------
            if (alarmType.startsWith('custom_url_')) {
                const buffer = audioBuffers[alarmType];
                if (buffer) {
                    const source = audioContext.createBufferSource();
                    source.buffer = buffer;
                    source.connect(audioContext.destination);
                    source.start(0);
                    console.log(`URLéŸ³æº (${alarmType}) ã‚’å†ç”Ÿã—ã¾ã—ãŸã€‚`);
                } else {
                    console.error(`${alarmType}: éŸ³å£°ãƒãƒƒãƒ•ã‚¡ãŒãƒ­ãƒ¼ãƒ‰ã•ã‚Œã¦ã„ãªã„ã‹ã€ãƒ­ãƒ¼ãƒ‰ã«å¤±æ•—ã—ã¦ã„ã¾ã™ã€‚ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®EEWéŸ³ã‚’å†ç”Ÿã—ã¾ã™ã€‚`);
                    // ãƒ­ãƒ¼ãƒ‰å¤±æ•—æ™‚ã¯ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ã¨ã—ã¦EEWæ¨™æº–éŸ³ã‚’å†ç”Ÿ
                    playSynthesizedAlarm('classic_eew'); 
                }
                return; // URLéŸ³æºã®å†ç”ŸãŒè©¦è¡Œã•ã‚ŒãŸã‚‰ã“ã“ã§çµ‚äº†
            }
            
            // ----------------------------------------------------
            // ğŸµ ã‚·ãƒ³ã‚»ã‚µã‚¤ã‚¶ãƒ¼éŸ³ã®å†ç”Ÿãƒ­ã‚¸ãƒƒã‚¯ ğŸ¶
            // ----------------------------------------------------
            playSynthesizedAlarm(alarmType);
        }

        /**
         * ã‚·ãƒ³ã‚»ã‚µã‚¤ã‚¶ãƒ¼éŸ³ï¼ˆEEWæ¨™æº–ã€ã‚µã‚¤ãƒ¬ãƒ³ã€ã‚«ã‚¹ã‚¿ãƒ ãƒˆãƒ¼ãƒ³ï¼‰ã‚’å†ç”Ÿã™ã‚‹
         * @param {string} alarmType - å†ç”Ÿã™ã‚‹ã‚¢ãƒ©ãƒ¼ãƒ ã®ç¨®é¡
         */
        function playSynthesizedAlarm(alarmType) {
            
            if (!audioContext) { return; }
            
            let sequence = [];
            let repeat = 0;
            const masterGainVolume = 0.7;

            if (alarmType === 'classic_eew') {
                // EEWæ¨™æº–éŸ³ (660Hz/990Hz) - ãƒ”ãƒ§ãƒ­ãƒ”ãƒ§ãƒ­
                sequence = [
                    { freq: 660, duration: 0.15 }, 
                    { freq: 990, duration: 0.15 }, 
                    { freq: 0, duration: 0.05 },
                ];
                repeat = 4;
            } else if (alarmType === 'urgent_siren') {
                // ç·Šè¿«ã‚µã‚¤ãƒ¬ãƒ³éŸ³ (1000Hz/800Hz)
                sequence = [
                    { freq: 1000, duration: 0.1 }, 
                    { freq: 800, duration: 0.1 }, 
                    { freq: 0, duration: 0.05 },
                ];
                repeat = 8;
            } else if (alarmType === 'simple_beep') {
                // ãƒ”ãƒ¼ãƒ³éŸ³ (660Hz)
                sequence = [
                    { freq: 660, duration: 0.1 }, 
                    { freq: 0, duration: 0.2 },
                ];
                repeat = 3; 
            } else if (alarmType === 'custom_tone_a' || alarmType === 'custom_tone_b') {
                // ğŸµ ã‚«ã‚¹ã‚¿ãƒ ãƒˆãƒ¼ãƒ³ã®ãƒ­ã‚¸ãƒƒã‚¯ ğŸ¶
                const customA = CURRENT_SETTINGS.customTones.custom_a;
                const customB = CURRENT_SETTINGS.customTones.custom_b;
                
                // ã‚«ã‚¹ã‚¿ãƒ éŸ³ã®ã‚·ãƒ¼ã‚±ãƒ³ã‚¹å®šç¾©: [ãƒ™ãƒ¼ã‚¹å‘¨æ³¢æ•°, ãƒ™ãƒ¼ã‚¹ + å¤‰èª¿, ä¼‘æ†©] ã‚’ç¹°ã‚Šè¿”ã™
                const tempoSeconds = customB.tempoMs / 1000;

                sequence = [
                    { freq: customA.baseFreq, duration: tempoSeconds }, 
                    { freq: customA.baseFreq + customA.modFreq, duration: tempoSeconds }, 
                    { freq: 0, duration: 0.05 },
                ];
                repeat = customB.repeats;
                console.log(`ã‚«ã‚¹ã‚¿ãƒ ãƒˆãƒ¼ãƒ³ (${alarmType}) ã‚’å†ç”Ÿ: Base=${customA.baseFreq}Hz, Mod=${customA.modFreq}Hz, Tempo=${customB.tempoMs}ms, Repeat=${customB.repeats}`);
            } else {
                return; // æœªå®šç¾©ã®ã‚¢ãƒ©ãƒ¼ãƒ ã‚¿ã‚¤ãƒ—
            }
            
            const totalDuration = sequence.reduce((sum, s) => sum + s.duration, 0) * repeat;

            const masterGain = audioContext.createGain();
            masterGain.gain.setValueAtTime(masterGainVolume, audioContext.currentTime); 
            masterGain.connect(audioContext.destination);

            let startTime = audioContext.currentTime;

            for (let r = 0; r < repeat; r++) {
                sequence.forEach(tone => {
                    if (tone.freq > 0) {
                        const oscillator = audioContext.createOscillator();
                        const gainNode = audioContext.createGain();
                        
                        oscillator.type = 'sine';
                        oscillator.frequency.setValueAtTime(tone.freq, startTime);
                        
                        // ãƒ•ã‚§ãƒ¼ãƒ‰ã‚¤ãƒ³/ã‚¢ã‚¦ãƒˆå‡¦ç†
                        gainNode.gain.setValueAtTime(0.0001, startTime);
                        gainNode.gain.linearRampToValueAtTime(1.0, startTime + 0.01);
                        gainNode.gain.linearRampToValueAtTime(0.0001, startTime + tone.duration - 0.01);

                        oscillator.connect(gainNode);
                        gainNode.connect(masterGain);

                        oscillator.start(startTime);
                        oscillator.stop(startTime + tone.duration);
                    }
                    
                    startTime += tone.duration;
                });
            }

            console.log(`ã‚·ãƒ³ã‚»ã‚µã‚¤ã‚¶ãƒ¼ã‚¢ãƒ©ãƒ¼ãƒ éŸ³ã‚’å†ç”Ÿã—ã¾ã—ãŸ (${alarmType}ã€åˆè¨ˆ ${totalDuration.toFixed(2)} ç§’)ã€‚`);
        }

        // ----------------------------------------------------
        // ğŸš¨ ãƒ¡ã‚¤ãƒ³ãƒ­ã‚¸ãƒƒã‚¯ (EEWå‡¦ç†ã€ç¶šå ±ã€ã‚¿ã‚¤ãƒãƒ¼) ğŸš¨
        // ----------------------------------------------------
        const WS_URL = 'wss://api.p2pquake.net/v2/ws';
        const P2P_TYPES = [551, 552, 556]; // EEW, åœ°éœ‡æƒ…å ±, æ´¥æ³¢äºˆå ±

        let ws;
        let reconnectInterval = 5000; 
        
        /** EEWã‚¢ãƒ©ãƒ¼ãƒˆè¦ç´ ã®ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’æ›´æ–°ã™ã‚‹ (551 ç¶šå ±ç”¨) */
        function updateAlertElementContent(element, data) {
            const code = data.code;
            const maxInt = data.earthquake?.maxScale || 0;
            const time = new Date(data.time || Date.now()).toLocaleTimeString('ja-JP');
            const maxIntText = intensityToJma(maxInt);
            const serial = data.issue?.serial;
            
            // ... (HTMLæ›´æ–°ãƒ­ã‚¸ãƒƒã‚¯)
            element.className = 'eew-alert'; 
            if (maxInt >= 55) { element.className += ' intensity-6-up'; } 
            else if (maxInt >= 45) { element.className += ' intensity-5-up'; } 
            else if (maxInt >= 30) { element.className += ' intensity-3-up'; }

            element.querySelector('.text-xl.mt-1').textContent = `ã€${data.issue.type === 'Alert' ? 'è­¦å ±' : 'äºˆå ±'}ã€‘${data.issue.type === 'Alert' ? 'å¼·ã„æºã‚Œã«è­¦æˆ’' : 'æºã‚Œã«æ³¨æ„'}ï¼ˆç¶šå ±ï¼‰`;
            element.querySelector('.text-lg.mt-1').textContent = `éœ‡æºåœ°: ${data.earthquake.hypocenter?.name || 'ä¸æ˜'} | äºˆæƒ³æœ€å¤§éœ‡åº¦: ${maxIntText} (${data.earthquake?.magnitude || 'ä¸æ˜'}M)`;
            element.querySelector('.intensity-label').textContent = maxIntText;
            
            // ç¶šå ±ã§ã‚‚ã‚¢ãƒ©ãƒ¼ãƒ ã‚’é³´ã‚‰ã™
            if (code === 551) {
                playAlarmForIntensity(maxInt);
            }
            
            setupAlertTimer(element, code, serial);
        }

        /** EEW/æ´¥æ³¢ã®ã‚¢ãƒ©ãƒ¼ãƒˆè¦ç´ ã‚’æ–°è¦ä½œæˆã™ã‚‹ (551/556 æ–°è¦ç”¨) */
        function createAlertElement(data) {
            const code = data.code;
            const maxInt = data.earthquake?.maxScale || 0;
            const serial = data.issue?.serial || `alert-${Date.now()}`;

            // ğŸš¨ ä¿®æ­£: æœ€å°éœ‡åº¦è¨­å®šã«ã‚ˆã‚‹è¡¨ç¤ºåˆ¶å¾¡
            if (code === 551 && maxInt < CURRENT_SETTINGS.minIntensityScale) {
                // ä¿®æ­£: ãªãœè¡¨ç¤ºã•ã‚Œãªã„ã®ã‹ã‚’ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã«æ˜ç¢ºã«å‡ºåŠ›ã™ã‚‹
                const minIntensityLabel = intensityToJma(CURRENT_SETTINGS.minIntensityScale);
                console.log(`EEWå—ä¿¡: æœ€å¤§éœ‡åº¦ ${intensityToJma(maxInt)}ã€‚è¨­å®šã•ã‚ŒãŸæœ€ä½éœ‡åº¦ã€Œ${minIntensityLabel}ã€æœªæº€ã®ãŸã‚ã€ã‚¢ãƒ©ãƒ¼ãƒˆè¡¨ç¤ºã‚’ã‚¹ã‚­ãƒƒãƒ—ã—ã¾ã—ãŸã€‚`);
                return; // ã“ã“ã§å‡¦ç†ã‚’çµ‚äº†
            }

            const time = new Date(data.time || Date.now()).toLocaleTimeString('ja-JP');
            let maxIntText = intensityToJma(maxInt);
            let titleText = '';
            let detailText = '';
            let baseClass = 'eew-alert';
            let alertTypeTitle = '';
            let intensityUnitText = 'æœ€å¤§éœ‡åº¦';
            let intensityDisplayHtml = ''; // éœ‡åº¦ã¾ãŸã¯ã‚¢ã‚¤ã‚³ãƒ³ã‚’è¡¨ç¤ºã™ã‚‹éƒ¨åˆ†

            if (code === 551) { // ç·Šæ€¥åœ°éœ‡é€Ÿå ± (EEW)
                titleText = `ã€${data.issue.type === 'Alert' ? 'è­¦å ±' : 'äºˆå ±'}ã€‘${data.issue.type === 'Alert' ? 'å¼·ã„æºã‚Œã«è­¦æˆ’' : 'æºã‚Œã«æ³¨æ„'}ï¼ˆæ–°è¦ï¼‰`;
                detailText = `éœ‡æºåœ°: ${data.earthquake.hypocenter?.name || 'ä¸æ˜'} | äºˆæƒ³æœ€å¤§éœ‡åº¦: ${maxIntText} (${data.earthquake?.magnitude || 'ä¸æ˜'}M)`;
                alertTypeTitle = 'ç·Šæ€¥åœ°éœ‡é€Ÿå ±';
                intensityDisplayHtml = `<p class="intensity-unit">æœ€å¤§éœ‡åº¦</p><p class="intensity-label">${maxIntText}</p>`;
                
                if (maxInt >= 55) { baseClass += ' intensity-6-up'; } 
                else if (maxInt >= 45) { baseClass += ' intensity-5-up'; } 
                else if (maxInt >= 30) { baseClass += ' intensity-3-up'; }
                
                // æ–°è¦EEWç™ºç”Ÿæ™‚ã«ã‚¢ãƒ©ãƒ¼ãƒ éŸ³ã‚’é³´ã‚‰ã™
                playAlarmForIntensity(maxInt);

            } else if (code === 556) { // æ´¥æ³¢æƒ…å ± (éŸ³ã¯é³´ã‚‰ã•ãªã„)
                detailText = data.issue.text || 'è©³ç´°ã‚’ç¢ºèªã—ã¦ãã ã•ã„';
                let warningComment = ''; // æ³¨æ„å–šèµ·ã‚³ãƒ¡ãƒ³ãƒˆç”¨ã®å¤‰æ•°ã‚’è¿½åŠ 
                let textColorClass = 'text-white'; // æ–‡å­—è‰²ã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã¯ç™½

                // è­¦å ±ãƒ¬ãƒ™ãƒ«ã«å¿œã˜ã¦ã‚¿ã‚¤ãƒˆãƒ«ã¨æ³¨æ„å–šèµ·ã‚³ãƒ¡ãƒ³ãƒˆã‚’å‹•çš„ã«å¤‰æ›´
                if (detailText.includes('å¤§æ´¥æ³¢è­¦å ±')) {
                    alertTypeTitle = 'å¤§æ´¥æ³¢è­¦å ±ã‚’ç™ºè¡¨';
                    warningComment = 'ãŸã ã¡ã«é«˜å°ã¸é¿é›£ã—ã¦ãã ã•ã„';
                    baseClass += ' bg-purple-800 border-purple-300'; // èƒŒæ™¯è‰²: èµ¤ç´«
                } else if (detailText.includes('æ´¥æ³¢è­¦å ±')) {
                    alertTypeTitle = 'æ´¥æ³¢è­¦å ±ã‚’ç™ºè¡¨';
                    warningComment = 'æµ·å²¸ã‹ã‚‰é›¢ã‚Œã¦ãã ã•ã„';
                    baseClass += ' bg-red-700 border-red-300'; // èƒŒæ™¯è‰²: èµ¤
                } else if (detailText.includes('æ´¥æ³¢æ³¨æ„å ±')) {
                    alertTypeTitle = 'æ´¥æ³¢æ³¨æ„å ±ã‚’ç™ºè¡¨';
                    warningComment = 'æµ·å²¸ã«è¿‘ã¥ã‹ãªã„ã§ãã ã•ã„';
                    baseClass += ' bg-yellow-500 border-yellow-200'; // èƒŒæ™¯è‰²: é»„è‰²
                    textColorClass = 'text-black'; // æ–‡å­—è‰²: é»’
                } else {
                    alertTypeTitle = 'æ´¥æ³¢æƒ…å ±'; // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
                    warningComment = 'ãƒ†ãƒ¬ãƒ“ãƒ»ãƒ©ã‚¸ã‚ªã§æƒ…å ±ã‚’ç¢ºèªã—ã¦ãã ã•ã„';
                    baseClass += ' bg-blue-600 border-blue-300'; // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®èƒŒæ™¯è‰²: é’
                }
                titleText = warningComment; // å°ã•ã„æ–¹ã®ã‚¿ã‚¤ãƒˆãƒ«ã‚’æ³¨æ„å–šèµ·ã‚³ãƒ¡ãƒ³ãƒˆã«ç½®ãæ›ãˆ
                baseClass += ` animation-none ${textColorClass}`; // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ãªã—ã¨æ–‡å­—è‰²ã‚¯ãƒ©ã‚¹ã‚’è¿½åŠ 
                // æŒ‡å®šã•ã‚ŒãŸç”»åƒURLã‚’ã‚¢ã‚¤ã‚³ãƒ³ã¨ã—ã¦è¡¨ç¤º
                intensityDisplayHtml = `<div class="w-24 h-24"><img src="https://github.com/AfterEffects-OK/EarthquakeEarlyWarning/blob/main/TsunamiHazardSign.svg.png?raw=true" alt="æ´¥æ³¢ã‚¢ã‚¤ã‚³ãƒ³" class="w-full h-full object-contain"></div>`;
            } else {
                return;
            }
            
            const newAlert = document.createElement('div');
            if (code === 551) {
                newAlert.setAttribute('data-eew-serial', serial);
            } else if (code === 556) {
                newAlert.setAttribute('data-alert-type', 'tsunami'); // æ´¥æ³¢ã‚¢ãƒ©ãƒ¼ãƒˆç”¨ã®å±æ€§ã‚’è¿½åŠ 
            }
            newAlert.id = `alert-${serial}`;
            newAlert.className = `${baseClass}`; 
            newAlert.innerHTML = `
                <div class="flex items-center justify-between">
                    <div class="flex flex-col">
                        <p class="text-3xl font-bold">${alertTypeTitle}</p>
                        <p class="text-xl mt-1">${titleText}</p>
                        <p class="text-lg mt-1">${detailText}</p>
                    </div>
                    <div class="flex flex-col items-center ml-4">
                        ${intensityDisplayHtml}
                    </div>
                </div>
            `;

            eewContainer.prepend(newAlert);
            setupAlertTimer(newAlert, code, serial);
        }

        /** P2P Quakeã‹ã‚‰å—ä¿¡ã—ãŸãƒ‡ãƒ¼ã‚¿ã®ã‚¨ãƒ³ãƒˆãƒªãƒ¼ãƒã‚¤ãƒ³ãƒˆ */
        function processAlertData(data) {
            const code = data.code;
            const serial = data.issue?.serial;
            
            // å±¥æ­´ç”¨ã®æƒ…å ±ã‚’å…ˆã«æº–å‚™
            const historyItem = {
                time: data.time || new Date().toISOString(),
                epicenter: data.earthquake?.hypocenter?.name || 'ä¸æ˜',
                maxInt: data.earthquake?.maxScale || 0,
                maxIntText: intensityToJma(data.earthquake?.maxScale || 0),
                displayed: false, // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã¯éè¡¨ç¤º
                type: 'Unknown'
            };

            if (code === 551 && serial) { // EEW (ç·Šæ€¥åœ°éœ‡é€Ÿå ±)
                historyItem.type = 'EEW';
                const existingElement = document.querySelector(`[data-eew-serial="${serial}"]`);
                if (existingElement) {
                    // ç¶šå ±ã¨ã—ã¦æ—¢å­˜ã®ã‚¢ãƒ©ãƒ¼ãƒˆã‚’æ›´æ–°
                    historyItem.displayed = true; // ç¶šå ±ã¯å¿…ãšè¡¨ç¤ºã•ã‚Œã‚‹
                    updateAlertElementContent(existingElement, data);
                } else {
                    // æ–°è¦ã‚¢ãƒ©ãƒ¼ãƒˆã¨ã—ã¦ä½œæˆ
                    createAlertElement(data);
                }
                
            } else if (code === 552) { // åœ°éœ‡æƒ…å ± (ãƒ†ãƒ­ãƒƒãƒ—è¡¨ç¤º)
                // EEWã®ä»£ã‚ã‚Šã«ãƒ†ãƒ­ãƒƒãƒ—ã¨ã—ã¦è¡¨ç¤ºã™ã‚‹
                showQuakeTicker(data);
                historyItem.type = 'QuakeInfo';
                historyItem.displayed = true;
                
            } else if (code === 556) { // æ´¥æ³¢äºˆå ±
                historyItem.type = 'TsunamiInfo';
                const text = data.issue?.text || '';
                const isWarning = text.includes('æ´¥æ³¢è­¦å ±') || text.includes('å¤§æ´¥æ³¢è­¦å ±') || text.includes('æ´¥æ³¢æ³¨æ„å ±');
                const isCancelled = text.includes('è§£é™¤');

                // è©³ç´°ãƒ†ãƒ­ãƒƒãƒ—ç”¨ã®æƒ…å ±ã‚’ä½œæˆ
                let detailTickerText = '';
                if (data.areas && data.areas.length > 0) {
                    detailTickerText = data.areas.map(area => {
                        let heightText = '';
                        if (area.maxHeight) {
                            if (area.maxHeight.value) {
                                heightText = `äºˆæƒ³é«˜ã• ${area.maxHeight.value}m`;
                            } else if (area.maxHeight.condition) {
                                heightText = `äºˆæƒ³ ${area.maxHeight.condition}`;
                            }
                        }
                        let timeText = '';
                        if (area.firstHeight) {
                            if (area.firstHeight.time) {
                                const arrivalTime = new Date(area.firstHeight.time);
                                timeText = `åˆ°é” ${arrivalTime.getHours()}æ™‚${arrivalTime.getMinutes()}åˆ†`;
                            } else if (area.firstHeight.condition) {
                                timeText = area.firstHeight.condition;
                            }
                        }
                        return `${area.name} ${timeText} ${heightText}`;
                    }).join(' | ');
                }

                if (isCancelled) {
                    // è§£é™¤å ±ã‚’å—ä¿¡ã—ãŸã‚‰ã€è¡¨ç¤ºä¸­ã®ã™ã¹ã¦ã®æ´¥æ³¢ã‚¢ãƒ©ãƒ¼ãƒˆã‚’å‰Šé™¤
                    document.querySelectorAll('[data-alert-type="tsunami"]').forEach(el => el.remove());
                    hideTsunamiTicker();
                    console.log('æ´¥æ³¢è­¦å ±ã®è§£é™¤å ±ã‚’å—ä¿¡ã—ãŸãŸã‚ã€é–¢é€£ã‚¢ãƒ©ãƒ¼ãƒˆã‚’éè¡¨ç¤ºã«ã—ã¾ã—ãŸã€‚');
                    historyItem.displayed = true; // è§£é™¤ã‚‚é‡è¦ãªæƒ…å ±ãªã®ã§è¡¨ç¤ºæ‰±ã„
                } else if (isWarning) {
                    // è­¦å ±ãƒ»æ³¨æ„å ±ã‚’å—ä¿¡ã—ãŸã‚‰ã€ä¸Šéƒ¨ã‚¢ãƒ©ãƒ¼ãƒˆã¨ã—ã¦è¡¨ç¤º
                    activeTsunamiInfo = detailTickerText || text; // è©³ç´°æƒ…å ±ãŒã‚ã‚Œã°ãã‚Œã‚’ã€ãªã‘ã‚Œã°å…ƒã®ãƒ†ã‚­ã‚¹ãƒˆã‚’ãƒ†ãƒ­ãƒƒãƒ—ç”¨ã«ä¿æŒ
                    createAlertElement(data);
                    historyItem.displayed = true;
                } else {
                    console.log(`æ´¥æ³¢æƒ…å ±ã‚’å—ä¿¡ã—ã¾ã—ãŸãŒã€è­¦å ±ãƒ»æ³¨æ„å ±ãƒ»è§£é™¤å ±ã§ã¯ãªã„ãŸã‚è¡¨ç¤ºã‚’ã‚¹ã‚­ãƒƒãƒ—ã—ã¾ã—ãŸ: ${text}`);
                }
            }

            // è¡¨ç¤ºåˆ¤å®šãƒ­ã‚¸ãƒƒã‚¯ (createAlertElementå†…ã§è¡Œã‚ã‚Œã‚‹ãŸã‚ã€ã“ã“ã§å†åˆ¤å®š)
            if (code === 551) {
                if (historyItem.maxInt >= CURRENT_SETTINGS.minIntensityScale) {
                    historyItem.displayed = true;
                }
            }

            // å±¥æ­´ã‚’è¿½åŠ 
            addHistoryItem(historyItem);

            // å±¥æ­´ã‚’æ°¸ç¶šåŒ–
            saveHistoryToLocalStorage();
        }

        // ----------------------------------------------------
        // ğŸŒ WebSocketæ¥ç¶š ğŸŒ
        // ----------------------------------------------------
        function connectWebSocket() {
            if (ws) { ws.close(); }

            loadStatusEl.textContent = 'æ¥ç¶šä¸­...';

            ws = new WebSocket(WS_URL);

            ws.onopen = () => {
                loadStatusEl.textContent = 'æ¥ç¶šå®Œäº†';
                loadStatusEl.classList.remove('bg-yellow-700');
                loadStatusEl.classList.add('bg-teal-700');

                ws.send(JSON.stringify({ "types": P2P_TYPES }));
                setTimeout(() => { loadStatusEl.classList.add('hidden'); }, 5000);
                reconnectInterval = 5000; 
            };

            ws.onmessage = (event) => {
                try {
                    const data = JSON.parse(event.data);
                    if (P2P_TYPES.includes(data.code)) {
                        console.log('åœ°éœ‡æƒ…å ±ã‚’å—ä¿¡:', data);
                        processAlertData(data); 
                    }
                } catch (e) {
                    console.error('JSONè§£æã‚¨ãƒ©ãƒ¼:', e);
                }
            };

            ws.onclose = (event) => {
                loadStatusEl.textContent = 'åˆ‡æ–­ã€‚å†æ¥ç¶šä¸­...';
                loadStatusEl.classList.remove('hidden');
                loadStatusEl.classList.remove('bg-teal-700');
                loadStatusEl.classList.add('bg-yellow-700');

                setTimeout(connectWebSocket, reconnectInterval);
            };

            ws.onerror = (error) => {
                console.error('WebSocketã‚¨ãƒ©ãƒ¼:', error);
                loadStatusEl.textContent = 'æ¥ç¶šã‚¨ãƒ©ãƒ¼';
                loadStatusEl.classList.remove('hidden');
                loadStatusEl.classList.remove('bg-teal-700');
                loadStatusEl.classList.add('bg-red-700');

                ws.close(); 
            };
        }

        // ----------------------------------------------------
        // ğŸŒŸ ãƒ†ã‚¹ãƒˆæ©Ÿèƒ½ã®å®Ÿè£… ğŸŒŸ
        // ----------------------------------------------------
        const TEST_EEW_SERIAL_A = "TEST-EEW-SERIAL-001";
        
        const TEST_DATA = {
            'eew_5weak_a': {
                "code": 551, "issue": {"source": "è©¦é¨“ç”¨A", "time": new Date().toISOString(), "type": "Alert", "serial": TEST_EEW_SERIAL_A},
                "earthquake": {
                    "time": new Date().toISOString(), "hypocenter": {"name": "åœ°éœ‡A (éœ‡åº¦5å¼±)", "depth": 10},
                    "maxScale": 45, "magnitude": 6.2
                }, "isTest": true
            },
            'eew_6strong_a': {
                "code": 551, "issue": {"source": "è©¦é¨“ç”¨A", "time": new Date().toISOString(), "type": "Alert", "serial": TEST_EEW_SERIAL_A},
                "earthquake": {
                    "time": new Date().toISOString(), "hypocenter": {"name": "åœ°éœ‡A (éœ‡åº¦6å¼·) [æ›´æ–°]", "depth": 10},
                    "maxScale": 60, "magnitude": 7.5
                }, "isTest": true
            },
            'quake_3': {
                "code": 552, "issue": {"source": "è©¦é¨“ç”¨", "time": new Date().toISOString(), "type": "Detail", "serial": `TEST-QUAKE-SERIAL-${Date.now()}`},
                "earthquake": {
                    // ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ã«ã¯ã€å¥èª­ç‚¹ãŒå«ã¾ã‚Œã‚‹ã‚ˆã†ã«ã—ã¦ã„ã¾ã™ã€‚
                    "time": new Date().toISOString(), "hypocenter": {"name": "åƒè‘‰çœŒæ±æ–¹æ²–ã§å¤§ããªåœ°éœ‡ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚ãƒã‚°ãƒ‹ãƒãƒ¥ãƒ¼ãƒ‰ã¯6.5ã¨æ¨å®šã•ã‚Œã¦ã„ã¾ã™ã€‚æ´¥æ³¢ã®å¿ƒé…ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚", "depth": 30},
                    "maxScale": 30, "magnitude": 5.0
                }, "isTest": true
            },
            'tsunami_advisory': {
                "code": 556, "issue": {
                    "source": "è©¦é¨“ç”¨", "time": new Date().toISOString(), "type": "Tsunami", "serial": `TEST-TSUNAMI-${Date.now()}`
                },
                "areas": [
                    {"grade": "Watch", "immediate": false, "name": "å²©æ‰‹çœŒ"},
                    {"grade": "Watch", "immediate": false, "name": "å®®åŸçœŒ"}
                ],
                "issue": { "text": "å²©æ‰‹çœŒã€å®®åŸçœŒã«æ´¥æ³¢æ³¨æ„å ±ã‚’ç™ºè¡¨ã—ã¾ã—ãŸã€‚"},
                "isTest": true
            },
            'tsunami_major_warning': {
                "code": 556, "issue": {
                    "source": "è©¦é¨“ç”¨", "time": new Date().toISOString(), "type": "Tsunami", "serial": `TEST-TSUNAMI-${Date.now()}`
                , "text": "æ²–ç¸„çœŒã«å¤§æ´¥æ³¢è­¦å ±ãŒç™ºè¡¨ã•ã‚Œã¾ã—ãŸã€‚ãŸã ã¡ã«é«˜å°ã«é¿é›£ã—ã¦ãã ã•ã„ã€‚"},
                "isTest": true
            }
        };

        testEew5WeakA.addEventListener('click', () => { processAlertData(TEST_DATA['eew_5weak_a']); });
        testEew6StrongA.addEventListener('click', () => { processAlertData(TEST_DATA['eew_6strong_a']); });
        testQuake3Button.addEventListener('click', () => { processAlertData(TEST_DATA['quake_3']); });
        testTsunamiAdvisory.addEventListener('click', () => { processAlertData(TEST_DATA['tsunami_advisory']); });
        testTsunamiMajorWarning.addEventListener('click', () => { processAlertData(TEST_DATA['tsunami_major_warning']); });
        
        testSoundButton.addEventListener('click', () => {
            // ç¾åœ¨ã®éœ‡åº¦6å¼·ã«è¨­å®šã•ã‚Œã¦ã„ã‚‹ã‚¢ãƒ©ãƒ¼ãƒ è¨­å®šã‚’ä½¿ã£ã¦ãƒ†ã‚¹ãƒˆ
            const maxInt = 60; 
            playAlarmForIntensity(maxInt);
            console.log(`ãƒ†ã‚¹ãƒˆ: éœ‡åº¦6å¼·ã«è¨­å®šã•ã‚Œã¦ã„ã‚‹ã‚¢ãƒ©ãƒ¼ãƒ  (${CURRENT_SETTINGS.eewSoundMap.int6_up}) ã‚’å†ç”Ÿã—ã¾ã™ã€‚`);
        });

        clearAlertButton.addEventListener('click', () => { hideAlert(); });

        // ----------------------------------------------------
        // ğŸš€ èµ·å‹• ğŸš€
        // ----------------------------------------------------
        window.onload = () => {
            setupApp(); // UIã¨AudioContextã®åˆæœŸåŒ–
            loadSettingsFromLocalStorage(); // LocalStorageã‹ã‚‰è¨­å®šã‚’ãƒ­ãƒ¼ãƒ‰
            loadHistoryFromLocalStorage(); // LocalStorageã‹ã‚‰å±¥æ­´ã‚’ãƒ­ãƒ¼ãƒ‰
            connectWebSocket(); // WebSocketæ¥ç¶šã‚’é–‹å§‹
            
            loadStatusEl.classList.remove('hidden');
        };
    </script>
</body>
</html>